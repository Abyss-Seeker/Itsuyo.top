<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberpongk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, 'Microsoft YaHei', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0c1027, #1a1f4b, #0c1027);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
            color: #e1e6ff;
            padding: 20px;
        }

        /* æ–°å¢å¼€å§‹é¡µé¢æ ·å¼ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(8, 15, 32, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .start-screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        .start-container {
            width: 100%;
            max-width: 700px;
            padding: 30px;
            background: rgba(12, 22, 45, 0.85);
            border: 1px solid rgba(101, 80, 255, 0.3);
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(101, 80, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .start-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg,
                transparent 0%,
                rgba(101, 80, 255, 0.1) 50%,
                transparent 100%);
            animation: scanLine 8s linear infinite;
            z-index: -1;
        }

        .start-title {
            text-align: center;
            font-size: 3.5rem;
            color: #e1e6ff;
            text-shadow: 0 0 20px rgba(101, 80, 255, 0.8);
            margin-bottom: 20px;
            letter-spacing: 3px;
            font-weight: 800;
            position: relative;
        }

        .start-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #6550ff, transparent);
        }

        .start-subtitle {
            text-align: center;
            color: #a0a8ff;
            font-size: 1.2rem;
            margin-bottom: 40px;
            max-width: 600px;
            line-height: 1.6;
        }

        .start-options {
            margin-bottom: 40px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-title {
            font-size: 1.4rem;
            color: #e1e6ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .option-title::before {
            content: 'â–¶';
            color: #ffcc00;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .difficulty-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .start-difficulty-option {
            background: rgba(16, 24, 48, 0.7);
            border: 1px solid rgba(101, 80, 255, 0.3);
            color: #e1e6ff;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .start-difficulty-option:hover {
            background: rgba(101, 80, 255, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(101, 80, 255, 0.3);
        }

        .start-difficulty-option.active {
            background: rgba(101, 80, 255, 0.6);
            border-color: #6550ff;
            box-shadow: 0 0 15px rgba(101, 80, 255, 0.5);
        }

        .ai-toggle-container {
            display: flex;
            align-items: center;
            background: rgba(16, 24, 48, 0.7);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .ai-toggle-container:hover {
            background: rgba(255, 165, 0, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.2);
        }

        .ai-toggle-label {
            flex-grow: 1;
            font-size: 1.1rem;
            color: #e1e6ff;
        }

        .ai-toggle {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .ai-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ai-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 68, 68, 0.5);
            transition: .4s;
            border-radius: 30px;
        }

        .ai-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: #e1e6ff;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .ai-toggle-slider {
            background-color: rgba(0, 200, 83, 0.7);
        }

        input:checked + .ai-toggle-slider:before {
            transform: translateX(30px);
        }

        .start-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            background: linear-gradient(135deg, #6550ff, #8a7cff);
            border: none;
            color: #e1e6ff;
            padding: 15px;
            font-size: 1.4rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .start-button::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg,
                #6550ff, #8a7cff,
                #ffcc00, #ff3366,
                #6550ff, #8a7cff);
            background-size: 300% 300%;
            z-index: -1;
            border-radius: 10px;
            animation: gradientBG 3s ease infinite;
        }

        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(101, 80, 255, 0.6);
        }

        .start-button:active {
            transform: scale(0.98);
        }

        @keyframes scanLine {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            background: rgba(12, 16, 39, 0.8);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(101, 80, 255, 0.3);
            overflow: hidden;
            border: 1px solid rgba(101, 80, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .game-header {
            text-align: center;
            padding: 5px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(101, 80, 255, 0.3);
        }

        .game-title {
            color: #e1e6ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px #6550ff;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .game-subtitle {
            color: #a0a8ff;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            padding: 5px 30px;
            background: rgba(16, 20, 45, 0.7);
            position: relative;
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .player-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #a0a8ff;
        }

        .player-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            position: relative;
        }

        .score-animation {
            position: absolute;
            font-size: 3rem;
            color: #ff3366;
            opacity: 0;
            animation: scorePopup 1s forwards;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 15px rgba(255, 51, 102, 0.7);
        }

        @keyframes scorePopup {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .game-content {
            position: relative;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #game-canvas {
            background: rgba(8, 12, 33, 0.7);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(101, 80, 255, 0.2);
            border: 1px solid rgba(101, 80, 255, 0.2);
        }

        .controls-info {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            color: #a0a8ff;
            background: rgba(16, 20, 45, 0.6);
            border-top: 1px solid rgba(101, 80, 255, 0.2);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            background: #ffcc00;
            opacity: 0.8;
        }

        .center-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: linear-gradient(to bottom,
                transparent 0%,
                rgba(101, 80, 255, 0.5) 10%,
                rgba(101, 80, 255, 0.8) 50%,
                rgba(101, 80, 255, 0.5) 90%,
                transparent 100%);
            transform: translateX(-50%);
        }

        .glow-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            box-shadow: inset 0 0 30px rgba(101, 80, 255, 0.5);
            pointer-events: none;
            z-index: -1;
        }

        .victory-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(12, 16, 39, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .victory-message {
            font-size: 4rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
            margin-bottom: 30px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        .restart-btn {
            background: rgba(101, 80, 255, 0.5);
            border: 2px solid #a0a8ff;
            color: #e1e6ff;
            padding: 12px 35px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .restart-btn:hover {
            background: rgba(101, 80, 255, 0.8);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(101, 80, 255, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
            50% { transform: scale(1.1); text-shadow: 0 0 30px rgba(255, 204, 0, 1); }
            100% { transform: scale(1); text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
        }

        .obstacle-warning {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: warningPulse 0.5s infinite alternate;
        }

        @keyframes warningPulse {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 0.7; transform: scale(1.1); }
        }

        /* äº‹ä»¶å¼¹çª—æ ·å¼ */
        .event-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 250px;
            max-width: 350px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.5s ease, opacity 0.5s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .event-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .event-notification.positive {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .event-notification.neutral {
            border-color: #888888;
            box-shadow: 0 0 20px rgba(136, 136, 136, 0.3);
        }

        .event-notification.negative {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #e1e6ff;
        }

        .event-description {
            font-size: 0.9rem;
            color: #a0a8ff;
            line-height: 1.4;
        }

        .event-trigger {
            font-size: 0.8rem;
            color: #ffcc00;
            margin-bottom: 8px;
            font-weight: bold;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* æš‚åœ/é‡æ–°å¼€å§‹æŒ‰é’®æ ·å¼ */
        .pause-button {
            position: fixed;
            top: 20px;
            right: 5%;
            transform: translateX(50%);
            background: rgba(101, 80, 255, 0.8);
            border: 2px solid rgba(101, 80, 255, 0.9);
            color: #e1e6ff;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .pause-button:hover {
            background: rgba(101, 80, 255, 1);
            transform: translateX(50%) scale(1.05);
            box-shadow: 0 0 20px rgba(101, 80, 255, 0.6);
        }

        .pause-button.paused {
            background: rgba(255, 68, 68, 0.8);
            border-color: rgba(255, 68, 68, 0.9);
        }

        .pause-button.paused:hover {
            background: rgba(255, 68, 68, 1);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        /* è°ƒè¯•çª—å£æ ·å¼ */
        .debug-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid rgba(255, 68, 68, 0.5);
            border-radius: 12px;
            padding: 15px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            overflow: hidden;
        }

        .debug-panel:hover {
            width: 280px;
            height: 420px;
            cursor: default;
        }

        .debug-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff4444;
            transition: opacity 0.3s ease;
        }

        .debug-panel:hover .debug-icon {
            opacity: 0;
        }

        .debug-content {
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            height: 100%;
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
        }

        .debug-panel:hover .debug-content {
            opacity: 1;
        }

        .debug-title {
            color: #e1e6ff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 68, 68, 0.3);
            padding-bottom: 8px;
        }

        .debug-section {
            margin-bottom: 12px;
        }

        .debug-section-title {
            color: #ff4444;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .debug-item {
            color: #a0a8ff;
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
        }

        .debug-label {
            color: #e1e6ff;
        }

        .debug-value {
            color: #ffcc00;
            font-weight: bold;
        }

        /* éš¾åº¦è°ƒæ•´çª—å£æ ·å¼ */
        .difficulty-panel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid rgba(101, 80, 255, 0.5);
            border-radius: 12px;
            padding: 15px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            overflow: hidden;
        }

        .difficulty-panel:hover {
            width: 200px;
            height: 320px;
            cursor: default;
        }

        .difficulty-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #6550ff;
            transition: opacity 0.3s ease;
        }

        .difficulty-panel:hover .difficulty-icon {
            opacity: 0;
        }

        .difficulty-content {
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .difficulty-panel:hover .difficulty-content {
            opacity: 1;
        }

        .difficulty-title {
            color: #e1e6ff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .difficulty-option {
            background: rgba(101, 80, 255, 0.3);
            border: 1px solid rgba(101, 80, 255, 0.5);
            color: #e1e6ff;
            padding: 8px 12px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
        }

        .difficulty-option:hover {
            background: rgba(101, 80, 255, 0.6);
            transform: scale(1.02);
        }

        .difficulty-option.active {
            background: rgba(101, 80, 255, 0.8);
            border-color: #6550ff;
            box-shadow: 0 0 10px rgba(101, 80, 255, 0.5);
        }

        /* ç”µè„‘å›çƒå¢å¼ºé€‰é¡¹æ ·å¼ */
        .ai-enhancement-option {
            background: rgba(255, 165, 0, 0.3);
            border: 1px solid rgba(255, 165, 0, 0.5);
            color: #e1e6ff;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
        }

        .ai-enhancement-option:hover {
            background: rgba(255, 165, 0, 0.6);
            transform: scale(1.02);
        }

        .ai-enhancement-option.active {
            background: rgba(255, 165, 0, 0.8);
            border-color: #ffa500;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }

        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }

            .game-subtitle {
                font-size: 0.9rem;
            }

            .player-name {
                font-size: 1rem;
            }

            .player-score {
                font-size: 2rem;
            }

            .victory-message {
                font-size: 2.5rem;
            }

            .event-notification {
                top: 10px;
                right: 10px;
                min-width: 200px;
                max-width: 280px;
                padding: 12px 15px;
            }

            .event-title {
                font-size: 1rem;
            }

            .event-description {
                font-size: 0.8rem;
            }


            .difficulty-panel {
                right: 10px;
                width: 50px;
                height: 50px;
            }

            .difficulty-panel:hover {
                width: 180px;
                height: 280px;
            }

            .difficulty-icon {
                font-size: 20px;
            }

            .debug-panel {
                left: 10px;
                width: 50px;
                height: 50px;
            }

            .debug-panel:hover {
                width: 260px;
                height: 300px;
            }

            .debug-icon {
                font-size: 20px;
            }

            .pause-button {
                top: 10px;
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- æ–°å¢å¼€å§‹é¡µé¢ -->
    <div class="start-screen" id="start-screen">
        <div class="start-container">
            <h1 class="start-title">CYBERPONGK</h1>
            <p class="start-subtitle">ç›´é¢å¼ºæ•Œï¼Œå®ˆä½åº•çº¿ï¼Œè½¬æˆ˜å›å‡»<br>ä¸ºäº†æœ€ä½³çš„æ¸¸æˆä½“éªŒï¼Œè¯·æ‰“å¼€æ•Œæ–¹å›çƒå¢å¼º</p>

            <div class="start-options">
                <div class="option-group">
                    <div class="option-title">ä½œæˆ˜éš¾åº¦</div>
                    <div class="difficulty-options">
                        <div class="start-difficulty-option active" data-speed="1.75">ä¸‡æ³‰éƒ¨è¯—äºº</div>
                        <div class="start-difficulty-option" data-speed="2.5">é‡æ¯”å¤§é›„</div>
                        <div class="start-difficulty-option" data-speed="3">å°‘å¥³B</div>
                        <div class="start-difficulty-option" data-speed="3.5">å°åŸ‹</div>
                        <div class="start-difficulty-option" data-speed="4.25">ç©º&ç™½</div>
                    </div>
                </div>

                <div class="option-group">
                    <div class="option-title">æ•Œæ–¹å¼ºåŒ–æ¨¡å—</div>
                    <div class="ai-toggle-container">
                        <div class="ai-toggle-label">æ¿€æ´»æ•Œæ–¹å›çƒå¢å¼ºåè®®</div>
                        <label class="ai-toggle">
                            <input type="checkbox" id="start-ai-enhancement">
                            <span class="ai-toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <button class="start-button" id="start-button">å¯åŠ¨æˆ˜æ–—ç³»ç»Ÿ</button>
        </div>
    </div>

    <div class="game-container">
        <div class="glow-effect"></div>
        <div class="game-header">
            <h1 class="game-title">CYBERPONGK</h1>
            <p class="game-subtitle">Itsuyoçš„æ‘¸é±¼å¤§ï¼ˆå­˜ç–‘ï¼‰ä½œ Â· Crafted with Deepsuck</p>
        </div>

        <div class="game-stats">
            <div class="player-stats">
                <div class="player-name">ç©å®¶</div>
                <div id="player-score" class="player-score">0</div>
            </div>

            <div class="player-stats">
                <div id="computer-player-name" class="player-name">ç”µè„‘</div>
                <div id="computer-score" class="player-score">0</div>
            </div>
        </div>

        <div class="game-content">
            <div class="center-line"></div>
            <canvas id="game-canvas" width="800" height="500"></canvas>
        </div>

        <div class="victory-overlay" id="victory-overlay">
            <div class="victory-message" id="victory-message"></div>
            <button class="restart-btn" id="restart-btn">é‡æ–°å¼€å§‹</button>
        </div>

        <div class="controls-info">
            ä½¿ç”¨é¼ æ ‡ç§»åŠ¨æ§åˆ¶ä½ çš„æŒ¡æ¿ | é¦–å…ˆè·å¾—3åˆ†è€…è·èƒœ | æ”¶é›†äº‹ä»¶è·å¾—ç‰¹æ®Šæ•ˆæœï¼
        </div>
    </div>

    <!-- éš¾åº¦è°ƒæ•´çª—å£ -->
    <div class="difficulty-panel" id="difficulty-panel">
        <div class="difficulty-icon">âš™ï¸</div>
        <div class="difficulty-content">
            <div class="difficulty-title">éš¾åº¦è®¾ç½®</div>
            <div class="difficulty-option" data-speed="1.75">ä¸‡æ³‰éƒ¨è¯—äºº</div>
            <div class="difficulty-option" data-speed="2.5">é‡æ¯”å¤§é›„</div>
            <div class="difficulty-option active" data-speed="3">å°‘å¥³B</div>
            <div class="difficulty-option" data-speed="3.5">å°åŸ‹</div>
            <div class="difficulty-option" data-speed="4.25">ç©º&ç™½</div>

            <!-- ç”µè„‘å›çƒå¢å¼ºé€‰é¡¹ -->
            <div class="ai-enhancement-option" id="ai-enhancement-toggle">
                æ•Œæ–¹å›çƒå¢å¼º
            </div>
        </div>
    </div>

    <!-- è°ƒè¯•çª—å£ -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-icon">ğŸ›</div>
        <div class="debug-content">
            <div class="debug-title">è°ƒè¯•ä¿¡æ¯</div>
            
            <div class="debug-section">
                <div class="debug-section-title">çƒçŠ¶æ€</div>
                <div class="debug-item">
                    <span class="debug-label">é€Ÿåº¦:</span>
                    <span class="debug-value" id="debug-ball-speed">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">ä½ç½®:</span>
                    <span class="debug-value" id="debug-ball-position">0,0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">é€æ˜åº¦:</span>
                    <span class="debug-value" id="debug-ball-alpha">1.0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">ç”µè„‘æ•°æ®</div>
                <div class="debug-item">
                    <span class="debug-label">é€Ÿåº¦:</span>
                    <span class="debug-value" id="debug-computer-speed">3</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">ä½ç½®:</span>
                    <span class="debug-value" id="debug-computer-position">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">é€Ÿåº¦å€æ•°:</span>
                    <span class="debug-value" id="debug-computer-multiplier">1.0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">äº‹ä»¶çŠ¶æ€</div>
                <div class="debug-item">
                    <span class="debug-label">æ´»è·ƒäº‹ä»¶:</span>
                    <span class="debug-value" id="debug-active-events">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">éšœç¢ç‰©:</span>
                    <span class="debug-value" id="debug-obstacles">0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">ç³»ç»Ÿ</div>
                <div class="debug-item">
                    <span class="debug-label">FPS:</span>
                    <span class="debug-value" id="debug-fps">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">æ¸¸æˆæ—¶é—´:</span>
                    <span class="debug-value" id="debug-game-time">0s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æš‚åœ/é‡æ–°å¼€å§‹æŒ‰é’® -->
    <button class="pause-button" id="pause-button">æš‚åœ</button>

    <script>
        // æ–°å¢å¼€å§‹é¡µé¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const startDifficultyOptions = document.querySelectorAll('.start-difficulty-option');
            const startAiToggle = document.getElementById('start-ai-enhancement');

            // è®¾ç½®é»˜è®¤é€‰é¡¹ï¼ˆç®€å•éš¾åº¦ï¼‰
            let selectedDifficulty = 1.75;

            // å¼€å§‹é¡µé¢éš¾åº¦é€‰æ‹©
            startDifficultyOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    startDifficultyOptions.forEach(opt => opt.classList.remove('active'));
                    // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹
                    this.classList.add('active');
                    // æ›´æ–°é€‰æ‹©çš„éš¾åº¦
                    selectedDifficulty = parseFloat(this.dataset.speed);
                });
            });

            // AIå›çƒå¢å¼ºé€‰é¡¹
            startAiToggle.addEventListener('change', function() {
                aiEnhancementEnabled = this.checked;
            });

            // å¼€å§‹æŒ‰é’®äº‹ä»¶
            startButton.addEventListener('click', function() {
                // åº”ç”¨é€‰æ‹©çš„éš¾åº¦åˆ°æ¸¸æˆå†…
                computer.speed = selectedDifficulty;

                // åŒæ­¥æ¸¸æˆå†…éš¾åº¦é€‰æ‹©
                document.querySelectorAll('.difficulty-option').forEach(option => {
                    if (parseFloat(option.dataset.speed) === selectedDifficulty) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });

                // åŒæ­¥AIå¢å¼ºé€‰é¡¹
                const gameAiToggle = document.getElementById('ai-enhancement-toggle');
                if (aiEnhancementEnabled) {
                    gameAiToggle.classList.add('active');
                } else {
                    gameAiToggle.classList.remove('active');
                }

                aiEnhancementEnabled = aiEnhancementEnabled;

                // éšè—å¼€å§‹é¡µé¢
                startScreen.classList.add('hidden');

                // è®¾ç½®ç”µè„‘åç§°
                const computerNameElement = document.getElementById('computer-player-name');
                const selectedDifficultyOption = document.querySelector('.difficulty-option.active');
                computerNameElement.textContent = selectedDifficultyOption.textContent;

                // é‡ç½®æ¸¸æˆï¼ˆå¦‚æœå·²ç»ç©è¿‡ï¼‰
                resetGame();
            });
        });

        // è·å–Canvaså’ŒContext
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // ç©å®¶å’Œç”µè„‘çš„åˆ†æ•°
        const playerScoreElement = document.getElementById('player-score');
        const computerScoreElement = document.getElementById('computer-score');
        let playerScore = 0;
        let computerScore = 0;

        // èƒœåˆ©ç•Œé¢å…ƒç´ 
        const victoryOverlay = document.getElementById('victory-overlay');
        const victoryMessage = document.getElementById('victory-message');
        const restartBtn = document.getElementById('restart-btn');

        // æ·»åŠ å¸§ç‡é”å®šç›¸å…³å˜é‡
        const FPS = 120; // ç›®æ ‡å¸§ç‡
        const FRAME_INTERVAL = 1000 / FPS; // æ¯å¸§æ—¶é—´(ms)
        let lastTime = 0;
        let deltaTime = 0;
        let accumulatedTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;

        // æ¸¸æˆçŠ¶æ€
        let isGameOver = false;
        let isResetting = false;
        let isPaused = false; // æ·»åŠ æš‚åœçŠ¶æ€
        let gameTime = 0; // æ¸¸æˆè¿è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        let nextObstacleTime = 15000; // ç¬¬ä¸€æ¬¡éšœç¢ç‰©å‡ºç°æ—¶é—´ï¼ˆ15ç§’åï¼‰
        let nextEventTime = 10000; // ç¬¬ä¸€æ¬¡äº‹ä»¶å‡ºç°æ—¶é—´ï¼ˆ10ç§’åï¼‰

        // ç”µè„‘å›çƒå¢å¼ºåŠŸèƒ½çŠ¶æ€
        let aiEnhancementEnabled = false;

        // æ­»çƒæ£€æµ‹ç›¸å…³å˜é‡
        let ballStuckDetection = {
            lastY: 0,
            stuckTime: 0,
            checkInterval: 100, // æ¯100msæ£€æŸ¥ä¸€æ¬¡
            lastCheckTime: 0,
            stuckThreshold: 2000, // 2ç§’å†…å¡åœ¨è¾¹ç¼˜åˆ¤å®šä¸ºæ­»çƒ
            edgeThreshold: 30 // è·ç¦»è¾¹ç¼˜30åƒç´ å†…ç®—ä½œè¾¹ç¼˜
        };

        // è®°å½•ä¸Šä¸€ä¸ªè§¦çƒçš„ç©å®¶ ('player' æˆ– 'computer')
        let lastTouchedBy = null;

        // æ¸¸æˆå¯¹è±¡
        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 12,
            speed: 4,
            velocityX: 5,
            velocityY: 5,
            color: '#ffcc00',
            trail: [],
            lastCollision: 0, // è®°å½•ä¸Šæ¬¡ç¢°æ’æ—¶é—´
            alpha: 1.0, // çƒçš„é€æ˜åº¦
            speedMultiplier: 1.0 // é€Ÿåº¦å€æ•°
        };

        // ç©å®¶æŒ¡æ¿
        const player = {
            x: 20,
            y: canvas.height / 2 - 70,
            width: 15,
            height: 120,
            speed: 8,
            color: '#6550ff',
            score: 0,
            originalHeight: 120,
            glowEffect: false,
            glowEndTime: 0,
            rgbEffect: false, // æ·»åŠ rgbæ•ˆæœå±æ€§
            rgbEndTime: 0 // æ·»åŠ rgbæ•ˆæœç»“æŸæ—¶é—´
        };

        // ç”µè„‘æŒ¡æ¿
        const computer = {
            x: canvas.width - 35,
            y: canvas.height / 2 - 70,
            width: 15,
            height: 120,
            speed: 3,
            color: '#ff3366',
            score: 0,
            originalHeight: 120,
            glowEffect: false,
            glowEndTime: 0,
            rgbEffect: false, // æ·»åŠ rgbæ•ˆæœå±æ€§
            rgbEndTime: 0, // æ·»åŠ rgbæ•ˆæœç»“æŸæ—¶é—´
            speedMultiplier: 1.0
        };

        // ç²’å­æ•°ç»„
        const particles = [];

        // éšœç¢ç‰©æ•°ç»„
        const obstacles = [];

        // äº‹ä»¶æ•°ç»„
        const events = [];

        // å…¨å±€æ•ˆæœ
        const globalEffects = {
            speedVariation: { active: false, endTime: 0 },
            obstacleSpeedUp: { active: false, endTime: 0, originalInterval: 0 },
            thunderCloud: { active: false, endTime: 0, flashTime: 0 },
            // æ–°å¢æ•ˆæœ
            immortalTotem: { active: false, endTime: 0, triggeredBy: null },
            eventFrenzy: { active: false, endTime: 0, originalEventInterval: 0 },
            heavenMaker: { active: false, endTime: 0, stackCount: 0 },
            heavyBall: { active: false, endTime: 0, stackCount: 0 }
        };

        // äº‹ä»¶ç±»å‹å®šä¹‰
        const eventTypes = {
            // æ­£é¢äº‹ä»¶
            PADDLE_GROW: {
                type: 'positive',
                color: '#00ff88',
                name: 'Boâ™‚ki',
                description: 'æ¿å­å¢é•¿20%ï¼ŒæŒç»­20ç§’'
            },
            LIGHTNING_PADDLE: {
                type: 'positive',
                color: '#ffff00',
                name: 'å’–å–±æ£’',
                description: 'è·å¾—é‡‘é—ªé—ªæ•ˆæœï¼Œè§¦çƒå¢é€Ÿ80%ï¼ŒæŒç»­20ç§’'
            },
            SLOW_COMPUTER: {
                type: 'positive',
                color: '#00ccff',
                name: 'å¯’å†°è‡',
                description: 'ç”µè„‘æ¿å­ç§»åŠ¨é€Ÿåº¦-20%ï¼Œç›´åˆ°ä¸‹æ¬¡è¿›çƒ'
            },
            
            // ä¸­æ€§äº‹ä»¶
            SPEED_VARIATION: {
                type: 'neutral',
                color: '#888888',
                name: 'è‡´å‘½èŠ‚å¥',
                description: 'çƒé€Ÿåœ¨70%-130%é—´å˜åŠ¨ï¼ŒæŒç»­15ç§’'
            },
            OBSTACLE_RUSH: {
                type: 'neutral',
                color: '#aa6600',
                name: 'ç§»åŠ¨è¿·å®«',
                description: 'éšœç¢ç‰©ç”Ÿæˆé€Ÿåº¦æå‡500%ï¼ŒæŒç»­30ç§’'
            },
            SPEED_RESET: {
                type: 'neutral',
                color: '#666666',
                name: 'é£Ÿå…‰é¸¡',
                description: 'çƒé€Ÿé‡ç½®ä¸ºåˆå§‹é€Ÿåº¦'
            },
            
            // è´Ÿé¢äº‹ä»¶
            THUNDER_CLOUD: {
                type: 'negative',
                color: '#444444',
                name: 'éª¤é›¨çš„ç‹­é—´',
                description: 'ä¸­å¤®é›·äº‘é®æŒ¡è§†é‡ï¼Œçƒç»è¿‡æ—¶æ”¹å˜è§’åº¦'
            },
            PADDLE_SHRINK: {
                type: 'negative',
                color: '#660000',
                name: 'é˜³ç—¿',
                description: 'æ¿å­ç¼©çŸ­20%ï¼ŒæŒç»­20ç§’'
            },
            BALL_FADE: {
                type: 'negative',
                color: '#333333',
                name: 'æˆ‘åä¸ºæš—å½±',
                description: 'çƒé€æ˜åº¦é™ä¸º10%ï¼ŒæŒç»­15ç§’'
            },
            
            // æ–°å¢äº‹ä»¶
            // æ­£é¢
            IMMORTAL_TOTEM: {
                type: 'positive',
                color: '#ff00ff',
                name: 'ä¸æ­»å›¾è…¾',
                description: 'è§¦å‘æ–¹åœ¨45ç§’å†…ç¬¬ä¸€ä¸ªå¤±çƒå‡ä¸è®¡å…¥åˆ†æ•°'
            },
            // ä¸­æ€§
            EVENT_FRENZY: {
                type: 'neutral',
                color: '#888888',
                name: 'EVENTâ˜†START',
                description: 'äº‹ä»¶åˆ·æ–°ç‡å¢åŠ ä¸º400%ï¼ŒæŒç»­30ç§’'
            },
            HEAVEN_MAKER: {
                type: 'neutral',
                color: '#cccccc',
                name: 'MADE IN HEAVEN',
                description: 'çƒçš„å¤§å°å˜ä¸ºåŸæ¥çš„50%ï¼Œé€Ÿåº¦å˜ä¸ºåŸæ¥çš„125%ï¼ŒæŒç»­25ç§’'
            },
            HEAVY_BALL: {
                type: 'neutral',
                color: '#666666',
                name: 'é‡æ°´å˜å¤§å˜é«˜',
                description: 'çƒçš„å¤§å°å˜ä¸ºåŸæ¥çš„200%ï¼Œé€Ÿåº¦å˜ä¸ºåŸæ¥çš„80%ï¼ŒæŒç»­25ç§’'
            }
        };

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ç›‘å¬
        canvas.addEventListener('mousemove', (e) => {
            if (isGameOver || isPaused) return; // æ·»åŠ æš‚åœæ£€æŸ¥
            const rect = canvas.getBoundingClientRect();
            player.y = e.clientY - rect.top - player.height / 2;
        });

        // é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
        restartBtn.addEventListener('click', () => {
            resetGame();
        });

        // éš¾åº¦è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.difficulty-option').forEach(option => {
            option.addEventListener('click', (e) => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('active'));
                // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹
                e.target.classList.add('active');
                // æ›´æ–°ç”µè„‘é€Ÿåº¦
                const newSpeed = parseFloat(e.target.dataset.speed);
                computer.speed = newSpeed;
                // æ›´æ–°ç”µè„‘åç§°
                const computerNameElement = document.getElementById('computer-player-name');
                computerNameElement.textContent = e.target.textContent;
            });
        });

        // ç”µè„‘å›çƒå¢å¼ºé€‰é¡¹äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('ai-enhancement-toggle').addEventListener('click', (e) => {
            aiEnhancementEnabled = !aiEnhancementEnabled;
            if (aiEnhancementEnabled) {
                e.target.classList.add('active');
            } else {
                e.target.classList.remove('active');
            }
        });

        // æš‚åœæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        const pauseButton = document.getElementById('pause-button');
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                pauseButton.textContent = 'ç»§ç»­';
                pauseButton.classList.add('paused');
            } else {
                pauseButton.textContent = 'æš‚åœ';
                pauseButton.classList.remove('paused');
            }
        });

        // æ˜¾ç¤ºäº‹ä»¶é€šçŸ¥å¼¹çª—
        function showEventNotification(eventObj, triggeredBy) {
            // ç§»é™¤ç°æœ‰çš„é€šçŸ¥
            const existingNotification = document.querySelector('.event-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // åˆ›å»ºæ–°çš„é€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `event-notification ${eventObj.typeData.type}`;
            
            const triggerText = triggeredBy === 'player' ? 'ç©å®¶è§¦å‘' : 'ç”µè„‘è§¦å‘';
            
            notification.innerHTML = `
                <div class="event-trigger">${triggerText}</div>
                <div class="event-title">${eventObj.typeData.name}</div>
                <div class="event-description">${eventObj.typeData.description}</div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);

            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
            }, 3000);
        }

        // æ˜¾ç¤ºæ­»çƒæ£€æµ‹é€šçŸ¥
        function showDeadBallNotification() {
            // ç§»é™¤ç°æœ‰çš„é€šçŸ¥
            const existingNotification = document.querySelector('.event-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // åˆ›å»ºæ–°çš„é€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'event-notification negative';

            notification.innerHTML = `
                <div class="event-trigger">ç³»ç»Ÿæ£€æµ‹</div>
                <div class="event-title">å¡çƒæ£€æµ‹è¢«è§¦å‘</div>
                <div class="event-description">æ£€æµ‹åˆ°è¾¹çº¿æ­»çƒbugï¼Œé‡æ–°å‘çƒ</div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);

            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
            }, 3000);
        }

        // æ­»çƒæ£€æµ‹å‡½æ•°
        function checkDeadBall() {
            const currentTime = Date.now();

            // æ¯100msæ£€æŸ¥ä¸€æ¬¡
            if (currentTime - ballStuckDetection.lastCheckTime < ballStuckDetection.checkInterval) {
                return false;
            }

            ballStuckDetection.lastCheckTime = currentTime;

            // æ£€æŸ¥çƒæ˜¯å¦åœ¨ä¸Šä¸‹è¾¹ç¼˜é™„è¿‘
            const isNearTopEdge = ball.y <= ballStuckDetection.edgeThreshold;
            const isNearBottomEdge = ball.y >= (canvas.height - ballStuckDetection.edgeThreshold);

            if (isNearTopEdge || isNearBottomEdge) {
                // æ£€æŸ¥çƒçš„Yåæ ‡æ˜¯å¦åœ¨å¾ˆå°èŒƒå›´å†…å˜åŒ–ï¼ˆè¡¨ç¤ºå¡ä½äº†ï¼‰
                const yDifference = Math.abs(ball.y - ballStuckDetection.lastY);

                if (yDifference < 5) { // Yåæ ‡å˜åŒ–å°äº5åƒç´ 
                    ballStuckDetection.stuckTime += ballStuckDetection.checkInterval;

                    // å¦‚æœå¡ä½æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œè§¦å‘æ­»çƒæ£€æµ‹
                    if (ballStuckDetection.stuckTime >= ballStuckDetection.stuckThreshold) {
                        return true;
                    }
                } else {
                    // çƒåœ¨ç§»åŠ¨ï¼Œé‡ç½®å¡ä½æ—¶é—´
                    ballStuckDetection.stuckTime = 0;
                }
            } else {
                // çƒä¸åœ¨è¾¹ç¼˜ï¼Œé‡ç½®å¡ä½æ—¶é—´
                ballStuckDetection.stuckTime = 0;
            }

            ballStuckDetection.lastY = ball.y;
            return false;
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            playerScore = 0;
            computerScore = 0;
            playerScoreElement.textContent = '0';
            computerScoreElement.textContent = '0';
            victoryOverlay.style.opacity = '0';
            victoryOverlay.style.pointerEvents = 'none';
            isGameOver = false;
            gameTime = 0;
            nextObstacleTime = 20000;
            nextEventTime = 10000;
            obstacles.length = 0;
            events.length = 0;
            lastTouchedBy = null;

            // é‡ç½®ç”µè„‘åç§°
            document.getElementById('computer-player-name').textContent = 'ç”µè„‘';

            // é‡ç½®æ­»çƒæ£€æµ‹
            ballStuckDetection.lastY = 0;
            ballStuckDetection.stuckTime = 0;
            ballStuckDetection.lastCheckTime = 0;
            
            // ç§»é™¤æ‰€æœ‰äº‹ä»¶é€šçŸ¥
            const notifications = document.querySelectorAll('.event-notification');
            notifications.forEach(notification => notification.remove());
            
            // é‡ç½®æŒ¡æ¿çŠ¶æ€
            player.height = player.originalHeight;
            player.glowEffect = false;
            player.glowEndTime = 0;
            player.rgbEffect = false; // é‡ç½®rgbæ•ˆæœ
            player.rgbEndTime = 0; // é‡ç½®rgbæ•ˆæœç»“æŸæ—¶é—´
            computer.height = computer.originalHeight;
            computer.glowEffect = false;
            computer.glowEndTime = 0;
            computer.speedMultiplier = 1.0;
            computer.rgbEffect = false; // é‡ç½®rgbæ•ˆæœ
            computer.rgbEndTime = 0; // é‡ç½®rgbæ•ˆæœç»“æŸæ—¶é—´
            
            // é‡ç½®çƒçŠ¶æ€
            ball.alpha = 1.0;
            ball.speedMultiplier = 1.0;
            ball.radius = 12; // é‡ç½®çƒçš„åŠå¾„
            
            // é‡ç½®å…¨å±€æ•ˆæœ
            globalEffects.speedVariation.active = false;
            globalEffects.obstacleSpeedUp.active = false;
            globalEffects.thunderCloud.active = false;
            // é‡ç½®æ–°å¢æ•ˆæœ
            globalEffects.immortalTotem.active = false;
            globalEffects.immortalTotem.triggeredBy = null;
            globalEffects.eventFrenzy.active = false;
            globalEffects.heavenMaker.active = false;
            globalEffects.heavenMaker.stackCount = 0;
            globalEffects.heavyBall.active = false;
            globalEffects.heavyBall.stackCount = 0;

            const computerNameElement = document.getElementById('computer-player-name');
            const selectedDifficultyOption = document.querySelector('.difficulty-option.active');
            computerNameElement.textContent = selectedDifficultyOption.textContent;
            
            resetBall();
        }

<!--        // åœ¨ resetGame() å‡½æ•°ä¹‹åæ·»åŠ æ­¤ä»£ç ï¼ˆå¤§çº¦åœ¨ä»£ç çš„ 1650 è¡Œå·¦å³ï¼‰-->
<!--        function testThunderCloud() {-->
<!--            globalEffects.immortalTotem.active = true;-->
<!--            globalEffects.immortalTotem.endTime = Date.now() + 30000; // æŒç»­30ç§’-->
<!--            globalEffects.immortalTotem.triggeredBy = "player";-->
<!--            player.rgbEffect = true; // ä½¿ç”¨rgbEffectè€Œä¸æ˜¯glowEffect-->
<!--            player.rgbEndTime = Date.now() + 30000;-->
<!--            globalEffects.thunderCloud.flashTime = Date.now() + 1000; // 1ç§’åç¬¬ä¸€æ¬¡é—ªç”µ-->
<!--        }-->

<!--        // ç„¶åè°ƒç”¨æµ‹è¯•å‡½æ•°ï¼ˆå¤§çº¦åœ¨ä»£ç çš„ 2400 è¡Œå·¦å³ï¼‰-->
<!--        testThunderCloud(); // åœ¨æ¸¸æˆåˆå§‹åŒ–åè°ƒç”¨-->

        // ç¢°æ’ç²’å­æ•ˆæœ
        function createParticles(x, y, color, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    radius: Math.random() * 3 + 1,
                    color: color,
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * Math.PI * 2,
                    life: 30
                });
            }
        }

        // åˆ›å»ºå¾—åˆ†ç‰¹æ•ˆ
        function createScoreEffect(isPlayer) {
            const scoreEffect = document.createElement('div');
            scoreEffect.className = 'score-animation';
            scoreEffect.textContent = '+1';

            const statsContainer = isPlayer ?
                playerScoreElement.parentElement :
                computerScoreElement.parentElement;

            statsContainer.appendChild(scoreEffect);

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                scoreEffect.remove();
            }, 1000);
        }

        // åˆ›å»ºäº‹ä»¶
        function createEvent() {
            // åœ¨ä¸­é—´90%åŒºåŸŸç”Ÿæˆäº‹ä»¶
            const minX = canvas.width * 0.05;
            const maxX = canvas.width * 0.95;
            const minY = canvas.height * 0.05;
            const maxY = canvas.height * 0.95;

            const x = minX + Math.random() * (maxX - minX);
            const y = minY + Math.random() * (maxY - minY);

            // éšæœºé€‰æ‹©äº‹ä»¶ç±»å‹
            const eventTypeKeys = Object.keys(eventTypes);
            const randomEventType = eventTypeKeys[Math.floor(Math.random() * eventTypeKeys.length)];
            const eventType = eventTypes[randomEventType];

            events.push({
                x: x,
                y: y,
                radius: 15,
                type: randomEventType,
                typeData: eventType,
                spawnTime: Date.now(),
                duration: 20000, // 20ç§’åæ¶ˆå¤±
                pulsePhase: 0
            });
        }

        // è§¦å‘äº‹ä»¶æ•ˆæœ
        function triggerEvent(eventObj, triggeredBy) {
            const currentTime = Date.now();
            
            // æ˜¾ç¤ºäº‹ä»¶é€šçŸ¥
            showEventNotification(eventObj, triggeredBy);
            
            switch (eventObj.type) {
                case 'PADDLE_GROW':
                    if (triggeredBy === 'player') {
                        player.height = Math.min(player.height * 1.2, canvas.height * 0.8);
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.height = Math.min(computer.height * 1.2, canvas.height * 0.8);
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'LIGHTNING_PADDLE':
                    if (triggeredBy === 'player') {
                        player.glowEffect = true;
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.glowEffect = true;
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'SLOW_COMPUTER':
                    // è¿™ä¸ªäº‹ä»¶åªå¯¹ç©å®¶æœ‰ç”¨ï¼Œä½†ç”µè„‘ä¹Ÿå¯ä»¥è§¦å‘ï¼ˆåªæ˜¯æ²¡æœ‰æ•ˆæœï¼‰
                    if (triggeredBy === 'player') {
                        computer.speedMultiplier = Math.max(computer.speedMultiplier * 0.8, 0.1);
                    }
                    break;
                    
                case 'SPEED_VARIATION':
                    globalEffects.speedVariation.active = true;
                    globalEffects.speedVariation.endTime = Math.max(
                        globalEffects.speedVariation.endTime, 
                        currentTime + 15000
                    );
                    break;
                    
                case 'OBSTACLE_RUSH':
                    if (!globalEffects.obstacleSpeedUp.active) {
                        globalEffects.obstacleSpeedUp.originalInterval = nextObstacleTime - gameTime;
                    }
                    globalEffects.obstacleSpeedUp.active = true;
                    globalEffects.obstacleSpeedUp.endTime = Math.max(
                        globalEffects.obstacleSpeedUp.endTime,
                        currentTime + 30000
                    );
                    break;
                    
                case 'SPEED_RESET':
                    ball.speed = 4;
                    ball.speedMultiplier = 1.0;
                    break;
                    
                case 'THUNDER_CLOUD':
                    globalEffects.thunderCloud.active = true;
                    globalEffects.thunderCloud.endTime = Math.max(
                        globalEffects.thunderCloud.endTime,
                        currentTime + 30000
                    );
                    break;
                    
                case 'PADDLE_SHRINK':
                    if (triggeredBy === 'player') {
                        player.height = Math.max(player.height * 0.8, 40);
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.height = Math.max(computer.height * 0.8, 40);
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'BALL_FADE':
                    ball.alpha = Math.min(ball.alpha, 0.1);
                    // è¿™é‡Œéœ€è¦ä¸€ä¸ªè®¡æ—¶å™¨æ¥æ¢å¤é€æ˜åº¦
                    setTimeout(() => {
                        ball.alpha = Math.min(ball.alpha + 0.9, 1.0);
                    }, 15000);
                    break;
                    
                // æ–°å¢äº‹ä»¶å¤„ç†
                case 'IMMORTAL_TOTEM':
                    // ä¸æ­»å›¾è…¾æ•ˆæœï¼Œä¸å¯å åŠ 
                    if (!globalEffects.immortalTotem.active) {
                        globalEffects.immortalTotem.active = true;
                        globalEffects.immortalTotem.endTime = currentTime + 45000; // 45ç§’
                        globalEffects.immortalTotem.triggeredBy = triggeredBy;

                        // ä¸ºè§¦å‘æ–¹æ·»åŠ RGBå˜è‰²æ•ˆæœ
                        if (triggeredBy === 'player') {
                            player.rgbEffect = true; // ä½¿ç”¨rgbEffectè€Œä¸æ˜¯glowEffect
                            player.rgbEndTime = currentTime + 45000;
                        } else {
                            computer.rgbEffect = true; // ä½¿ç”¨rgbEffectè€Œä¸æ˜¯glowEffect
                            computer.rgbEndTime = currentTime + 45000;
                        }
                    }
                    break;

                case 'EVENT_FRENZY':
                    // äº‹ä»¶ç‹‚æ½®æ•ˆæœï¼Œä¸å¯å åŠ 
                    if (!globalEffects.eventFrenzy.active) {
                        globalEffects.eventFrenzy.active = true;
                        globalEffects.eventFrenzy.endTime = currentTime + 30000; // 30ç§’
                        globalEffects.eventFrenzy.originalEventInterval = nextEventTime - gameTime;
                    }
                    break;
                    
                case 'HEAVEN_MAKER':
                    // å¤©å ‚åˆ¶é€ æ•ˆæœï¼Œå¯å åŠ 
                    if (!globalEffects.heavenMaker.active) {
                        globalEffects.heavenMaker.active = true;
                        globalEffects.heavenMaker.endTime = currentTime + 25000; // 25ç§’
                        globalEffects.heavenMaker.stackCount = 1;
                    } else {
                        // å åŠ æ•ˆæœï¼Œå»¶é•¿æ—¶é—´å¹¶å¢åŠ å åŠ æ¬¡æ•°
                        globalEffects.heavenMaker.endTime = Math.max(globalEffects.heavenMaker.endTime, currentTime + 25000);
                        globalEffects.heavenMaker.stackCount++;
                    }
                    // åº”ç”¨æ•ˆæœï¼šçƒå˜å°ï¼Œé€Ÿåº¦å˜å¿«
                    ball.radius = Math.max(ball.radius * 0.5, 3); // æœ€å°åŠå¾„3åƒç´ 
                    ball.speedMultiplier *= 1.25;
                    break;
                    
                case 'HEAVY_BALL':
                    // æ²‰é‡æ•ˆæœï¼Œå¯å åŠ 
                    if (!globalEffects.heavyBall.active) {
                        globalEffects.heavyBall.active = true;
                        globalEffects.heavyBall.endTime = currentTime + 25000; // 25ç§’
                        globalEffects.heavyBall.stackCount = 1;
                    } else {
                        // å åŠ æ•ˆæœï¼Œå»¶é•¿æ—¶é—´å¹¶å¢åŠ å åŠ æ¬¡æ•°
                        globalEffects.heavyBall.endTime = Math.max(globalEffects.heavyBall.endTime, currentTime + 25000);
                        globalEffects.heavyBall.stackCount++;
                    }
                    // åº”ç”¨æ•ˆæœï¼šçƒå˜å¤§ï¼Œé€Ÿåº¦å˜æ…¢
                    ball.radius = Math.min(ball.radius * 2, 50); // æœ€å¤§åŠå¾„50åƒç´ 
                    ball.speedMultiplier *= 0.8;
                    break;
            }
            
            // åˆ›å»ºäº‹ä»¶è§¦å‘ç²’å­æ•ˆæœ
            createParticles(eventObj.x, eventObj.y, eventObj.typeData.color, 25);
        }

        // åˆ›å»ºéšœç¢ç‰©
        function createObstacles() {
            // ç¡®ä¿éšœç¢ç‰©åœ¨ä¸­é—´75%åŒºåŸŸç”Ÿæˆ
            const minX = canvas.width * 0.125; // 12.5% å·¦è¾¹è·
            const maxX = canvas.width * 0.875; // 87.5% å³è¾¹è·
            const minY = canvas.height * 0.125; // 12.5% ä¸Šè¾¹è·
            const maxY = canvas.height * 0.875; // 87.5% ä¸‹è¾¹è·

            // éšæœºä½ç½®
            const x = minX + Math.random() * (maxX - minX);
            const y = minY + Math.random() * (maxY - minY);

            // éšæœºå¤§å° (20-40åƒç´ )
            const size = 20 + Math.random() * 20;

            // éšæœºå½¢çŠ¶ (åœ†å½¢æˆ–æ–¹å½¢)
            const type = Math.random() > 0.5 ? 'circle' : 'rect';

            // éšæœºå­˜åœ¨æ—¶é—´ (8-20ç§’)
            const duration = 8000 + Math.random() * 12000;

            // é¢„è­¦æ—¶é—´ (1ç§’)
            const warningTime = 1000;

            // éšæœºé€‰æ‹©å¯¹ç§°æ¨¡å¼ (1, 2, 3, 5, 9, 0, 4, 0ä¸ªéšœç¢ç‰©)
            const symmetryMode = Math.floor(Math.random() * 8); // 0-7

            // éšœç¢ç‰©ä½ç½®æ•°ç»„
            const positions = [];

            // ä¸­å¿ƒç‚¹
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // æ ¹æ®å¯¹ç§°æ¨¡å¼ç”Ÿæˆéšœç¢ç‰©ä½ç½®ï¼ˆæ”¾å°„æ€§è½´å¯¹ç§°ï¼‰
            switch (symmetryMode) {
                case 0: // 1ä¸ªéšœç¢ç‰©ï¼ˆä¸­å¿ƒï¼‰
                    positions.push({x: centerX, y: centerY});
                    break;

                case 1: // 2ä¸ªéšœç¢ç‰©ï¼ˆæ”¾å°„æ€§è½´å¯¹ç§°ï¼‰
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    break;

                case 2: // 3ä¸ªéšœç¢ç‰©ï¼ˆæ”¾å°„æ€§è½´å¯¹ç§°ï¼‰
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    break;

                case 3: // 5ä¸ªéšœç¢ç‰©ï¼ˆæ”¾å°„æ€§è½´å¯¹ç§°ï¼‰
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    break;

                case 4: // 9ä¸ªéšœç¢ç‰©ï¼ˆæ”¾å°„æ€§è½´å¯¹ç§°ï¼‰
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    positions.push({x: centerX, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: centerY});
                    positions.push({x: x, y: centerY});
                    positions.push({x: centerX, y: y});
                    break;

                case 5: // None
                    break;

                case 6: // 4ä¸ªéšœç¢ç‰©ï¼ˆè¡¥ï¼‰
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    break;

                case 7: //None
                    break;
            }

            // åˆ›å»ºéšœç¢ç‰©
            for (const pos of positions) {
                obstacles.push({
                    x: pos.x,
                    y: pos.y,
                    size: size,
                    type: type,
                    warningTime: warningTime,
                    warningProgress: 0,
                    duration: duration,
                    active: false,
                    spawnTime: Date.now()
                });
            }
        }

        // æ›´æ–°éšœç¢ç‰©çŠ¶æ€
        function updateObstacles() {
            const now = Date.now();

            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];

                // æ›´æ–°é¢„è­¦è¿›åº¦
                if (!obs.active) {
                    const elapsed = now - obs.spawnTime;
                    obs.warningProgress = Math.min(1, elapsed / obs.warningTime);

                    // å¦‚æœé¢„è­¦æ—¶é—´ç»“æŸï¼Œæ¿€æ´»éšœç¢ç‰©
                    if (elapsed >= obs.warningTime) {
                        obs.active = true;
                        obs.activateTime = now;
                    }
                }

                // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç§»é™¤éšœç¢ç‰©
                if (obs.active && now - obs.activateTime >= obs.duration) {
                    obstacles.splice(i, 1);
                }
            }
        }

        // æ›´æ–°äº‹ä»¶çŠ¶æ€
        function updateEvents() {
            const now = Date.now();

            for (let i = events.length - 1; i >= 0; i--) {
                const event = events[i];
                
                // æ›´æ–°è„‰å†²åŠ¨ç”»
                event.pulsePhase += 0.1;
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç§»é™¤äº‹ä»¶
                if (now - event.spawnTime >= event.duration) {
                    events.splice(i, 1);
                }
            }
        }

        // æ›´æ–°å…¨å±€æ•ˆæœ
        function updateGlobalEffects() {
            const now = Date.now();
            
            // é€Ÿåº¦å˜åŒ–æ•ˆæœ
            if (globalEffects.speedVariation.active) {
                if (now > globalEffects.speedVariation.endTime) {
                    globalEffects.speedVariation.active = false;
                    ball.speedMultiplier = 1.0;
                } else {
                    // åœ¨70%-130%ä¹‹é—´å˜åŠ¨
                    ball.speedMultiplier = 0.7 + 0.6 * (0.5 + 0.5 * Math.sin(now * 0.01));
                }
            }
            
            // éšœç¢ç‰©åŠ é€Ÿæ•ˆæœ
            if (globalEffects.obstacleSpeedUp.active) {
                if (now > globalEffects.obstacleSpeedUp.endTime) {
                    globalEffects.obstacleSpeedUp.active = false;
                }
            }
            
            // é›·äº‘æ•ˆæœ
            if (globalEffects.thunderCloud.active) {
                if (now > globalEffects.thunderCloud.endTime) {
                    globalEffects.thunderCloud.active = false;
                } else {
                    // æ›´æ–°é—ªç”µæ—¶é—´
                    if (now > globalEffects.thunderCloud.flashTime) {
                        globalEffects.thunderCloud.flashTime = now + 1000 + Math.random() * 2000;
                    }
                }
            }
            
            // æ–°å¢æ•ˆæœæ›´æ–°
            // ä¸æ­»å›¾è…¾æ•ˆæœ
            if (globalEffects.immortalTotem.active) {
                if (now > globalEffects.immortalTotem.endTime) {
                    globalEffects.immortalTotem.active = false;
                    globalEffects.immortalTotem.triggeredBy = null;
                    
                    // ç»“æŸRGBå˜è‰²æ•ˆæœ
                    const triggeredBy = globalEffects.immortalTotem.triggeredBy;
                    if (triggeredBy === 'player') {
                        player.glowEffect = false;
                        player.glowEndTime = 0;
                    } else if (triggeredBy === 'computer') {
                        computer.glowEffect = false;
                        computer.glowEndTime = 0;
                    }
                }
            }
            
            // äº‹ä»¶ç‹‚æ½®æ•ˆæœ
            if (globalEffects.eventFrenzy.active) {
                if (now > globalEffects.eventFrenzy.endTime) {
                    globalEffects.eventFrenzy.active = false;
                }
            }
            
            // å¤©å ‚åˆ¶é€ æ•ˆæœ
            if (globalEffects.heavenMaker.active) {
                if (now > globalEffects.heavenMaker.endTime) {
                    // æ¢å¤çƒçš„å¤§å°å’Œé€Ÿåº¦
                    for (let i = 0; i < globalEffects.heavenMaker.stackCount; i++) {
                        ball.radius = Math.min(ball.radius * 2, 50); // æ¢å¤å¤§å°
                        ball.speedMultiplier /= 1.25; // æ¢å¤é€Ÿåº¦
                    }
                    globalEffects.heavenMaker.active = false;
                    globalEffects.heavenMaker.stackCount = 0;
                }
            }
            
            // æ²‰é‡æ•ˆæœ
            if (globalEffects.heavyBall.active) {
                if (now > globalEffects.heavyBall.endTime) {
                    // æ¢å¤çƒçš„å¤§å°å’Œé€Ÿåº¦
                    for (let i = 0; i < globalEffects.heavyBall.stackCount; i++) {
                        ball.radius = Math.max(ball.radius * 0.5, 3); // æ¢å¤å¤§å°
                        ball.speedMultiplier /= 0.8; // æ¢å¤é€Ÿåº¦
                    }
                    globalEffects.heavyBall.active = false;
                    globalEffects.heavyBall.stackCount = 0;
                }
            }
            
            // æ›´æ–°æŒ¡æ¿æ•ˆæœ
            if (now > player.glowEndTime) {
                player.glowEffect = false;
                if (player.height !== player.originalHeight) {
                    player.height = player.originalHeight;
                }
            }
            
            if (now > computer.glowEndTime) {
                computer.glowEffect = false;
                if (computer.height !== computer.originalHeight) {
                    computer.height = computer.originalHeight;
                }
            }

            // æ·»åŠ rgbæ•ˆæœæ›´æ–°
            if (now > player.rgbEndTime) {
                player.rgbEffect = false;
            }

            if (now > computer.rgbEndTime) {
                computer.rgbEffect = false;
            }
        }

        // ç»˜åˆ¶åœ†å½¢ï¼ˆç”¨äºçƒå’Œç²’å­ï¼‰
        function drawCircle(x, y, radius, color, alpha = 1.0) {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2, false);

            // æ·»åŠ å‘å…‰æ•ˆæœ
            const gradient = ctx.createRadialGradient(
                x, y, 0,
                x, y, radius
            );
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, 'rgba(101, 80, 255, 0)');

            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        }

        // ç»˜åˆ¶æŒ¡æ¿
        function drawPaddle(x, y, width, height, color, glowEffect = false, rgbEffect = false) {
            if (rgbEffect) {
                // ä½¿ç”¨RGBæ•ˆæœç»˜åˆ¶æŒ¡æ¿
                drawPaddleRGB(x, y, width, height);
                return;
            }

            ctx.save();
            
            // å¦‚æœæœ‰å‘å…‰æ•ˆæœï¼Œå…ˆç»˜åˆ¶å‘å…‰
            if (glowEffect) {
                ctx.shadowColor = '#ffff00';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
            
            ctx.beginPath();
            ctx.rect(x, y, width, height);

            // åˆ›å»ºæ¸å˜æ•ˆæœ
            const gradient = ctx.createLinearGradient(x, y, x + width, y);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, glowEffect ? '#ffff88' : '#a0a8ff');

            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();

            // æ·»åŠ è¾¹æ¡†å‘å…‰
            ctx.beginPath();
            ctx.rect(x - 2, y - 2, width + 4, height + 4);
            ctx.strokeStyle = glowEffect ? 'rgba(255, 255, 0, 0.8)' : 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = glowEffect ? 2 : 1;
            ctx.stroke();
            ctx.closePath();
            
            ctx.restore();
        }

        // ç»˜åˆ¶RGBæŒ¡æ¿æ•ˆæœ
        function drawPaddleRGB(x, y, width, height) {
            ctx.save();

            // åˆ›å»ºéšæ—¶é—´å˜åŒ–çš„RGBæ•ˆæœ
            const hue = (Date.now() / 5) % 360;
            const color1 = `hsl(${hue}, 100%, 60%)`;
            const color2 = `hsl(${(hue + 120) % 360}, 100%, 60%)`;
            const color3 = `hsl(${(hue + 240) % 360}, 100%, 60%)`;

            // åˆ›å»ºä¸‰è‰²æ¸å˜
            const gradient = ctx.createLinearGradient(x, y, x + width, y + height);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(0.5, color2);
            gradient.addColorStop(1, color3);

            // ç»˜åˆ¶æŒ¡æ¿ä¸»ä½“
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, width, height);

            // æ·»åŠ å‘å…‰è¾¹æ¡†
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#ffffff';
            ctx.shadowBlur = 15;
            ctx.strokeRect(x - 2, y - 2, width + 4, height + 4);

            ctx.restore();
        }

        // ç»˜åˆ¶çƒè½¨è¿¹
        function drawBallTrail() {
            for (let i = 0; i < ball.trail.length; i++) {
                const alpha = (i / ball.trail.length) * ball.alpha;
                const radius = ball.radius * alpha;

                ctx.save();
                ctx.globalAlpha = alpha * 0.6;
                ctx.beginPath();
                ctx.arc(ball.trail[i].x, ball.trail[i].y, radius, 0, Math.PI * 2);
                ctx.fillStyle = ball.color;
                ctx.fill();
                ctx.closePath();
                ctx.restore();
            }
        }

        // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
        function drawGrid() {
            const gridSize = 30;
            ctx.strokeStyle = 'rgba(101, 80, 255, 0.1)';
            ctx.lineWidth = 1;

            // å‚ç›´çº¿
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // æ°´å¹³çº¿
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶ç²’å­
        function drawParticles() {
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];

                // æ›´æ–°ç²’å­ä½ç½®
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;
                p.life--;

                // ç»˜åˆ¶ç²’å­
                ctx.save();
                ctx.globalAlpha = p.life / 30;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.closePath();
                ctx.restore();

                // ç§»é™¤æ­»äº¡ç²’å­
                if (p.life <= 0) {
                    particles.splice(i, 1);
                    i--;
                }
            }
        }

        // ç»˜åˆ¶éšœç¢ç‰©
        function drawObstacles() {
            for (const obs of obstacles) {
                if (!obs.active) {
                    // ç»˜åˆ¶é¢„è­¦æ•ˆæœ
                    const warningSize = obs.size * (1 + obs.warningProgress * 0.5);
                    const alpha = 0.3 + obs.warningProgress * 0.4;

                    ctx.save();
                    ctx.globalAlpha = alpha;
                    ctx.beginPath();
                    if (obs.type === 'circle') {
                        ctx.arc(obs.x, obs.y, warningSize, 0, Math.PI * 2);
                    } else {
                        ctx.rect(
                            obs.x - warningSize / 2,
                            obs.y - warningSize / 2,
                            warningSize,
                            warningSize
                        );
                    }

                    ctx.fillStyle = 'rgba(255, 100, 100, 1)';
                    ctx.fill();
                    ctx.closePath();
                    ctx.restore();
                } else {
                    // ç»˜åˆ¶æ¿€æ´»çš„éšœç¢ç‰©
                    ctx.beginPath();

                    if (obs.type === 'circle') {
                        ctx.arc(obs.x, obs.y, obs.size, 0, Math.PI * 2);
                    } else {
                        ctx.rect(
                            obs.x - obs.size / 2,
                            obs.y - obs.size / 2,
                            obs.size,
                            obs.size
                        );
                    }

                    // åˆ›å»ºæ¸å˜å¡«å……
                    const gradient = ctx.createRadialGradient(
                        obs.x, obs.y, 0,
                        obs.x, obs.y, obs.size
                    );
                    gradient.addColorStop(0, 'rgba(255, 80, 80, 0.8)');
                    gradient.addColorStop(1, 'rgba(200, 50, 50, 0.4)');

                    ctx.fillStyle = gradient;
                    ctx.fill();

                    // æ·»åŠ å‘å…‰è¾¹æ¡†
                    ctx.strokeStyle = 'rgba(255, 150, 150, 0.7)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                }
            }
        }

        // ç»˜åˆ¶äº‹ä»¶
        function drawEvents() {
            for (const event of events) {
                const pulseSize = event.radius * (1 + 0.3 * Math.sin(event.pulsePhase));
                const alpha = 0.8 + 0.2 * Math.sin(event.pulsePhase * 2);
                
                ctx.save();
                ctx.globalAlpha = alpha;
                
                // ç»˜åˆ¶å¤–åœˆå‘å…‰
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = event.typeData.color + '40'; // æ·»åŠ é€æ˜åº¦
                ctx.fill();
                ctx.closePath();
                
                // ç»˜åˆ¶ä¸»ä½“
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize, 0, Math.PI * 2);
                ctx.fillStyle = event.typeData.color;
                ctx.fill();
                ctx.closePath();
                
                // ç»˜åˆ¶è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize, 0, Math.PI * 2);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.closePath();
                
                ctx.restore();
            }
        }

        // ç»˜åˆ¶é›·äº‘
        function drawThunderCloud() {
            if (!globalEffects.thunderCloud.active) return;

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cloudWidth = canvas.width * 0.45;
            const cloudHeight = canvas.height * 0.45;

            ctx.save();

            // åˆå§‹åŒ–çŠ¶æ€ï¼ˆç¡®ä¿å¤šæ¬¡è°ƒç”¨çŠ¶æ€ä¸€è‡´ï¼‰
            if (!globalEffects.thunderCloud.particles) {
                globalEffects.thunderCloud.particles = [];
                globalEffects.thunderCloud.dataStreams = [];
                globalEffects.thunderCloud.lastUpdate = Date.now();
            }

            // æ›´æ–°æ—¶é—´çŠ¶æ€
            const now = Date.now();
            const deltaTime = now - (globalEffects.thunderCloud.lastUpdate || now);
            globalEffects.thunderCloud.lastUpdate = now;

            // æ›´æ–°æ•°æ®æµç²’å­
            updateDataStreams(centerX, centerY, cloudWidth, cloudHeight, deltaTime);

            // ç»˜åˆ¶åŠ¨æ€äº‘æœµï¼ˆä½¿ç”¨å¤šä¸ªå åŠ åœ†å½¢ï¼‰
            drawDynamicCloud(centerX, centerY, cloudWidth, cloudHeight);

            // ç»˜åˆ¶æ•°æ®æµï¼ˆé»‘å®¢é£æ ¼ç»¿è‰²ä»£ç ï¼‰
            drawHackerDataStreams();

            // é—ªç”µæ•ˆæœï¼ˆå¸¦éšæœºåˆ†æ”¯ï¼‰
            const flashActive = now < globalEffects.thunderCloud.flashTime;
            if (flashActive) {
                drawLightningBranches(centerX, centerY, cloudWidth, cloudHeight);
            }

            ctx.restore();
        }

        // è¾…åŠ©å‡½æ•°å®šä¹‰
        function updateDataStreams(centerX, centerY, cloudWidth, cloudHeight, deltaTime) {
            const sec = deltaTime / 1000;

            // æ·»åŠ æ–°ç²’å­ - ä¿®æ”¹ä»¥ä¸‹å‚æ•°
            if (globalEffects.thunderCloud.dataStreams.length < 30 && Math.random() > 0.7) {
                globalEffects.thunderCloud.dataStreams.push({
                    x: centerX + (Math.random() - 0.5) * cloudWidth,
                    y: centerY - cloudHeight * 0.6, // ä»æ›´ä¸Šæ–¹å¼€å§‹ï¼ˆåŸæ¥æ˜¯ - cloudHeight/2ï¼‰
                    chars: generateRandomBinary(3 + Math.floor(Math.random() * 4)), // ç¼©çŸ­æ•°æ®æµé•¿åº¦ï¼ˆ3-6ä¸ªå­—ç¬¦ï¼‰
                    speed: 50 + Math.random() * 50, // åŠ å¿«é€Ÿåº¦ï¼ˆ50-100ï¼‰
                    alpha: 0.1 + Math.random() * 0.4, // é™ä½é€æ˜åº¦ï¼ˆ0.1-0.5ï¼‰
                    life: 1 + Math.random() * 1.5 // æ›´å¿«æ¶ˆå¤±ï¼ˆ1-2.5ç§’ï¼‰
                });
            }

            // æ›´æ–°ç°æœ‰ç²’å­
            globalEffects.thunderCloud.dataStreams.forEach((stream, index) => {
                stream.y += stream.speed * sec;
                stream.life -= sec;

                // ç§»é™¤å±å¹•å¤–æˆ–ç”Ÿå‘½å‘¨æœŸç»“æŸçš„ç²’å­
                if (stream.y > centerY + cloudHeight || stream.life <= 0) {
                    globalEffects.thunderCloud.dataStreams.splice(index, 1);
                }
            });
        }

        function drawDynamicCloud(centerX, centerY, cloudWidth, cloudHeight) {
            ctx.globalAlpha = 0.3;

            // åˆ›å»ºå¤šå±‚äº‘æœµæ•ˆæœ
            for (let i = 0; i < 15; i++) {
                const radius = cloudWidth * 0.1 + Math.random() * cloudWidth * 0.1;
                const x = centerX + (Math.random() - 0.5) * cloudWidth * 0.8;
                const y = centerY + (Math.random() - 0.5) * cloudHeight * 0.8;

                const gradient = ctx.createRadialGradient(
                    x, y, 0,
                    x, y, radius
                );

                // èµ›åšæœ‹å…‹é£æ ¼æ¸å˜
                gradient.addColorStop(0, 'rgba(0, 100, 50, 0.6)');
                gradient.addColorStop(1, 'rgba(0, 20, 10, 0.1)');

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }

        function drawHackerDataStreams() {
            ctx.font = '10px "Courier New", monospace';
            ctx.textAlign = 'left';

            globalEffects.thunderCloud.dataStreams.forEach(stream => {
                ctx.save();
                ctx.globalAlpha = stream.alpha;
                ctx.fillStyle = '#00FF66';

                // ç»˜åˆ¶äºŒè¿›åˆ¶æ•°æ®æµ
                stream.chars.split('').forEach((char, i) => {
                    ctx.fillText(char, stream.x, stream.y + i * 12);
                });

                ctx.restore();
            });
        }

        function drawLightningBranches(centerX, centerY, cloudWidth, cloudHeight) {
            ctx.globalAlpha = 0.6;

            // ç”Ÿæˆä¸»é—ªç”µè·¯å¾„
            const path = generateLightningPath(
                centerX + (Math.random() - 0.5) * cloudWidth * 0.5,
                centerY - cloudHeight * 0.4,
                centerX + (Math.random() - 0.5) * cloudWidth * 0.5,
                centerY + cloudHeight * 0.4
            );

            // ç»˜åˆ¶ä¸»é—ªç”µ
            drawLightning(path, 3);

            // ç”Ÿæˆåˆ†æ”¯é—ªç”µï¼ˆ1-3ä¸ªï¼‰
            const branchCount = 1 + Math.floor(Math.random() * 3);
            for (let i = 0; i < branchCount; i++) {
                const branchPoint = path[Math.floor(path.length * (i + 1) / (branchCount + 1))];
                const branchPath = generateLightningPath(
                    branchPoint.x,
                    branchPoint.y,
                    branchPoint.x + (Math.random() - 0.5) * cloudWidth * 0.3,
                    branchPoint.y + cloudHeight * 0.2
                );
                drawLightning(branchPath, 2);
            }
        }

        function generateLightningPath(startX, startY, endX, endY) {
            const segments = 8;
            const path = [{x: startX, y: startY}];
            const variance = canvas.width * 0.05;

            for (let i = 1; i <= segments; i++) {
                const t = i / segments;
                const baseX = startX + (endX - startX) * t;
                const baseY = startY + (endY - startY) * t;

                path.push({
                    x: baseX + (Math.random() - 0.5) * variance * (1 - t),
                    y: baseY + (Math.random() - 0.5) * variance * (1 - t)
                });
            }

            path.push({x: endX, y: endY});
            return path;
        }

        function drawLightning(path, lineWidth) {
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);

            // åˆ›å»ºé—ªç”µæŠ–åŠ¨æ•ˆæœ
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }

            // èµ›åšæœ‹å…‹é£æ ¼å‘å…‰æ•ˆæœ
            ctx.strokeStyle = '#66FFFF';
            ctx.lineWidth = lineWidth;
            ctx.shadowColor = '#00FF99';
            ctx.shadowBlur = 15;
            ctx.stroke();

            // é‡ç½®é˜´å½±
            ctx.shadowBlur = 0;
        }

        function generateRandomBinary(length) {
            return Array.from({length}, () => Math.random() > 0.5 ? '1' : '0').join('');
        }

        // é‡ç½®çƒä½ç½®
        function resetBall() {
            // ä¿å­˜åŸå§‹é€Ÿåº¦æ–¹å‘
            const originalVelocityX = ball.velocityX;
            const originalVelocityY = ball.velocityY;

            // é‡ç½®çƒä½ç½®å’Œé€Ÿåº¦
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 4;
            ball.velocityX = Math.random() > 0.5 ? 5 : -5;
            ball.velocityY = Math.random() * 4 - 2;
            ball.trail = [];
            isResetting = false;

            // é‡ç½®æ­»çƒæ£€æµ‹
            ballStuckDetection.lastY = ball.y;
            ballStuckDetection.stuckTime = 0;
            ballStuckDetection.lastCheckTime = Date.now();

            // é˜²æ­¢çƒåœ¨éšœç¢ç‰©ä¸Šé‡ç”Ÿ
            let safePositionFound = false;
            let attempts = 0;
            const maxAttempts = 30;
            const safeRadius = ball.radius * 2; // å®‰å…¨è·ç¦»åŠå¾„

            while (!safePositionFound && attempts < maxAttempts) {
                // æ–¹æ³•1ï¼šå°è¯•åœ¨ä¸­å¿ƒé™„è¿‘éšæœºä½ç½®ç”Ÿæˆ
                if (attempts < 20) {
                    ball.x = canvas.width / 2 + (Math.random() - 0.5) * (canvas.width / 4);
                    ball.y = canvas.height / 2 + (Math.random() - 0.5) * (canvas.height / 4);
                }
                // æ–¹æ³•2ï¼šå‘é‡å åŠ è°ƒæ•´ï¼ˆå‰20æ¬¡å¤±è´¥åå¯ç”¨ï¼‰
                else {
                    let totalDx = 0;
                    let totalDy = 0;
                    let collisionCount = 0;

                    for (const obs of obstacles) {
                        if (obs.active && obstacleCollision(ball, obs)) {
                            const dx = ball.x - obs.x;
                            const dy = ball.y - obs.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const minDistance = ball.radius + obs.size + safeRadius;

                            if (distance < minDistance) {
                                const angle = Math.atan2(dy, dx);
                                const moveDistance = minDistance - distance;
                                totalDx += moveDistance * Math.cos(angle);
                                totalDy += moveDistance * Math.sin(angle);
                                collisionCount++;
                            }
                        }
                    }

                    if (collisionCount > 0) {
                        // æ ‡å‡†åŒ–æ€»ä½ç§»å‘é‡
                        const totalMove = Math.sqrt(totalDx * totalDx + totalDy * totalDy);
                        ball.x += (totalDx / collisionCount) * 1.2;
                        ball.y += (totalDy / collisionCount) * 1.2;
                    }
                }

                // è¾¹ç•Œæ£€æŸ¥
                ball.x = Math.max(ball.radius, Math.min(canvas.width - ball.radius, ball.x));
                ball.y = Math.max(ball.radius, Math.min(canvas.height - ball.radius, ball.y));

                // æœ€ç»ˆç¢°æ’æ£€æŸ¥
                safePositionFound = true;
                for (const obs of obstacles) {
                    if (obs.active && obstacleCollision(ball, obs)) {
                        safePositionFound = false;
                        break;
                    }
                }

                attempts++;
            }
        }

        // ç¢°æ’æ£€æµ‹ - æŒ¡æ¿
        function collision(b, p) {
            return (
                b.x + b.radius > p.x &&
                b.x - b.radius < p.x + p.width &&
                b.y + b.radius > p.y &&
                b.y - b.radius < p.y + p.height
            );
        }

        // ç¢°æ’æ£€æµ‹ - éšœç¢ç‰©
        function obstacleCollision(ball, obstacle) {
            if (!obstacle.active) return false;

            if (obstacle.type === 'circle') {
                // åœ†å½¢éšœç¢ç‰©ç¢°æ’æ£€æµ‹
                const dx = ball.x - obstacle.x;
                const dy = ball.y - obstacle.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                return distance < ball.radius + obstacle.size;
            } else {
                // çŸ©å½¢éšœç¢ç‰©ç¢°æ’æ£€æµ‹
                const halfSize = obstacle.size / 2;
                const closestX = Math.max(obstacle.x - halfSize, Math.min(ball.x, obstacle.x + halfSize));
                const closestY = Math.max(obstacle.y - halfSize, Math.min(ball.y, obstacle.y + halfSize));

                const dx = ball.x - closestX;
                const dy = ball.y - closestY;

                return (dx * dx + dy * dy) < (ball.radius * ball.radius);
            }
        }

        // ç¢°æ’æ£€æµ‹ - äº‹ä»¶
        function eventCollision(ball, event) {
            const dx = ball.x - event.x;
            const dy = ball.y - event.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < ball.radius + event.radius;
        }

        // å¤„ç†çƒä¸éšœç¢ç‰©çš„ç¢°æ’
        function handleObstacleCollision() {
            for (const obs of obstacles) {
                if (obstacleCollision(ball, obs)) {
                    // åˆ›å»ºç¢°æ’ç²’å­
                    createParticles(ball.x, ball.y, '#ff6666', 30);

                    if (obs.type === 'circle') {
                        // åœ†å½¢éšœç¢ç‰©ç¢°æ’åå¼¹
                        const dx = ball.x - obs.x;
                        const dy = ball.y - obs.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // æ³•çº¿å‘é‡
                        const nx = dx / distance;
                        const ny = dy / distance;

                        // è®¡ç®—ç‚¹ç§¯
                        const dot = ball.velocityX * nx + ball.velocityY * ny;

                        // åå°„å‘é‡
                        ball.velocityX = ball.velocityX - 2 * dot * nx;
                        ball.velocityY = ball.velocityY - 2 * dot * ny;
                    } else {
                        // çŸ©å½¢éšœç¢ç‰©ç¢°æ’åå¼¹
                        const halfSize = obs.size / 2;

                        // è®¡ç®—çƒç›¸å¯¹äºéšœç¢ç‰©ä¸­å¿ƒçš„å‘é‡
                        const dx = ball.x - obs.x;
                        const dy = ball.y - obs.y;

                        // åˆ¤æ–­ç¢°æ’å‘ç”Ÿåœ¨çŸ©å½¢çš„å“ªä¸€ä¾§
                        if (Math.abs(dx) > Math.abs(dy)) {
                            // æ°´å¹³ç¢°æ’
                            ball.velocityX = -ball.velocityX;

                            // è°ƒæ•´ä½ç½®é˜²æ­¢å¡ä½
                            if (dx > 0) {
                                ball.x = obs.x + halfSize + ball.radius;
                            } else {
                                ball.x = obs.x - halfSize - ball.radius;
                            }
                        } else {
                            // å‚ç›´ç¢°æ’
                            ball.velocityY = -ball.velocityY;

                            // è°ƒæ•´ä½ç½®é˜²æ­¢å¡ä½
                            if (dy > 0) {
                                ball.y = obs.y + halfSize + ball.radius;
                            } else {
                                ball.y = obs.y - halfSize - ball.radius;
                            }
                        }
                    }

                    // å¢åŠ çƒé€Ÿ
                    ball.speed += 0.025;

                    // è®°å½•ç¢°æ’æ—¶é—´
                    ball.lastCollision = Date.now();

                    return true;
                }
            }
            return false;
        }

        // å¤„ç†çƒä¸äº‹ä»¶çš„ç¢°æ’
        function handleEventCollision() {
            for (let i = events.length - 1; i >= 0; i--) {
                const event = events[i];
                if (eventCollision(ball, event)) {
                    // è§¦å‘äº‹ä»¶æ•ˆæœ
                    if (lastTouchedBy) {
                        triggerEvent(event, lastTouchedBy);
                    }
                    
                    // ç§»é™¤äº‹ä»¶
                    events.splice(i, 1);
                    return true;
                }
            }
            return false;
        }

        // å¤„ç†é›·äº‘å¯¹çƒçš„å½±å“
        function handleThunderCloudEffect() {
            if (!globalEffects.thunderCloud.active) return;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cloudWidth = canvas.width * 0.3;
            const cloudHeight = canvas.height * 0.3;
            
            // æ£€æŸ¥çƒæ˜¯å¦åœ¨é›·äº‘åŒºåŸŸå†…
            if (ball.x > centerX - cloudWidth / 2 && 
                ball.x < centerX + cloudWidth / 2 &&
                ball.y > centerY - cloudHeight / 2 && 
                ball.y < centerY + cloudHeight / 2) {
                
                // éšæœºæ”¹å˜çƒçš„è§’åº¦ -10åˆ°10åº¦
                const angleChange = (Math.random() - 0.5) * 20 * Math.PI / 180;
                const currentAngle = Math.atan2(ball.velocityY, ball.velocityX);
                const newAngle = currentAngle + angleChange;
                const speed = Math.sqrt(ball.velocityX * ball.velocityX + ball.velocityY * ball.velocityY);
                
                ball.velocityX = speed * Math.cos(newAngle);
                ball.velocityY = speed * Math.sin(newAngle);
                
                // è§¦å‘é—ªç”µæ•ˆæœ
                globalEffects.thunderCloud.flashTime = Date.now() + 200;
            }
        }

        // æ£€æŸ¥çƒæ˜¯å¦å¡åœ¨éšœç¢ç‰©ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ ¡æ­£ä½ç½®
        function correctBallPosition() {
            for (const obs of obstacles) {
                if (!obs.active) continue;

                // è®¡ç®—çƒä¸éšœç¢ç‰©çš„è·ç¦»å’Œæ–¹å‘
                const dx = ball.x - obs.x;
                const dy = ball.y - obs.y;

                if (obs.type === 'circle') {
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDistance = ball.radius + obs.size;

                    if (distance < minDistance) {
                        // è®¡ç®—éœ€è¦ç§»åŠ¨çš„æ–¹å‘
                        const angle = Math.atan2(dy, dx);
                        const moveDistance = minDistance - distance;

                        // å°†çƒç§»åŠ¨åˆ°éšœç¢ç‰©è¾¹ç¼˜
                        ball.x += Math.cos(angle) * moveDistance;
                        ball.y += Math.sin(angle) * moveDistance;
                    }
                } else {
                    // çŸ©å½¢éšœç¢ç‰©å¤„ç†
                    const halfSize = obs.size / 2;
                    const overlapX = Math.abs(dx) - (ball.radius + halfSize);
                    const overlapY = Math.abs(dy) - (ball.radius + halfSize);

                    if (overlapX < 0 && overlapY < 0) {
                        // ç¡®å®šæœ€å°é‡å æ–¹å‘
                        if (Math.abs(overlapX) < Math.abs(overlapY)) {
                            // Xè½´æ–¹å‘é‡å è¾ƒå°ï¼Œæ²¿Xè½´ç§»åŠ¨
                            ball.x += dx > 0 ? -overlapX : overlapX;
                        } else {
                            // Yè½´æ–¹å‘é‡å è¾ƒå°ï¼Œæ²¿Yè½´ç§»åŠ¨
                            ball.y += dy > 0 ? -overlapY : overlapY;
                        }
                    }
                }
            }
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function update(dt) {
            if (isGameOver || isPaused) return; // æ·»åŠ æš‚åœæ£€æŸ¥

            // æ›´æ–°æ¸¸æˆæ—¶é—´ï¼ˆæ¯å¸§çº¦16msï¼‰
            gameTime += dt;

            // æ­»çƒæ£€æµ‹
            if (checkDeadBall()) {
                showDeadBallNotification();
                resetBall();
                // é‡ç½®çƒä½†ä¸è®¡åˆ†
                return;
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ–°éšœç¢ç‰©
            let obstacleInterval = 15000; // é»˜è®¤15ç§’
            if (globalEffects.obstacleSpeedUp.active) {
                obstacleInterval *= 0.2; // å‡å°‘åˆ°20%
            }

            if (gameTime >= nextObstacleTime) {
                createObstacles();
                nextObstacleTime = gameTime + obstacleInterval + Math.random() * 5000;
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ–°äº‹ä»¶
            if (gameTime >= nextEventTime) {
                createEvent();
                // è®¾ç½®ä¸‹ä¸€æ¬¡äº‹ä»¶å‡ºç°æ—¶é—´ï¼š5-30ç§’å
                let eventInterval = 5000 + Math.random() * 25000;
<!--                let eventInterval = 5000-->

                // äº‹ä»¶ç‹‚æ½®æ•ˆæœï¼šäº‹ä»¶åˆ·æ–°ç‡å¢åŠ ä¸º400%
                if (globalEffects.eventFrenzy.active) {
                    eventInterval *= 0.25; // å‡å°‘åˆ°25%ï¼Œå³400%çš„åˆ·æ–°ç‡
                }

                nextEventTime = gameTime + eventInterval;
            }

            // æ›´æ–°å„ç§çŠ¶æ€
            updateObstacles();
            updateEvents();
            updateGlobalEffects();

            // æ£€æŸ¥å¹¶æ ¡æ­£çƒçš„ä½ç½®ï¼Œé˜²æ­¢å¡åœ¨éšœç¢ç‰©ä¸­
            correctBallPosition();

            // æ›´æ–°çƒè½¨è¿¹
            ball.trail.push({x: ball.x, y: ball.y});
            if (ball.trail.length > 10) {
                ball.trail.shift();
            }

            // ç§»åŠ¨çƒ
            const effectiveSpeed = ball.speed * ball.speedMultiplier;
            const velocityMagnitude = Math.sqrt(ball.velocityX * ball.velocityX + ball.velocityY * ball.velocityY);
            ball.x += (ball.velocityX / velocityMagnitude) * effectiveSpeed * (dt / FRAME_INTERVAL);
            ball.y += (ball.velocityY / velocityMagnitude) * effectiveSpeed * (dt / FRAME_INTERVAL);

            // ç®€å•çš„ç”µè„‘AI - è·Ÿéšçƒç§»åŠ¨
            const effectiveComputerSpeed = computer.speed * computer.speedMultiplier;
            if (computer.y + (computer.height / 2) < ball.y) {
                computer.y += effectiveComputerSpeed;
            } else {
                computer.y -= effectiveComputerSpeed;
            }

            // ç¡®ä¿ç”µè„‘æŒ¡æ¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
            if (computer.y < 0) {
                computer.y = 0;
            } else if (computer.y + computer.height > canvas.height) {
                computer.y = canvas.height - computer.height;
            }

            // ç¡®ä¿ç©å®¶æŒ¡æ¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
            if (player.y < 0) {
                player.y = 0;
            } else if (player.y + player.height > canvas.height) {
                player.y = canvas.height - player.height;
            }

            // ä¸Šä¸‹è¾¹ç•Œåå¼¹
            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
                ball.velocityY = -ball.velocityY;

                // è¾¹ç•Œç¢°æ’ç²’å­æ•ˆæœ
                createParticles(
                    ball.x,
                    ball.y < ball.radius ? 0 : canvas.height,
                    '#ffffff'
                );
            }

            // å¤„ç†é›·äº‘æ•ˆæœ
            handleThunderCloudEffect();

            // å¤„ç†çƒä¸äº‹ä»¶çš„ç¢°æ’
            const hitEvent = handleEventCollision();

            // å¤„ç†çƒä¸éšœç¢ç‰©çš„ç¢°æ’
            const hitObstacle = handleObstacleCollision();

            // å¦‚æœæ²¡æœ‰ç¢°åˆ°éšœç¢ç‰©æˆ–äº‹ä»¶ï¼Œæ£€æŸ¥æŒ¡æ¿ç¢°æ’
            if (!hitObstacle && !hitEvent) {
                // ç¡®å®šçƒä¸å“ªä¸ªæŒ¡æ¿ç¢°æ’
                const paddle = ball.x < canvas.width / 2 ? player : computer;
                const paddleOwner = ball.x < canvas.width / 2 ? 'player' : 'computer';
                const currentTime = Date.now();

                // æ·»åŠ é˜²å¡é¡¿æœºåˆ¶ï¼šåŒä¸€æŒ¡æ¿åœ¨50mså†…åªå…è®¸ç¢°æ’ä¸€æ¬¡
                if (collision(ball, paddle) && currentTime - ball.lastCollision > 50) {
                    // è®°å½•è§¦çƒè€…
                    lastTouchedBy = paddleOwner;

                    // çƒå‡»ä¸­æŒ¡æ¿çš„ä½ç½®ï¼ˆä»-0.5åˆ°0.5ï¼‰
                    const hitPoint = (ball.y - (paddle.y + paddle.height / 2)) / (paddle.height / 2);

                    // è®¡ç®—åå¼¹è§’åº¦ï¼ˆåŸºäºå‡»ä¸­ä½ç½®ï¼‰
                    let angle = hitPoint * (Math.PI / 4);

                    // ç”µè„‘å›çƒå¢å¼ºåŠŸèƒ½
                    if (aiEnhancementEnabled && paddleOwner === 'computer') {
                        // ç”Ÿæˆ-75åˆ°75åº¦çš„éšæœºè§’åº¦
                        const randomAngle = (Math.random() - 0.5) * (120 * Math.PI / 180); // -60åˆ°60åº¦è½¬æ¢ä¸ºå¼§åº¦
                        angle = randomAngle;
                    }

                    // ç¡®å®šæ–¹å‘
                    const direction = ball.x < canvas.width / 2 ? 1 : -1;

                    // æ›´æ–°çƒçš„é€Ÿåº¦
                    ball.velocityX = direction * ball.speed * Math.cos(angle);
                    ball.velocityY = ball.speed * Math.sin(angle);

                    // å¢åŠ çƒé€Ÿ
                    ball.speed += 0.025;

                    // é›·ç”µæ¿å­æ•ˆæœ
                    if (paddle.glowEffect) {
                        ball.speed *= 1.8; // å¢åŠ 80%é€Ÿåº¦
                        setTimeout(() => {
                            ball.speed /= 1.8; // 0.8ç§’åæ¢å¤
                        }, 800);
                    }

                    // åˆ›å»ºç¢°æ’ç²’å­
                    createParticles(ball.x, ball.y, paddle.color);

                    // è®°å½•ç¢°æ’æ—¶é—´
                    ball.lastCollision = currentTime;

                    // é˜²æ­¢çƒå¡åœ¨æŒ¡æ¿å†…
                    if (direction === 1) {
                        ball.x = paddle.x + paddle.width + ball.radius + 1;
                    } else {
                        ball.x = paddle.x - ball.radius - 1;
                    }
                }
            }

            // è®¡åˆ†
            if (!isResetting && (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width)) {
                isResetting = true;
                let shouldScore = true;
                let scoringPlayer = null;

                if (ball.x - ball.radius < 0) {
                    scoringPlayer = 'computer';
                } else {
                    scoringPlayer = 'player';
                }

                // æ£€æŸ¥ä¸æ­»å›¾è…¾æ•ˆæœ
                if (globalEffects.immortalTotem.active) {
                    const triggeredBy = globalEffects.immortalTotem.triggeredBy;

                    // å¦‚æœè§¦å‘æ–¹å¤±çƒï¼Œä¸è®¡åˆ†ä½†ç»“æŸä¸æ­»å›¾è…¾æ•ˆæœ
                    if ((scoringPlayer === 'computer' && triggeredBy === 'player') ||
                        (scoringPlayer === 'player' && triggeredBy === 'computer')) {
                        shouldScore = false;

                        // ç»“æŸä¸æ­»å›¾è…¾æ•ˆæœ
                        globalEffects.immortalTotem.active = false;
                        globalEffects.immortalTotem.endTime = 0;
                        globalEffects.immortalTotem.triggeredBy = null;

                        // ç»“æŸè§¦å‘æ–¹çš„RGBå˜è‰²æ•ˆæœ
                        if (triggeredBy === 'player') {
                            player.rgbEffect = false; // ä½¿ç”¨rgbEffect
                            player.rgbEndTime = 0;
                        } else {
                            computer.rgbEffect = false; // ä½¿ç”¨rgbEffect
                            computer.rgbEndTime = 0;
                        }

                        // æ˜¾ç¤ºä¸æ­»å›¾è…¾è§¦å‘é€šçŸ¥
                        const notification = document.createElement('div');
                        notification.className = 'event-notification positive';
                        notification.innerHTML = `
                            <div class="event-trigger">ä¸æ­»å›¾è…¾è§¦å‘</div>
                            <div class="event-title">æ˜¯ä¸æ­»å›¾è…¾ç¢è£‚çš„å£°éŸ³ï¼</div>
                            <div class="event-description">æœ¬æ¬¡å¤±çƒä¸è®¡åˆ†ï¼Œæ•ˆæœå·²ç»“æŸ</div>
                        `;
                        document.body.appendChild(notification);
                        setTimeout(() => {
                            notification.classList.add('show');
                        }, 100);
                        setTimeout(() => {
                            notification.classList.remove('show');
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            }, 500);
                        }, 3000);
                    }
                }

                // æ­£å¸¸è®¡åˆ†
                if (shouldScore) {
                    if (scoringPlayer === 'computer') {
                        computerScore++;
                        computerScoreElement.textContent = computerScore;
                        createScoreEffect(false); // ç”µè„‘å¾—åˆ†ç‰¹æ•ˆ
                    } else {
                        playerScore++;
                        playerScoreElement.textContent = playerScore;
                        createScoreEffect(true); // ç©å®¶å¾—åˆ†ç‰¹æ•ˆ
                    }
                }

                // é‡ç½®ç”µè„‘é€Ÿåº¦å€æ•°ï¼ˆè¿›çƒåé‡ç½®ï¼‰
                computer.speedMultiplier = 1.0;

                // åˆ›å»ºå¾—åˆ†ç²’å­æ•ˆæœ
                createParticles(
                    ball.x,
                    ball.y,
                    ball.x - ball.radius < 0 ? computer.color : player.color,
                    30
                );

                // å»¶è¿Ÿåé‡ç½®çƒ
                setTimeout(() => {
                    resetBall();
                }, 1000);
            }

            // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
            if (!isGameOver && (playerScore >= 3 || computerScore >= 3)) {
                isGameOver = true;
                if (playerScore >= 3) {
                    victoryMessage.textContent = `ç©å®¶è·èƒœï¼`;
                } else {
                    // è·å–å½“å‰é€‰ä¸­çš„éš¾åº¦åç§°
                    const activeOption = document.querySelector('.difficulty-option.active');
                    const difficultyName = activeOption ? activeOption.textContent : 'ç”µè„‘';
                    victoryMessage.textContent = `${difficultyName}è·èƒœï¼`;
                }
                victoryOverlay.style.opacity = '1';
                victoryOverlay.style.pointerEvents = 'auto';
            }

            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // åŠé€æ˜èƒŒæ™¯ï¼ˆåˆ›é€ æ‹–å°¾æ•ˆæœï¼‰
            ctx.fillStyle = 'rgba(8, 12, 33, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
            drawGrid();

            // ç»˜åˆ¶é›·äº‘æ•ˆæœ
            drawThunderCloud();

            // ç»˜åˆ¶éšœç¢ç‰©
            drawObstacles();

            // ç»˜åˆ¶äº‹ä»¶
            drawEvents();

            // ç»˜åˆ¶çƒè½¨è¿¹
            drawBallTrail();

            // ç»˜åˆ¶ç²’å­
            drawParticles();

            // ç»˜åˆ¶ä¸­é—´è™šçº¿
            ctx.beginPath();
            ctx.setLineDash([10, 15]);
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.strokeStyle = 'rgba(101, 80, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶æŒ¡æ¿
            drawPaddle(player.x, player.y, player.width, player.height, player.color, player.glowEffect, player.rgbEffect);
            drawPaddle(computer.x, computer.y, computer.width, computer.height, computer.color, computer.glowEffect, computer.rgbEffect);


            // ç»˜åˆ¶çƒ
            drawCircle(ball.x, ball.y, ball.radius, ball.color, ball.alpha);

            // ç»˜åˆ¶çƒå†…éƒ¨å…‰ç‚¹
            ctx.save();
            ctx.globalAlpha = ball.alpha;
            ctx.beginPath();
            ctx.arc(ball.x - 3, ball.y - 3, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            // çƒçŠ¶æ€
            document.getElementById('debug-ball-speed').textContent = ball.speed.toFixed(2);
            document.getElementById('debug-ball-position').textContent = `${Math.round(ball.x)},${Math.round(ball.y)}`;
            document.getElementById('debug-ball-alpha').textContent = ball.alpha.toFixed(2);

            // ç”µè„‘æ•°æ®
            document.getElementById('debug-computer-speed').textContent = computer.speed.toFixed(2);
            document.getElementById('debug-computer-position').textContent = Math.round(computer.y);
            document.getElementById('debug-computer-multiplier').textContent = computer.speedMultiplier.toFixed(2);

            // äº‹ä»¶çŠ¶æ€
            let activeEvents = 0;
            if (globalEffects.speedVariation.active) activeEvents++;
            if (globalEffects.obstacleSpeedUp.active) activeEvents++;
            if (globalEffects.thunderCloud.active) activeEvents++;
            if (player.glowEffect) activeEvents++;
            if (computer.speedMultiplier !== 1.0) activeEvents++;
            
            document.getElementById('debug-active-events').textContent = activeEvents;
            document.getElementById('debug-obstacles').textContent = obstacles.length;

            // ç³»ç»Ÿä¿¡æ¯
            const currentFps = Math.round(1000 / (deltaTime || 16.67));
            document.getElementById('debug-fps').textContent = currentFps;
            document.getElementById('debug-game-time').textContent = `${Math.round(gameTime / 1000)}s`;
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop(timestamp) {
            // è®¡ç®—æ—¶é—´å·®
            if (lastTime === 0) lastTime = timestamp;
            deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            accumulatedTime += deltaTime;
            // æ›´æ–°FPSè®¡æ•°
            frameCount++;
            if (timestamp - lastFpsUpdate >= 1000) {
                const fps = Math.round(frameCount * 1000 / (timestamp - lastFpsUpdate));
                console.log(`FPS: ${fps}`);
                frameCount = 0;
                lastFpsUpdate = timestamp;
            }
            // æ‰§è¡Œå›ºå®šæ¬¡æ•°çš„æ›´æ–°ï¼ˆæ—¶é—´è¡¥å¿ï¼‰
            while (accumulatedTime >= FRAME_INTERVAL) {
                update(FRAME_INTERVAL);
                accumulatedTime -= FRAME_INTERVAL;
            }
            draw();
            requestAnimationFrame(gameLoop);
        }

        // å¯åŠ¨æ¸¸æˆ
        lastTime = 0;
        accumulatedTime = 0;
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
