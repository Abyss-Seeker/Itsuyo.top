<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Cyberpongk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, 'Microsoft YaHei', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0c1027, #1a1f4b, #0c1027);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow: hidden;
            color: #e1e6ff;
            padding: 20px;
        }

        /* Êñ∞Â¢ûÂºÄÂßãÈ°µÈù¢Ê†∑Âºè */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(8, 15, 32, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .start-screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        .start-container {
            width: 100%;
            max-width: 700px;
            padding: 30px;
            background: rgba(12, 22, 45, 0.85);
            border: 1px solid rgba(101, 80, 255, 0.3);
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(101, 80, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .start-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg,
                transparent 0%,
                rgba(101, 80, 255, 0.1) 50%,
                transparent 100%);
            animation: scanLine 8s linear infinite;
            z-index: -1;
        }

        .start-title {
            text-align: center;
            font-size: 3.5rem;
            color: #e1e6ff;
            text-shadow: 0 0 20px rgba(101, 80, 255, 0.8);
            margin-bottom: 20px;
            letter-spacing: 3px;
            font-weight: 800;
            position: relative;
        }

        .start-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #6550ff, transparent);
        }

        .start-subtitle {
            text-align: center;
            color: #a0a8ff;
            font-size: 1.2rem;
            margin-bottom: 40px;
            max-width: 600px;
            line-height: 1.6;
        }

        .start-options {
            margin-bottom: 40px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-title {
            font-size: 1.4rem;
            color: #e1e6ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .option-title::before {
            content: '‚ñ∂';
            color: #ffcc00;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .difficulty-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .start-difficulty-option {
            background: rgba(16, 24, 48, 0.7);
            border: 1px solid rgba(101, 80, 255, 0.3);
            color: #e1e6ff;
            padding: 12px 5px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .start-difficulty-option:hover {
            background: rgba(101, 80, 255, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(101, 80, 255, 0.3);
        }

        .start-difficulty-option.active {
            background: rgba(101, 80, 255, 0.6);
            border-color: #6550ff;
            box-shadow: 0 0 15px rgba(101, 80, 255, 0.5);
        }

        .ai-toggle-container {
            display: flex;
            align-items: center;
            background: rgba(16, 24, 48, 0.7);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .ai-toggle-container:hover {
            background: rgba(255, 165, 0, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.2);
        }

        .ai-toggle-label {
            flex-grow: 1;
            font-size: 1.1rem;
            color: #e1e6ff;
        }

        .ai-toggle {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .ai-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ai-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 68, 68, 0.5);
            transition: .4s;
            border-radius: 30px;
        }

        .ai-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: #e1e6ff;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .ai-toggle-slider {
            background-color: rgba(0, 200, 83, 0.7);
        }

        input:checked + .ai-toggle-slider:before {
            transform: translateX(30px);
        }

        .start-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            background: linear-gradient(135deg, #6550ff, #8a7cff);
            border: none;
            color: #e1e6ff;
            padding: 15px;
            font-size: 1.4rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .start-button::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg,
                #6550ff, #8a7cff,
                #ffcc00, #ff3366,
                #6550ff, #8a7cff);
            background-size: 300% 300%;
            z-index: -1;
            border-radius: 10px;
            animation: gradientBG 3s ease infinite;
        }

        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(101, 80, 255, 0.6);
        }

        .start-button:active {
            transform: scale(0.98);
        }

        @keyframes scanLine {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            background: rgba(12, 16, 39, 0.8);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(101, 80, 255, 0.3);
            overflow: hidden;
            border: 1px solid rgba(101, 80, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .game-header {
            text-align: center;
            padding: 5px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(101, 80, 255, 0.3);
        }

        .game-title {
            color: #e1e6ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px #6550ff;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .game-subtitle {
            color: #a0a8ff;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            padding: 5px 30px;
            background: rgba(16, 20, 45, 0.7);
            position: relative;
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .player-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #a0a8ff;
        }

        .player-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            position: relative;
        }

        .score-animation {
            position: absolute;
            font-size: 3rem;
            color: #ff3366;
            opacity: 0;
            animation: scorePopup 1s forwards;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 15px rgba(255, 51, 102, 0.7);
        }

        @keyframes scorePopup {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .game-content {
            position: relative;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #game-canvas {
            background: rgba(8, 12, 33, 0.7);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(101, 80, 255, 0.2);
            border: 1px solid rgba(101, 80, 255, 0.2);
        }

        .controls-info {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            color: #a0a8ff;
            background: rgba(16, 20, 45, 0.6);
            border-top: 1px solid rgba(101, 80, 255, 0.2);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            background: #ffcc00;
            opacity: 0.8;
        }

        .center-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: linear-gradient(to bottom,
                transparent 0%,
                rgba(101, 80, 255, 0.5) 10%,
                rgba(101, 80, 255, 0.8) 50%,
                rgba(101, 80, 255, 0.5) 90%,
                transparent 100%);
            transform: translateX(-50%);
        }

        .glow-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            box-shadow: inset 0 0 30px rgba(101, 80, 255, 0.5);
            pointer-events: none;
            z-index: -1;
        }

        .victory-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(12, 16, 39, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .victory-message {
            font-size: 4rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
            margin-bottom: 30px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        .restart-btn {
            background: rgba(101, 80, 255, 0.5);
            border: 2px solid #a0a8ff;
            color: #e1e6ff;
            padding: 12px 35px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .restart-btn:hover {
            background: rgba(101, 80, 255, 0.8);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(101, 80, 255, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
            50% { transform: scale(1.1); text-shadow: 0 0 30px rgba(255, 204, 0, 1); }
            100% { transform: scale(1); text-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }
        }

        .obstacle-warning {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: warningPulse 0.5s infinite alternate;
        }

        @keyframes warningPulse {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 0.7; transform: scale(1.1); }
        }

        /* ‰∫ã‰ª∂ÂºπÁ™óÊ†∑Âºè */
        .event-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid;
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 250px;
            max-width: 350px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.5s ease, opacity 0.5s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .event-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .event-notification.positive {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .event-notification.neutral {
            border-color: #888888;
            box-shadow: 0 0 20px rgba(136, 136, 136, 0.3);
        }

        .event-notification.negative {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #e1e6ff;
        }

        .event-description {
            font-size: 0.9rem;
            color: #a0a8ff;
            line-height: 1.4;
        }

        .event-trigger {
            font-size: 0.8rem;
            color: #ffcc00;
            margin-bottom: 8px;
            font-weight: bold;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ÊöÇÂÅú/ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆÊ†∑Âºè */
        .pause-button {
            position: fixed;
            top: 20px;
            right: 5%;
            transform: translateX(50%);
            background: rgba(101, 80, 255, 0.8);
            border: 2px solid rgba(101, 80, 255, 0.9);
            color: #e1e6ff;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .pause-button:hover {
            background: rgba(101, 80, 255, 1);
            transform: translateX(50%) scale(1.05);
            box-shadow: 0 0 20px rgba(101, 80, 255, 0.6);
        }

        .pause-button.paused {
            background: rgba(255, 68, 68, 0.8);
            border-color: rgba(255, 68, 68, 0.9);
        }

        .pause-button.paused:hover {
            background: rgba(255, 68, 68, 1);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        /* Ë∞ÉËØïÁ™óÂè£Ê†∑Âºè */
        .debug-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid rgba(255, 68, 68, 0.5);
            border-radius: 12px;
            padding: 15px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            overflow: hidden;
        }

        .debug-panel:hover {
            width: 280px;
            height: 420px;
            cursor: default;
        }

        .debug-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff4444;
            transition: opacity 0.3s ease;
        }

        .debug-panel:hover .debug-icon {
            opacity: 0;
        }

        .debug-content {
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            height: 100%;
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
        }

        .debug-panel:hover .debug-content {
            opacity: 1;
        }

        .debug-title {
            color: #e1e6ff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 68, 68, 0.3);
            padding-bottom: 8px;
        }

        .debug-section {
            margin-bottom: 12px;
        }

        .debug-section-title {
            color: #ff4444;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .debug-item {
            color: #a0a8ff;
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
        }

        .debug-label {
            color: #e1e6ff;
        }

        .debug-value {
            color: #ffcc00;
            font-weight: bold;
        }

        /* ÈöæÂ∫¶Ë∞ÉÊï¥Á™óÂè£Ê†∑Âºè */
        .difficulty-panel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(12, 16, 39, 0.95);
            border: 2px solid rgba(101, 80, 255, 0.5);
            border-radius: 12px;
            padding: 15px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            overflow: hidden;
        }

        .difficulty-panel:hover {
            width: 200px;
            height: 320px;
            cursor: default;
        }

        .difficulty-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #6550ff;
            transition: opacity 0.3s ease;
        }

        .difficulty-panel:hover .difficulty-icon {
            opacity: 0;
        }

        .difficulty-content {
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .difficulty-panel:hover .difficulty-content {
            opacity: 1;
        }

        .difficulty-title {
            color: #e1e6ff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .difficulty-option {
            background: rgba(101, 80, 255, 0.3);
            border: 1px solid rgba(101, 80, 255, 0.5);
            color: #e1e6ff;
            padding: 8px 12px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
        }

        .difficulty-option:hover {
            background: rgba(101, 80, 255, 0.6);
            transform: scale(1.02);
        }

        .difficulty-option.active {
            background: rgba(101, 80, 255, 0.8);
            border-color: #6550ff;
            box-shadow: 0 0 10px rgba(101, 80, 255, 0.5);
        }

        /* ÁîµËÑëÂõûÁêÉÂ¢ûÂº∫ÈÄâÈ°πÊ†∑Âºè */
        .ai-enhancement-option {
            background: rgba(255, 165, 0, 0.3);
            border: 1px solid rgba(255, 165, 0, 0.5);
            color: #e1e6ff;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
        }

        .ai-enhancement-option:hover {
            background: rgba(255, 165, 0, 0.6);
            transform: scale(1.02);
        }

        .ai-enhancement-option.active {
            background: rgba(255, 165, 0, 0.8);
            border-color: #ffa500;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }

        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }

            .game-subtitle {
                font-size: 0.9rem;
            }

            .player-name {
                font-size: 1rem;
            }

            .player-score {
                font-size: 2rem;
            }

            .victory-message {
                font-size: 2.5rem;
            }

            .event-notification {
                top: 10px;
                right: 10px;
                min-width: 200px;
                max-width: 280px;
                padding: 12px 15px;
            }

            .event-title {
                font-size: 1rem;
            }

            .event-description {
                font-size: 0.8rem;
            }

            .difficulty-panel {
                right: 10px;
                width: 50px;
                height: 50px;
            }

            .difficulty-panel:hover {
                width: 180px;
                height: 280px;
            }

            .difficulty-icon {
                font-size: 20px;
            }

            .debug-panel {
                left: 10px;
                width: 50px;
                height: 50px;
            }

            .debug-panel:hover {
                width: 260px;
                height: 300px;
            }

            .debug-icon {
                font-size: 20px;
            }

            .pause-button {
                top: 10px;
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            /* ÁßªÂä®Á´ØËôöÊãüÊåâÈíÆÊ†∑Âºè */
            .mobile-controls {
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 3000;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .mobile-btn {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                border: none;
                background: rgba(101, 80, 255, 0.8);
                color: white;
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                transition: all 0.2s ease;
                user-select: none;
                -webkit-user-select: none;
                -webkit-touch-callout: none;
            }

            .mobile-btn:active {
                transform: scale(0.95);
                background: rgba(101, 80, 255, 1);
            }

            .mobile-btn.up {
                background: rgba(0, 200, 83, 0.8);
            }

            .mobile-btn.down {
                background: rgba(255, 68, 68, 0.8);
            }

            /* ÁßªÂä®Á´ØÂºÄÂßãÈ°µÈù¢‰ºòÂåñ */
            .start-container {
                margin: 10px;
                padding: 20px;
            }

            .start-title {
                font-size: 2.5rem;
            }

            .start-subtitle {
                font-size: 1rem;
            }

            .difficulty-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .start-difficulty-option {
                padding: 8px 4px;
                font-size: 0.9rem;
            }

            .ai-toggle-label {
                font-size: 1rem;
            }

            .start-button {
                padding: 12px;
                font-size: 1.2rem;
            }

            /* ÁßªÂä®Á´ØÊ∏∏ÊàèÂÆπÂô®‰ºòÂåñ */
            .game-container {
                margin: 5px;
                border-radius: 12px;
            }

            .game-content {
                padding: 10px;
            }

            .controls-info {
                font-size: 0.8rem;
                padding: 10px;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñ */
        @media (max-width: 480px) {
            .game-title {
                font-size: 1.5rem;
            }

            .game-subtitle {
                font-size: 0.8rem;
            }

            .player-score {
                font-size: 1.5rem;
            }

            .victory-message {
                font-size: 2rem;
            }

            .mobile-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .start-title {
                font-size: 2rem;
            }

            .difficulty-options {
                grid-template-columns: 1fr;
            }

            .start-difficulty-option {
                font-size: 0.8rem;
            }
        }

        /* ÁßªÂä®Á´ØËß¶Êë∏‰ºòÂåñ */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
                touch-action: none;
                -webkit-overflow-scrolling: touch;
            }

            canvas {
                touch-action: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* Èò≤Ê≠¢ÂèåÂáªÁº©Êîæ */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* ËôöÊãüÊåâÈíÆËß¶Êë∏ÂèçÈ¶à */
            .mobile-btn {
                -webkit-tap-highlight-color: transparent;
            }

            .mobile-btn:active {
                transform: scale(0.9);
                transition: transform 0.1s ease;
            }
        }
    </style>
</head>
<body>
    <!-- Êñ∞Â¢ûÂºÄÂßãÈ°µÈù¢ -->
    <div class="start-screen" id="start-screen">
        <div class="start-container">
            <h1 class="start-title">CYBERPONGK</h1>
            <p class="start-subtitle">Áõ¥Èù¢Âº∫ÊïåÔºåÂÆà‰ΩèÂ∫ïÁ∫øÔºåËΩ¨ÊàòÂõûÂáª<br>‰∏∫‰∫ÜÊúÄ‰Ω≥ÁöÑÊ∏∏Êàè‰ΩìÈ™åÔºåËØ∑ÊâìÂºÄÊïåÊñπÂõûÁêÉÂ¢ûÂº∫</p>

            <div class="start-options">
                <div class="option-group">
                    <div class="option-title">‰ΩúÊàòÈöæÂ∫¶</div>
                    <div class="difficulty-options">
                        <div class="start-difficulty-option active" data-speed="1.75">‰∏áÊ≥âÈÉ®ËØó‰∫∫</div>
                        <div class="start-difficulty-option" data-speed="2.5">ÈáéÊØîÂ§ßÈõÑ</div>
                        <div class="start-difficulty-option" data-speed="3">Â∞ëÂ•≥B</div>
                        <div class="start-difficulty-option" data-speed="3.5">Â∞èÂüã</div>
                        <div class="start-difficulty-option" data-speed="4.25">Á©∫&ÁôΩ</div>
                    </div>
                </div>

                <div class="option-group">
                    <div class="option-title">ÊïåÊñπÂº∫ÂåñÊ®°Âùó</div>
                    <div class="ai-toggle-container">
                        <div class="ai-toggle-label">ÊøÄÊ¥ªÊïåÊñπÂõûÁêÉÂ¢ûÂº∫ÂçèËÆÆ</div>
                        <label class="ai-toggle">
                            <input type="checkbox" id="start-ai-enhancement">
                            <span class="ai-toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <button class="start-button" id="start-button">ÂêØÂä®ÊàòÊñóÁ≥ªÁªü</button>
        </div>
    </div>

    <div class="game-container">
        <div class="glow-effect"></div>
        <div class="game-header">
            <h1 class="game-title">CYBERPONGK</h1>
            <p class="game-subtitle">ItsuyoÁöÑÊë∏È±ºÂ§ßÔºàÂ≠òÁñëÔºâ‰Ωú ¬∑ Crafted with Deepsuck</p>
        </div>

        <div class="game-stats">
            <div class="player-stats">
                <div class="player-name">Áé©ÂÆ∂</div>
                <div id="player-score" class="player-score">0</div>
            </div>

            <div class="player-stats">
                <div id="computer-player-name" class="player-name">ÁîµËÑë</div>
                <div id="computer-score" class="player-score">0</div>
            </div>
        </div>

        <div class="game-content">
            <div class="center-line"></div>
            <canvas id="game-canvas" width="800" height="500"></canvas>
        </div>

        <div class="victory-overlay" id="victory-overlay">
            <div class="victory-message" id="victory-message"></div>
            <button class="restart-btn" id="restart-btn">ÈáçÊñ∞ÂºÄÂßã</button>
        </div>

        <div class="controls-info">
            ‰ΩøÁî®Èº†Ê†áÁßªÂä®ÊéßÂà∂‰Ω†ÁöÑÊå°Êùø | È¶ñÂÖàËé∑Âæó3ÂàÜËÄÖËé∑ËÉú | Êî∂ÈõÜ‰∫ã‰ª∂Ëé∑ÂæóÁâπÊÆäÊïàÊûúÔºÅ
        </div>
    </div>

    <!-- ÈöæÂ∫¶Ë∞ÉÊï¥Á™óÂè£ -->
    <div class="difficulty-panel" id="difficulty-panel">
        <div class="difficulty-icon">‚öôÔ∏è</div>
        <div class="difficulty-content">
            <div class="difficulty-title">ÈöæÂ∫¶ËÆæÁΩÆ</div>
            <div class="difficulty-option" data-speed="1.75">‰∏áÊ≥âÈÉ®ËØó‰∫∫</div>
            <div class="difficulty-option" data-speed="2.5">ÈáéÊØîÂ§ßÈõÑ</div>
            <div class="difficulty-option active" data-speed="3">Â∞ëÂ•≥B</div>
            <div class="difficulty-option" data-speed="3.5">Â∞èÂüã</div>
            <div class="difficulty-option" data-speed="4.25">Á©∫&ÁôΩ</div>

            <!-- ÁîµËÑëÂõûÁêÉÂ¢ûÂº∫ÈÄâÈ°π -->
            <div class="ai-enhancement-option" id="ai-enhancement-toggle">
                ÊïåÊñπÂõûÁêÉÂ¢ûÂº∫
            </div>
        </div>
    </div>

    <!-- Ë∞ÉËØïÁ™óÂè£ -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-icon">üêõ</div>
        <div class="debug-content">
            <div class="debug-title">Ë∞ÉËØï‰ø°ÊÅØ</div>
            
            <div class="debug-section">
                <div class="debug-section-title">ÁêÉÁä∂ÊÄÅ</div>
                <div class="debug-item">
                    <span class="debug-label">ÈÄüÂ∫¶:</span>
                    <span class="debug-value" id="debug-ball-speed">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">‰ΩçÁΩÆ:</span>
                    <span class="debug-value" id="debug-ball-position">0,0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">ÈÄèÊòéÂ∫¶:</span>
                    <span class="debug-value" id="debug-ball-alpha">1.0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">ÁîµËÑëÊï∞ÊçÆ</div>
                <div class="debug-item">
                    <span class="debug-label">ÈÄüÂ∫¶:</span>
                    <span class="debug-value" id="debug-computer-speed">3</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">‰ΩçÁΩÆ:</span>
                    <span class="debug-value" id="debug-computer-position">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">ÈÄüÂ∫¶ÂÄçÊï∞:</span>
                    <span class="debug-value" id="debug-computer-multiplier">1.0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">‰∫ã‰ª∂Áä∂ÊÄÅ</div>
                <div class="debug-item">
                    <span class="debug-label">Ê¥ªË∑É‰∫ã‰ª∂:</span>
                    <span class="debug-value" id="debug-active-events">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">ÈöúÁ¢çÁâ©:</span>
                    <span class="debug-value" id="debug-obstacles">0</span>
                </div>
            </div>

            <div class="debug-section">
                <div class="debug-section-title">Á≥ªÁªü</div>
                <div class="debug-item">
                    <span class="debug-label">FPS:</span>
                    <span class="debug-value" id="debug-fps">0</span>
                </div>
                <div class="debug-item">
                    <span class="debug-label">Ê∏∏ÊàèÊó∂Èó¥:</span>
                    <span class="debug-value" id="debug-game-time">0s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊöÇÂÅú/ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ -->
    <button class="pause-button" id="pause-button">ÊöÇÂÅú</button>

    <!-- ÁßªÂä®Á´ØËôöÊãüÊéßÂà∂ÊåâÈíÆ -->
    <div class="mobile-controls" id="mobile-controls" style="display: none;">
        <button class="mobile-btn up" id="btn-up">‚Üë</button>
        <button class="mobile-btn down" id="btn-down">‚Üì</button>
    </div>

    <script>
        // Êñ∞Â¢ûÂºÄÂßãÈ°µÈù¢ÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', function() {
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const startDifficultyOptions = document.querySelectorAll('.start-difficulty-option');
            const startAiToggle = document.getElementById('start-ai-enhancement');

            // ËÆæÁΩÆÈªòËÆ§ÈÄâÈ°πÔºàÁÆÄÂçïÈöæÂ∫¶Ôºâ
            let selectedDifficulty = 1.75;

            // ÂºÄÂßãÈ°µÈù¢ÈöæÂ∫¶ÈÄâÊã©
            startDifficultyOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    startDifficultyOptions.forEach(opt => opt.classList.remove('active'));
                    // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÈÄâÈ°π
                    this.classList.add('active');
                    // Êõ¥Êñ∞ÈÄâÊã©ÁöÑÈöæÂ∫¶
                    selectedDifficulty = parseFloat(this.dataset.speed);
                });
            });

            // AIÂõûÁêÉÂ¢ûÂº∫ÈÄâÈ°π
            startAiToggle.addEventListener('change', function() {
                aiEnhancementEnabled = this.checked;
            });

            // ÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂
            startButton.addEventListener('click', function() {
                // Â∫îÁî®ÈÄâÊã©ÁöÑÈöæÂ∫¶Âà∞Ê∏∏ÊàèÂÜÖ
                computer.speed = selectedDifficulty;

                // ÂêåÊ≠•Ê∏∏ÊàèÂÜÖÈöæÂ∫¶ÈÄâÊã©
                document.querySelectorAll('.difficulty-option').forEach(option => {
                    if (parseFloat(option.dataset.speed) === selectedDifficulty) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });

                // ÂêåÊ≠•AIÂ¢ûÂº∫ÈÄâÈ°π
                const gameAiToggle = document.getElementById('ai-enhancement-toggle');
                if (aiEnhancementEnabled) {
                    gameAiToggle.classList.add('active');
                } else {
                    gameAiToggle.classList.remove('active');
                }

                aiEnhancementEnabled = aiEnhancementEnabled;

                // ÈöêËóèÂºÄÂßãÈ°µÈù¢
                startScreen.classList.add('hidden');

                // ËÆæÁΩÆÁîµËÑëÂêçÁß∞
                const computerNameElement = document.getElementById('computer-player-name');
                const selectedDifficultyOption = document.querySelector('.difficulty-option.active');
                computerNameElement.textContent = selectedDifficultyOption.textContent;

                // ÈáçÁΩÆÊ∏∏ÊàèÔºàÂ¶ÇÊûúÂ∑≤ÁªèÁé©ËøáÔºâ
                resetGame();
            });
        });

        // Ëé∑ÂèñCanvasÂíåContext
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Áé©ÂÆ∂ÂíåÁîµËÑëÁöÑÂàÜÊï∞
        const playerScoreElement = document.getElementById('player-score');
        const computerScoreElement = document.getElementById('computer-score');
        let playerScore = 0;
        let computerScore = 0;

        // ËÉúÂà©ÁïåÈù¢ÂÖÉÁ¥†
        const victoryOverlay = document.getElementById('victory-overlay');
        const victoryMessage = document.getElementById('victory-message');
        const restartBtn = document.getElementById('restart-btn');

        // Ê∑ªÂä†Â∏ßÁéáÈîÅÂÆöÁõ∏ÂÖ≥ÂèòÈáè
        const FPS = 120; // ÁõÆÊ†áÂ∏ßÁéá
        const FRAME_INTERVAL = 1000 / FPS; // ÊØèÂ∏ßÊó∂Èó¥(ms)
        let lastTime = 0;
        let deltaTime = 0;
        let accumulatedTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let isGameOver = false;
        let isResetting = false;
        let isPaused = false; // Ê∑ªÂä†ÊöÇÂÅúÁä∂ÊÄÅ
        let gameTime = 0; // Ê∏∏ÊàèËøêË°åÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
        let nextObstacleTime = 15000; // Á¨¨‰∏ÄÊ¨°ÈöúÁ¢çÁâ©Âá∫Áé∞Êó∂Èó¥Ôºà15ÁßíÂêéÔºâ
        let nextEventTime = 10000; // Á¨¨‰∏ÄÊ¨°‰∫ã‰ª∂Âá∫Áé∞Êó∂Èó¥Ôºà10ÁßíÂêéÔºâ

        // ÁîµËÑëÂõûÁêÉÂ¢ûÂº∫ÂäüËÉΩÁä∂ÊÄÅ
        let aiEnhancementEnabled = false;

        // Ê≠ªÁêÉÊ£ÄÊµãÁõ∏ÂÖ≥ÂèòÈáè
        let ballStuckDetection = {
            lastY: 0,
            stuckTime: 0,
            checkInterval: 100, // ÊØè100msÊ£ÄÊü•‰∏ÄÊ¨°
            lastCheckTime: 0,
            stuckThreshold: 2000, // 2ÁßíÂÜÖÂç°Âú®ËæπÁºòÂà§ÂÆö‰∏∫Ê≠ªÁêÉ
            edgeThreshold: 30 // Ë∑ùÁ¶ªËæπÁºò30ÂÉèÁ¥†ÂÜÖÁÆó‰ΩúËæπÁºò
        };

        // ËÆ∞ÂΩï‰∏ä‰∏Ä‰∏™Ëß¶ÁêÉÁöÑÁé©ÂÆ∂ ('player' Êàñ 'computer')
        let lastTouchedBy = null;

        // Ê∏∏ÊàèÂØπË±°
        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 12,
            speed: 4,
            velocityX: 5,
            velocityY: 5,
            color: '#ffcc00',
            trail: [],
            lastCollision: 0, // ËÆ∞ÂΩï‰∏äÊ¨°Á¢∞ÊíûÊó∂Èó¥
            alpha: 1.0, // ÁêÉÁöÑÈÄèÊòéÂ∫¶
            speedMultiplier: 1.0 // ÈÄüÂ∫¶ÂÄçÊï∞
        };

        // Áé©ÂÆ∂Êå°Êùø
        const player = {
            x: 20,
            y: canvas.height / 2 - 70,
            width: 15,
            height: 120,
            speed: 8,
            color: '#6550ff',
            score: 0,
            originalHeight: 120,
            glowEffect: false,
            glowEndTime: 0,
            rgbEffect: false, // Ê∑ªÂä†rgbÊïàÊûúÂ±ûÊÄß
            rgbEndTime: 0 // Ê∑ªÂä†rgbÊïàÊûúÁªìÊùüÊó∂Èó¥
        };

        // ÁîµËÑëÊå°Êùø
        const computer = {
            x: canvas.width - 35,
            y: canvas.height / 2 - 70,
            width: 15,
            height: 120,
            speed: 3,
            color: '#ff3366',
            score: 0,
            originalHeight: 120,
            glowEffect: false,
            glowEndTime: 0,
            rgbEffect: false, // Ê∑ªÂä†rgbÊïàÊûúÂ±ûÊÄß
            rgbEndTime: 0, // Ê∑ªÂä†rgbÊïàÊûúÁªìÊùüÊó∂Èó¥
            speedMultiplier: 1.0
        };

        // Á≤íÂ≠êÊï∞ÁªÑ
        const particles = [];

        // ÈöúÁ¢çÁâ©Êï∞ÁªÑ
        const obstacles = [];

        // ‰∫ã‰ª∂Êï∞ÁªÑ
        const events = [];

        // ÂÖ®Â±ÄÊïàÊûú
        const globalEffects = {
            speedVariation: { active: false, endTime: 0 },
            obstacleSpeedUp: { active: false, endTime: 0, originalInterval: 0 },
            thunderCloud: { active: false, endTime: 0, flashTime: 0 },
            // Êñ∞Â¢ûÊïàÊûú
            immortalTotem: { active: false, endTime: 0, triggeredBy: null },
            eventFrenzy: { active: false, endTime: 0, originalEventInterval: 0 },
            heavenMaker: { active: false, endTime: 0, stackCount: 0 },
            heavyBall: { active: false, endTime: 0, stackCount: 0 }
        };

        // ‰∫ã‰ª∂Á±ªÂûãÂÆö‰πâ
        const eventTypes = {
            // Ê≠£Èù¢‰∫ã‰ª∂
            PADDLE_GROW: {
                type: 'positive',
                color: '#00ff88',
                name: 'Bo‚ôÇki',
                description: 'ÊùøÂ≠êÂ¢ûÈïø20%ÔºåÊåÅÁª≠20Áßí'
            },
            LIGHTNING_PADDLE: {
                type: 'positive',
                color: '#ffff00',
                name: 'ÂíñÂñ±Ê£í',
                description: 'Ëé∑ÂæóÈáëÈó™Èó™ÊïàÊûúÔºåËß¶ÁêÉÂ¢ûÈÄü80%ÔºåÊåÅÁª≠20Áßí'
            },
            SLOW_COMPUTER: {
                type: 'positive',
                color: '#00ccff',
                name: 'ÂØíÂÜ∞Ëèá',
                description: 'ÁîµËÑëÊùøÂ≠êÁßªÂä®ÈÄüÂ∫¶-20%ÔºåÁõ¥Âà∞‰∏ãÊ¨°ËøõÁêÉ'
            },
            
            // ‰∏≠ÊÄß‰∫ã‰ª∂
            SPEED_VARIATION: {
                type: 'neutral',
                color: '#888888',
                name: 'Ëá¥ÂëΩËäÇÂ•è',
                description: 'ÁêÉÈÄüÂú®70%-130%Èó¥ÂèòÂä®ÔºåÊåÅÁª≠15Áßí'
            },
            OBSTACLE_RUSH: {
                type: 'neutral',
                color: '#aa6600',
                name: 'ÁßªÂä®Ëø∑ÂÆ´',
                description: 'ÈöúÁ¢çÁâ©ÁîüÊàêÈÄüÂ∫¶ÊèêÂçá500%ÔºåÊåÅÁª≠30Áßí'
            },
            SPEED_RESET: {
                type: 'neutral',
                color: '#666666',
                name: 'È£üÂÖâÈ∏°',
                description: 'ÁêÉÈÄüÈáçÁΩÆ‰∏∫ÂàùÂßãÈÄüÂ∫¶'
            },
            
            // Ë¥üÈù¢‰∫ã‰ª∂
            THUNDER_CLOUD: {
                type: 'negative',
                color: '#444444',
                name: 'È™§Èõ®ÁöÑÁã≠Èó¥',
                description: '‰∏≠Â§ÆÈõ∑‰∫ëÈÅÆÊå°ËßÜÈáéÔºåÁêÉÁªèËøáÊó∂ÊîπÂèòËßíÂ∫¶'
            },
            PADDLE_SHRINK: {
                type: 'negative',
                color: '#660000',
                name: 'Èò≥Áóø',
                description: 'ÊùøÂ≠êÁº©Áü≠20%ÔºåÊåÅÁª≠20Áßí'
            },
            BALL_FADE: {
                type: 'negative',
                color: '#333333',
                name: 'ÊàëÂêç‰∏∫ÊöóÂΩ±',
                description: 'ÁêÉÈÄèÊòéÂ∫¶Èôç‰∏∫10%ÔºåÊåÅÁª≠15Áßí'
            },
            
            // Êñ∞Â¢û‰∫ã‰ª∂
            // Ê≠£Èù¢
            IMMORTAL_TOTEM: {
                type: 'positive',
                color: '#ff00ff',
                name: '‰∏çÊ≠ªÂõæËÖæ',
                description: 'Ëß¶ÂèëÊñπÂú®45ÁßíÂÜÖÁ¨¨‰∏Ä‰∏™Â§±ÁêÉÂùá‰∏çËÆ°ÂÖ•ÂàÜÊï∞'
            },
            // ‰∏≠ÊÄß
            EVENT_FRENZY: {
                type: 'neutral',
                color: '#888888',
                name: 'EVENT‚òÜSTART',
                description: '‰∫ã‰ª∂Âà∑Êñ∞ÁéáÂ¢ûÂä†‰∏∫400%ÔºåÊåÅÁª≠30Áßí'
            },
            HEAVEN_MAKER: {
                type: 'neutral',
                color: '#cccccc',
                name: 'MADE IN HEAVEN',
                description: 'ÁêÉÁöÑÂ§ßÂ∞èÂèò‰∏∫ÂéüÊù•ÁöÑ50%ÔºåÈÄüÂ∫¶Âèò‰∏∫ÂéüÊù•ÁöÑ125%ÔºåÊåÅÁª≠25Áßí'
            },
            HEAVY_BALL: {
                type: 'neutral',
                color: '#666666',
                name: 'ÈÅáÊ∞¥ÂèòÂ§ßÂèòÈ´ò',
                description: 'ÁêÉÁöÑÂ§ßÂ∞èÂèò‰∏∫ÂéüÊù•ÁöÑ200%ÔºåÈÄüÂ∫¶Âèò‰∏∫ÂéüÊù•ÁöÑ80%ÔºåÊåÅÁª≠25Áßí'
            }
        };

        // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ÁõëÂê¨
        canvas.addEventListener('mousemove', (e) => {
            if (isGameOver || isPaused) return; // Ê∑ªÂä†ÊöÇÂÅúÊ£ÄÊü•
            const rect = canvas.getBoundingClientRect();
            player.y = e.clientY - rect.top - player.height / 2;
        });

        

        // ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂
        restartBtn.addEventListener('click', () => {
            resetGame();
        });

        // ÈöæÂ∫¶Ë∞ÉÊï¥‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.querySelectorAll('.difficulty-option').forEach(option => {
            option.addEventListener('click', (e) => {
                // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('active'));
                // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÈÄâÈ°π
                e.target.classList.add('active');
                // Êõ¥Êñ∞ÁîµËÑëÈÄüÂ∫¶
                const newSpeed = parseFloat(e.target.dataset.speed);
                computer.speed = newSpeed;
                // Êõ¥Êñ∞ÁîµËÑëÂêçÁß∞
                const computerNameElement = document.getElementById('computer-player-name');
                computerNameElement.textContent = e.target.textContent;
            });
        });

        // ÁîµËÑëÂõûÁêÉÂ¢ûÂº∫ÈÄâÈ°π‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('ai-enhancement-toggle').addEventListener('click', (e) => {
            aiEnhancementEnabled = !aiEnhancementEnabled;
            if (aiEnhancementEnabled) {
                e.target.classList.add('active');
            } else {
                e.target.classList.remove('active');
            }
        });

        // ÊöÇÂÅúÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const pauseButton = document.getElementById('pause-button');
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                pauseButton.textContent = 'ÁªßÁª≠';
                pauseButton.classList.add('paused');
            } else {
                pauseButton.textContent = 'ÊöÇÂÅú';
                pauseButton.classList.remove('paused');
            }
        });

        // ÊòæÁ§∫‰∫ã‰ª∂ÈÄöÁü•ÂºπÁ™ó
        function showEventNotification(eventObj, triggeredBy) {
            // ÁßªÈô§Áé∞ÊúâÁöÑÈÄöÁü•
            const existingNotification = document.querySelector('.event-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `event-notification ${eventObj.typeData.type}`;
            
            const triggerText = triggeredBy === 'player' ? 'Áé©ÂÆ∂Ëß¶Âèë' : 'ÁîµËÑëËß¶Âèë';
            
            notification.innerHTML = `
                <div class="event-trigger">${triggerText}</div>
                <div class="event-title">${eventObj.typeData.name}</div>
                <div class="event-description">${eventObj.typeData.description}</div>
            `;

            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(notification);

            // Ëß¶ÂèëÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
            }, 3000);
        }

        // ÊòæÁ§∫Ê≠ªÁêÉÊ£ÄÊµãÈÄöÁü•
        function showDeadBallNotification() {
            // ÁßªÈô§Áé∞ÊúâÁöÑÈÄöÁü•
            const existingNotification = document.querySelector('.event-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = 'event-notification negative';

            notification.innerHTML = `
                <div class="event-trigger">Á≥ªÁªüÊ£ÄÊµã</div>
                <div class="event-title">Âç°ÁêÉÊ£ÄÊµãË¢´Ëß¶Âèë</div>
                <div class="event-description">Ê£ÄÊµãÂà∞ËæπÁ∫øÊ≠ªÁêÉbugÔºåÈáçÊñ∞ÂèëÁêÉ</div>
            `;

            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(notification);

            // Ëß¶ÂèëÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 500);
            }, 3000);
        }

        // Ê≠ªÁêÉÊ£ÄÊµãÂáΩÊï∞
        function checkDeadBall() {
            const currentTime = Date.now();

            // ÊØè100msÊ£ÄÊü•‰∏ÄÊ¨°
            if (currentTime - ballStuckDetection.lastCheckTime < ballStuckDetection.checkInterval) {
                return false;
            }

            ballStuckDetection.lastCheckTime = currentTime;

            // Ê£ÄÊü•ÁêÉÊòØÂê¶Âú®‰∏ä‰∏ãËæπÁºòÈôÑËøë
            const isNearTopEdge = ball.y <= ballStuckDetection.edgeThreshold;
            const isNearBottomEdge = ball.y >= (canvas.height - ballStuckDetection.edgeThreshold);

            if (isNearTopEdge || isNearBottomEdge) {
                // Ê£ÄÊü•ÁêÉÁöÑYÂùêÊ†áÊòØÂê¶Âú®ÂæàÂ∞èËåÉÂõ¥ÂÜÖÂèòÂåñÔºàË°®Á§∫Âç°‰Ωè‰∫ÜÔºâ
                const yDifference = Math.abs(ball.y - ballStuckDetection.lastY);

                if (yDifference < 5) { // YÂùêÊ†áÂèòÂåñÂ∞è‰∫é5ÂÉèÁ¥†
                    ballStuckDetection.stuckTime += ballStuckDetection.checkInterval;

                    // Â¶ÇÊûúÂç°‰ΩèÊó∂Èó¥Ë∂ÖËøáÈòàÂÄºÔºåËß¶ÂèëÊ≠ªÁêÉÊ£ÄÊµã
                    if (ballStuckDetection.stuckTime >= ballStuckDetection.stuckThreshold) {
                        return true;
                    }
                } else {
                    // ÁêÉÂú®ÁßªÂä®ÔºåÈáçÁΩÆÂç°‰ΩèÊó∂Èó¥
                    ballStuckDetection.stuckTime = 0;
                }
            } else {
                // ÁêÉ‰∏çÂú®ËæπÁºòÔºåÈáçÁΩÆÂç°‰ΩèÊó∂Èó¥
                ballStuckDetection.stuckTime = 0;
            }

            ballStuckDetection.lastY = ball.y;
            return false;
        }

        // ÈáçÁΩÆÊ∏∏Êàè
        function resetGame() {
            playerScore = 0;
            computerScore = 0;
            playerScoreElement.textContent = '0';
            computerScoreElement.textContent = '0';
            victoryOverlay.style.opacity = '0';
            victoryOverlay.style.pointerEvents = 'none';
            isGameOver = false;
            gameTime = 0;
            nextObstacleTime = 20000;
            nextEventTime = 10000;
            obstacles.length = 0;
            events.length = 0;
            lastTouchedBy = null;

            // ÈáçÁΩÆÁîµËÑëÂêçÁß∞
            document.getElementById('computer-player-name').textContent = 'ÁîµËÑë';

            // ÈáçÁΩÆÊ≠ªÁêÉÊ£ÄÊµã
            ballStuckDetection.lastY = 0;
            ballStuckDetection.stuckTime = 0;
            ballStuckDetection.lastCheckTime = 0;
            
            // ÁßªÈô§ÊâÄÊúâ‰∫ã‰ª∂ÈÄöÁü•
            const notifications = document.querySelectorAll('.event-notification');
            notifications.forEach(notification => notification.remove());
            
            // ÈáçÁΩÆÊå°ÊùøÁä∂ÊÄÅ
            player.height = player.originalHeight;
            player.glowEffect = false;
            player.glowEndTime = 0;
            player.rgbEffect = false; // ÈáçÁΩÆrgbÊïàÊûú
            player.rgbEndTime = 0; // ÈáçÁΩÆrgbÊïàÊûúÁªìÊùüÊó∂Èó¥
            computer.height = computer.originalHeight;
            computer.glowEffect = false;
            computer.glowEndTime = 0;
            computer.speedMultiplier = 1.0;
            computer.rgbEffect = false; // ÈáçÁΩÆrgbÊïàÊûú
            computer.rgbEndTime = 0; // ÈáçÁΩÆrgbÊïàÊûúÁªìÊùüÊó∂Èó¥
            
            // ÈáçÁΩÆÁêÉÁä∂ÊÄÅ
            ball.alpha = 1.0;
            ball.speedMultiplier = 1.0;
            ball.radius = 12; // ÈáçÁΩÆÁêÉÁöÑÂçäÂæÑ
            
            // ÈáçÁΩÆÂÖ®Â±ÄÊïàÊûú
            globalEffects.speedVariation.active = false;
            globalEffects.obstacleSpeedUp.active = false;
            globalEffects.thunderCloud.active = false;
            // ÈáçÁΩÆÊñ∞Â¢ûÊïàÊûú
            globalEffects.immortalTotem.active = false;
            globalEffects.immortalTotem.triggeredBy = null;
            globalEffects.eventFrenzy.active = false;
            globalEffects.heavenMaker.active = false;
            globalEffects.heavenMaker.stackCount = 0;
            globalEffects.heavyBall.active = false;
            globalEffects.heavyBall.stackCount = 0;

            const computerNameElement = document.getElementById('computer-player-name');
            const selectedDifficultyOption = document.querySelector('.difficulty-option.active');
            computerNameElement.textContent = selectedDifficultyOption.textContent;
            
            resetBall();
        }

        // Á¢∞ÊíûÁ≤íÂ≠êÊïàÊûú
        function createParticles(x, y, color, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    radius: Math.random() * 3 + 1,
                    color: color,
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * Math.PI * 2,
                    life: 30
                });
            }
        }

        // ÂàõÂª∫ÂæóÂàÜÁâπÊïà
        function createScoreEffect(isPlayer) {
            const scoreEffect = document.createElement('div');
            scoreEffect.className = 'score-animation';
            scoreEffect.textContent = '+1';

            const statsContainer = isPlayer ?
                playerScoreElement.parentElement :
                computerScoreElement.parentElement;

            statsContainer.appendChild(scoreEffect);

            // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§ÂÖÉÁ¥†
            setTimeout(() => {
                scoreEffect.remove();
            }, 1000);
        }

        // ÂàõÂª∫‰∫ã‰ª∂
        function createEvent() {
            // Âú®‰∏≠Èó¥90%Âå∫ÂüüÁîüÊàê‰∫ã‰ª∂
            const minX = canvas.width * 0.05;
            const maxX = canvas.width * 0.95;
            const minY = canvas.height * 0.05;
            const maxY = canvas.height * 0.95;

            const x = minX + Math.random() * (maxX - minX);
            const y = minY + Math.random() * (maxY - minY);

            // ÈöèÊú∫ÈÄâÊã©‰∫ã‰ª∂Á±ªÂûã
            const eventTypeKeys = Object.keys(eventTypes);
            const randomEventType = eventTypeKeys[Math.floor(Math.random() * eventTypeKeys.length)];
            const eventType = eventTypes[randomEventType];

            events.push({
                x: x,
                y: y,
                radius: 15,
                type: randomEventType,
                typeData: eventType,
                spawnTime: Date.now(),
                duration: 20000, // 20ÁßíÂêéÊ∂àÂ§±
                pulsePhase: 0
            });
        }

        // Ëß¶Âèë‰∫ã‰ª∂ÊïàÊûú
        function triggerEvent(eventObj, triggeredBy) {
            const currentTime = Date.now();
            
            // ÊòæÁ§∫‰∫ã‰ª∂ÈÄöÁü•
            showEventNotification(eventObj, triggeredBy);
            
            switch (eventObj.type) {
                case 'PADDLE_GROW':
                    if (triggeredBy === 'player') {
                        player.height = Math.min(player.height * 1.2, canvas.height * 0.8);
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.height = Math.min(computer.height * 1.2, canvas.height * 0.8);
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'LIGHTNING_PADDLE':
                    if (triggeredBy === 'player') {
                        player.glowEffect = true;
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.glowEffect = true;
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'SLOW_COMPUTER':
                    // Ëøô‰∏™‰∫ã‰ª∂Âè™ÂØπÁé©ÂÆ∂ÊúâÁî®Ôºå‰ΩÜÁîµËÑë‰πüÂèØ‰ª•Ëß¶ÂèëÔºàÂè™ÊòØÊ≤°ÊúâÊïàÊûúÔºâ
                    if (triggeredBy === 'player') {
                        computer.speedMultiplier = Math.max(computer.speedMultiplier * 0.8, 0.1);
                    }
                    break;
                    
                case 'SPEED_VARIATION':
                    globalEffects.speedVariation.active = true;
                    globalEffects.speedVariation.endTime = Math.max(
                        globalEffects.speedVariation.endTime, 
                        currentTime + 15000
                    );
                    break;
                    
                case 'OBSTACLE_RUSH':
                    if (!globalEffects.obstacleSpeedUp.active) {
                        globalEffects.obstacleSpeedUp.originalInterval = nextObstacleTime - gameTime;
                    }
                    globalEffects.obstacleSpeedUp.active = true;
                    globalEffects.obstacleSpeedUp.endTime = Math.max(
                        globalEffects.obstacleSpeedUp.endTime,
                        currentTime + 30000
                    );
                    break;
                    
                case 'SPEED_RESET':
                    ball.speed = 4;
                    ball.speedMultiplier = 1.0;
                    break;
                    
                case 'THUNDER_CLOUD':
                    globalEffects.thunderCloud.active = true;
                    globalEffects.thunderCloud.endTime = Math.max(
                        globalEffects.thunderCloud.endTime,
                        currentTime + 30000
                    );
                    break;
                    
                case 'PADDLE_SHRINK':
                    if (triggeredBy === 'player') {
                        player.height = Math.max(player.height * 0.8, 40);
                        player.glowEndTime = Math.max(player.glowEndTime, currentTime + 20000);
                    } else {
                        computer.height = Math.max(computer.height * 0.8, 40);
                        computer.glowEndTime = Math.max(computer.glowEndTime, currentTime + 20000);
                    }
                    break;
                    
                case 'BALL_FADE':
                    ball.alpha = Math.min(ball.alpha, 0.1);
                    // ËøôÈáåÈúÄË¶Å‰∏Ä‰∏™ËÆ°Êó∂Âô®Êù•ÊÅ¢Â§çÈÄèÊòéÂ∫¶
                    setTimeout(() => {
                        ball.alpha = Math.min(ball.alpha + 0.9, 1.0);
                    }, 15000);
                    break;
                    
                // Êñ∞Â¢û‰∫ã‰ª∂Â§ÑÁêÜ
                case 'IMMORTAL_TOTEM':
                    // ‰∏çÊ≠ªÂõæËÖæÊïàÊûúÔºå‰∏çÂèØÂè†Âä†
                    if (!globalEffects.immortalTotem.active) {
                        globalEffects.immortalTotem.active = true;
                        globalEffects.immortalTotem.endTime = currentTime + 45000; // 45Áßí
                        globalEffects.immortalTotem.triggeredBy = triggeredBy;

                        // ‰∏∫Ëß¶ÂèëÊñπÊ∑ªÂä†RGBÂèòËâ≤ÊïàÊûú
                        if (triggeredBy === 'player') {
                            player.rgbEffect = true; // ‰ΩøÁî®rgbEffectËÄå‰∏çÊòØglowEffect
                            player.rgbEndTime = currentTime + 45000;
                        } else {
                            computer.rgbEffect = true; // ‰ΩøÁî®rgbEffectËÄå‰∏çÊòØglowEffect
                            computer.rgbEndTime = currentTime + 45000;
                        }
                    }
                    break;

                case 'EVENT_FRENZY':
                    // ‰∫ã‰ª∂ÁãÇÊΩÆÊïàÊûúÔºå‰∏çÂèØÂè†Âä†
                    if (!globalEffects.eventFrenzy.active) {
                        globalEffects.eventFrenzy.active = true;
                        globalEffects.eventFrenzy.endTime = currentTime + 30000; // 30Áßí
                        globalEffects.eventFrenzy.originalEventInterval = nextEventTime - gameTime;
                    }
                    break;
                    
                case 'HEAVEN_MAKER':
                    // Â§©Â†ÇÂà∂ÈÄ†ÊïàÊûúÔºåÂèØÂè†Âä†
                    if (!globalEffects.heavenMaker.active) {
                        globalEffects.heavenMaker.active = true;
                        globalEffects.heavenMaker.endTime = currentTime + 25000; // 25Áßí
                        globalEffects.heavenMaker.stackCount = 1;
                    } else {
                        // Âè†Âä†ÊïàÊûúÔºåÂª∂ÈïøÊó∂Èó¥Âπ∂Â¢ûÂä†Âè†Âä†Ê¨°Êï∞
                        globalEffects.heavenMaker.endTime = Math.max(globalEffects.heavenMaker.endTime, currentTime + 25000);
                        globalEffects.heavenMaker.stackCount++;
                    }
                    // Â∫îÁî®ÊïàÊûúÔºöÁêÉÂèòÂ∞èÔºåÈÄüÂ∫¶ÂèòÂø´
                    ball.radius = Math.max(ball.radius * 0.5, 3); // ÊúÄÂ∞èÂçäÂæÑ3ÂÉèÁ¥†
                    ball.speedMultiplier *= 1.25;
                    break;
                    
                case 'HEAVY_BALL':
                    // Ê≤âÈáçÊïàÊûúÔºåÂèØÂè†Âä†
                    if (!globalEffects.heavyBall.active) {
                        globalEffects.heavyBall.active = true;
                        globalEffects.heavyBall.endTime = currentTime + 25000; // 25Áßí
                        globalEffects.heavyBall.stackCount = 1;
                    } else {
                        // Âè†Âä†ÊïàÊûúÔºåÂª∂ÈïøÊó∂Èó¥Âπ∂Â¢ûÂä†Âè†Âä†Ê¨°Êï∞
                        globalEffects.heavyBall.endTime = Math.max(globalEffects.heavyBall.endTime, currentTime + 25000);
                        globalEffects.heavyBall.stackCount++;
                    }
                    // Â∫îÁî®ÊïàÊûúÔºöÁêÉÂèòÂ§ßÔºåÈÄüÂ∫¶ÂèòÊÖ¢
                    ball.radius = Math.min(ball.radius * 2, 50); // ÊúÄÂ§ßÂçäÂæÑ50ÂÉèÁ¥†
                    ball.speedMultiplier *= 0.8;
                    break;
            }
            
            // ÂàõÂª∫‰∫ã‰ª∂Ëß¶ÂèëÁ≤íÂ≠êÊïàÊûú
            createParticles(eventObj.x, eventObj.y, eventObj.typeData.color, 25);
        }

        // ÂàõÂª∫ÈöúÁ¢çÁâ©
        function createObstacles() {
            // Á°Æ‰øùÈöúÁ¢çÁâ©Âú®‰∏≠Èó¥75%Âå∫ÂüüÁîüÊàê
            const minX = canvas.width * 0.125; // 12.5% Â∑¶ËæπË∑ù
            const maxX = canvas.width * 0.875; // 87.5% Âè≥ËæπË∑ù
            const minY = canvas.height * 0.125; // 12.5% ‰∏äËæπË∑ù
            const maxY = canvas.height * 0.875; // 87.5% ‰∏ãËæπË∑ù

            // ÈöèÊú∫‰ΩçÁΩÆ
            const x = minX + Math.random() * (maxX - minX);
            const y = minY + Math.random() * (maxY - minY);

            // ÈöèÊú∫Â§ßÂ∞è (20-40ÂÉèÁ¥†)
            const size = 20 + Math.random() * 20;

            // ÈöèÊú∫ÂΩ¢Áä∂ (ÂúÜÂΩ¢ÊàñÊñπÂΩ¢)
            const type = Math.random() > 0.5 ? 'circle' : 'rect';

            // ÈöèÊú∫Â≠òÂú®Êó∂Èó¥ (8-20Áßí)
            const duration = 8000 + Math.random() * 12000;

            // È¢ÑË≠¶Êó∂Èó¥ (1Áßí)
            const warningTime = 1000;

            // ÈöèÊú∫ÈÄâÊã©ÂØπÁß∞Ê®°Âºè (1, 2, 3, 5, 9, 0, 4, 0‰∏™ÈöúÁ¢çÁâ©)
            const symmetryMode = Math.floor(Math.random() * 8); // 0-7

            // ÈöúÁ¢çÁâ©‰ΩçÁΩÆÊï∞ÁªÑ
            const positions = [];

            // ‰∏≠ÂøÉÁÇπ
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // Ê†πÊçÆÂØπÁß∞Ê®°ÂºèÁîüÊàêÈöúÁ¢çÁâ©‰ΩçÁΩÆÔºàÊîæÂ∞ÑÊÄßËΩ¥ÂØπÁß∞Ôºâ
            switch (symmetryMode) {
                case 0: // 1‰∏™ÈöúÁ¢çÁâ©Ôºà‰∏≠ÂøÉÔºâ
                    positions.push({x: centerX, y: centerY});
                    break;

                case 1: // 2‰∏™ÈöúÁ¢çÁâ©ÔºàÊîæÂ∞ÑÊÄßËΩ¥ÂØπÁß∞Ôºâ
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    break;

                case 2: // 3‰∏™ÈöúÁ¢çÁâ©ÔºàÊîæÂ∞ÑÊÄßËΩ¥ÂØπÁß∞Ôºâ
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    break;

                case 3: // 5‰∏™ÈöúÁ¢çÁâ©ÔºàÊîæÂ∞ÑÊÄßËΩ¥ÂØπÁß∞Ôºâ
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    break;

                case 4: // 9‰∏™ÈöúÁ¢çÁâ©ÔºàÊîæÂ∞ÑÊÄßËΩ¥ÂØπÁß∞Ôºâ
                    positions.push({x: centerX, y: centerY});
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    positions.push({x: centerX, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: centerY});
                    positions.push({x: x, y: centerY});
                    positions.push({x: centerX, y: y});
                    break;

                case 5: // None
                    break;

                case 6: // 4‰∏™ÈöúÁ¢çÁâ©ÔºàË°•Ôºâ
                    positions.push({x: x, y: y});
                    positions.push({x: 2 * centerX - x, y: 2 * centerY - y});
                    positions.push({x: x, y: 2 * centerY - y});
                    positions.push({x: 2 * centerX - x, y: y});
                    break;

                case 7: //None
                    break;
            }

            // ÂàõÂª∫ÈöúÁ¢çÁâ©
            for (const pos of positions) {
                obstacles.push({
                    x: pos.x,
                    y: pos.y,
                    size: size,
                    type: type,
                    warningTime: warningTime,
                    warningProgress: 0,
                    duration: duration,
                    active: false,
                    spawnTime: Date.now()
                });
            }
        }

        // Êõ¥Êñ∞ÈöúÁ¢çÁâ©Áä∂ÊÄÅ
        function updateObstacles() {
            const now = Date.now();

            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];

                // Êõ¥Êñ∞È¢ÑË≠¶ËøõÂ∫¶
                if (!obs.active) {
                    const elapsed = now - obs.spawnTime;
                    obs.warningProgress = Math.min(1, elapsed / obs.warningTime);

                    // Â¶ÇÊûúÈ¢ÑË≠¶Êó∂Èó¥ÁªìÊùüÔºåÊøÄÊ¥ªÈöúÁ¢çÁâ©
                    if (elapsed >= obs.warningTime) {
                        obs.active = true;
                        obs.activateTime = now;
                    }
                }

                // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÁßªÈô§ÈöúÁ¢çÁâ©
                if (obs.active && now - obs.activateTime >= obs.duration) {
                    obstacles.splice(i, 1);
                }
            }
        }

        // Êõ¥Êñ∞‰∫ã‰ª∂Áä∂ÊÄÅ
        function updateEvents() {
            const now = Date.now();

            for (let i = events.length - 1; i >= 0; i--) {
                const event = events[i];
                
                // Êõ¥Êñ∞ËÑâÂÜ≤Âä®Áîª
                event.pulsePhase += 0.1;
                
                // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÁßªÈô§‰∫ã‰ª∂
                if (now - event.spawnTime >= event.duration) {
                    events.splice(i, 1);
                }
            }
        }

        // Êõ¥Êñ∞ÂÖ®Â±ÄÊïàÊûú
        function updateGlobalEffects() {
            const now = Date.now();
            
            // ÈÄüÂ∫¶ÂèòÂåñÊïàÊûú
            if (globalEffects.speedVariation.active) {
                if (now > globalEffects.speedVariation.endTime) {
                    globalEffects.speedVariation.active = false;
                    ball.speedMultiplier = 1.0;
                } else {
                    // Âú®70%-130%‰πãÈó¥ÂèòÂä®
                    ball.speedMultiplier = 0.7 + 0.6 * (0.5 + 0.5 * Math.sin(now * 0.01));
                }
            }
            
            // ÈöúÁ¢çÁâ©Âä†ÈÄüÊïàÊûú
            if (globalEffects.obstacleSpeedUp.active) {
                if (now > globalEffects.obstacleSpeedUp.endTime) {
                    globalEffects.obstacleSpeedUp.active = false;
                }
            }
            
            // Èõ∑‰∫ëÊïàÊûú
            if (globalEffects.thunderCloud.active) {
                if (now > globalEffects.thunderCloud.endTime) {
                    globalEffects.thunderCloud.active = false;
                } else {
                    // Êõ¥Êñ∞Èó™ÁîµÊó∂Èó¥
                    if (now > globalEffects.thunderCloud.flashTime) {
                        globalEffects.thunderCloud.flashTime = now + 1000 + Math.random() * 2000;
                    }
                }
            }
            
            // Êñ∞Â¢ûÊïàÊûúÊõ¥Êñ∞
            // ‰∏çÊ≠ªÂõæËÖæÊïàÊûú
            if (globalEffects.immortalTotem.active) {
                if (now > globalEffects.immortalTotem.endTime) {
                    globalEffects.immortalTotem.active = false;
                    globalEffects.immortalTotem.triggeredBy = null;
                    
                    // ÁªìÊùüRGBÂèòËâ≤ÊïàÊûú
                    const triggeredBy = globalEffects.immortalTotem.triggeredBy;
                    if (triggeredBy === 'player') {
                        player.glowEffect = false;
                        player.glowEndTime = 0;
                    } else if (triggeredBy === 'computer') {
                        computer.glowEffect = false;
                        computer.glowEndTime = 0;
                    }
                }
            }
            
            // ‰∫ã‰ª∂ÁãÇÊΩÆÊïàÊûú
            if (globalEffects.eventFrenzy.active) {
                if (now > globalEffects.eventFrenzy.endTime) {
                    globalEffects.eventFrenzy.active = false;
                }
            }
            
            // Â§©Â†ÇÂà∂ÈÄ†ÊïàÊûú
            if (globalEffects.heavenMaker.active) {
                if (now > globalEffects.heavenMaker.endTime) {
                    // ÊÅ¢Â§çÁêÉÁöÑÂ§ßÂ∞èÂíåÈÄüÂ∫¶
                    for (let i = 0; i < globalEffects.heavenMaker.stackCount; i++) {
                        ball.radius = Math.min(ball.radius * 2, 50); // ÊÅ¢Â§çÂ§ßÂ∞è
                        ball.speedMultiplier /= 1.25; // ÊÅ¢Â§çÈÄüÂ∫¶
                    }
                    globalEffects.heavenMaker.active = false;
                    globalEffects.heavenMaker.stackCount = 0;
                }
            }
            
            // Ê≤âÈáçÊïàÊûú
            if (globalEffects.heavyBall.active) {
                if (now > globalEffects.heavyBall.endTime) {
                    // ÊÅ¢Â§çÁêÉÁöÑÂ§ßÂ∞èÂíåÈÄüÂ∫¶
                    for (let i = 0; i < globalEffects.heavyBall.stackCount; i++) {
                        ball.radius = Math.max(ball.radius * 0.5, 3); // ÊÅ¢Â§çÂ§ßÂ∞è
                        ball.speedMultiplier /= 0.8; // ÊÅ¢Â§çÈÄüÂ∫¶
                    }
                    globalEffects.heavyBall.active = false;
                    globalEffects.heavyBall.stackCount = 0;
                }
            }
            
            // Êõ¥Êñ∞Êå°ÊùøÊïàÊûú
            if (now > player.glowEndTime) {
                player.glowEffect = false;
                if (player.height !== player.originalHeight) {
                    player.height = player.originalHeight;
                }
            }
            
            if (now > computer.glowEndTime) {
                computer.glowEffect = false;
                if (computer.height !== computer.originalHeight) {
                    computer.height = computer.originalHeight;
                }
            }

            // Ê∑ªÂä†rgbÊïàÊûúÊõ¥Êñ∞
            if (now > player.rgbEndTime) {
                player.rgbEffect = false;
            }

            if (now > computer.rgbEndTime) {
                computer.rgbEffect = false;
            }
        }

        // ÁªòÂà∂ÂúÜÂΩ¢ÔºàÁî®‰∫éÁêÉÂíåÁ≤íÂ≠êÔºâ
        function drawCircle(x, y, radius, color, alpha = 1.0) {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2, false);

            // Ê∑ªÂä†ÂèëÂÖâÊïàÊûú
            const gradient = ctx.createRadialGradient(
                x, y, 0,
                x, y, radius
            );
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, 'rgba(101, 80, 255, 0)');

            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        }

        // ÁªòÂà∂Êå°Êùø
        function drawPaddle(x, y, width, height, color, glowEffect = false, rgbEffect = false) {
            if (rgbEffect) {
                // ‰ΩøÁî®RGBÊïàÊûúÁªòÂà∂Êå°Êùø
                drawPaddleRGB(x, y, width, height);
                return;
            }

            ctx.save();
            
            // Â¶ÇÊûúÊúâÂèëÂÖâÊïàÊûúÔºåÂÖàÁªòÂà∂ÂèëÂÖâ
            if (glowEffect) {
                ctx.shadowColor = '#ffff00';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
            
            ctx.beginPath();
            ctx.rect(x, y, width, height);

            // ÂàõÂª∫Ê∏êÂèòÊïàÊûú
            const gradient = ctx.createLinearGradient(x, y, x + width, y);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, glowEffect ? '#ffff88' : '#a0a8ff');

            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();

            // Ê∑ªÂä†ËæπÊ°ÜÂèëÂÖâ
            ctx.beginPath();
            ctx.rect(x - 2, y - 2, width + 4, height + 4);
            ctx.strokeStyle = glowEffect ? 'rgba(255, 255, 0, 0.8)' : 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = glowEffect ? 2 : 1;
            ctx.stroke();
            ctx.closePath();
            
            ctx.restore();
        }

        // ÁªòÂà∂RGBÊå°ÊùøÊïàÊûú
        function drawPaddleRGB(x, y, width, height) {
            ctx.save();

            // ÂàõÂª∫ÈöèÊó∂Èó¥ÂèòÂåñÁöÑRGBÊïàÊûú
            const hue = (Date.now() / 5) % 360;
            const color1 = `hsl(${hue}, 100%, 60%)`;
            const color2 = `hsl(${(hue + 120) % 360}, 100%, 60%)`;
            const color3 = `hsl(${(hue + 240) % 360}, 100%, 60%)`;

            // ÂàõÂª∫‰∏âËâ≤Ê∏êÂèò
            const gradient = ctx.createLinearGradient(x, y, x + width, y + height);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(0.5, color2);
            gradient.addColorStop(1, color3);

            // ÁªòÂà∂Êå°Êùø‰∏ª‰Ωì
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, width, height);

            // Ê∑ªÂä†ÂèëÂÖâËæπÊ°Ü
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#ffffff';
            ctx.shadowBlur = 15;
            ctx.strokeRect(x - 2, y - 2, width + 4, height + 4);

            ctx.restore();
        }

        // ÁªòÂà∂ÁêÉËΩ®Ëøπ
        function drawBallTrail() {
            for (let i = 0; i < ball.trail.length; i++) {
                const alpha = (i / ball.trail.length) * ball.alpha;
                const radius = ball.radius * alpha;

                ctx.save();
                ctx.globalAlpha = alpha * 0.6;
                ctx.beginPath();
                ctx.arc(ball.trail[i].x, ball.trail[i].y, radius, 0, Math.PI * 2);
                ctx.fillStyle = ball.color;
                ctx.fill();
                ctx.closePath();
                ctx.restore();
            }
        }

        // ÁªòÂà∂ÁΩëÊ†ºËÉåÊôØ
        function drawGrid() {
            const gridSize = 30;
            ctx.strokeStyle = 'rgba(101, 80, 255, 0.1)';
            ctx.lineWidth = 1;

            // ÂûÇÁõ¥Á∫ø
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // Ê∞¥Âπ≥Á∫ø
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // ÁªòÂà∂Á≤íÂ≠ê
        function drawParticles() {
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];

                // Êõ¥Êñ∞Á≤íÂ≠ê‰ΩçÁΩÆ
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;
                p.life--;

                // ÁªòÂà∂Á≤íÂ≠ê
                ctx.save();
                ctx.globalAlpha = p.life / 30;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.closePath();
                ctx.restore();

                // ÁßªÈô§Ê≠ª‰∫°Á≤íÂ≠ê
                if (p.life <= 0) {
                    particles.splice(i, 1);
                    i--;
                }
            }
        }

        // ÁªòÂà∂ÈöúÁ¢çÁâ©
        function drawObstacles() {
            for (const obs of obstacles) {
                if (!obs.active) {
                    // ÁªòÂà∂È¢ÑË≠¶ÊïàÊûú
                    const warningSize = obs.size * (1 + obs.warningProgress * 0.5);
                    const alpha = 0.3 + obs.warningProgress * 0.4;

                    ctx.save();
                    ctx.globalAlpha = alpha;
                    ctx.beginPath();
                    if (obs.type === 'circle') {
                        ctx.arc(obs.x, obs.y, warningSize, 0, Math.PI * 2);
                    } else {
                        ctx.rect(
                            obs.x - warningSize / 2,
                            obs.y - warningSize / 2,
                            warningSize,
                            warningSize
                        );
                    }

                    ctx.fillStyle = 'rgba(255, 100, 100, 1)';
                    ctx.fill();
                    ctx.closePath();
                    ctx.restore();
                } else {
                    // ÁªòÂà∂ÊøÄÊ¥ªÁöÑÈöúÁ¢çÁâ©
                    ctx.beginPath();

                    if (obs.type === 'circle') {
                        ctx.arc(obs.x, obs.y, obs.size, 0, Math.PI * 2);
                    } else {
                        ctx.rect(
                            obs.x - obs.size / 2,
                            obs.y - obs.size / 2,
                            obs.size,
                            obs.size
                        );
                    }

                    // ÂàõÂª∫Ê∏êÂèòÂ°´ÂÖÖ
                    const gradient = ctx.createRadialGradient(
                        obs.x, obs.y, 0,
                        obs.x, obs.y, obs.size
                    );
                    gradient.addColorStop(0, 'rgba(255, 80, 80, 0.8)');
                    gradient.addColorStop(1, 'rgba(200, 50, 50, 0.4)');

                    ctx.fillStyle = gradient;
                    ctx.fill();

                    // Ê∑ªÂä†ÂèëÂÖâËæπÊ°Ü
                    ctx.strokeStyle = 'rgba(255, 150, 150, 0.7)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                }
            }
        }

        // ÁªòÂà∂‰∫ã‰ª∂
        function drawEvents() {
            for (const event of events) {
                const pulseSize = event.radius * (1 + 0.3 * Math.sin(event.pulsePhase));
                const alpha = 0.8 + 0.2 * Math.sin(event.pulsePhase * 2);
                
                ctx.save();
                ctx.globalAlpha = alpha;
                
                // ÁªòÂà∂Â§ñÂúàÂèëÂÖâ
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = event.typeData.color + '40'; // Ê∑ªÂä†ÈÄèÊòéÂ∫¶
                ctx.fill();
                ctx.closePath();
                
                // ÁªòÂà∂‰∏ª‰Ωì
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize, 0, Math.PI * 2);
                ctx.fillStyle = event.typeData.color;
                ctx.fill();
                ctx.closePath();
                
                // ÁªòÂà∂ËæπÊ°Ü
                ctx.beginPath();
                ctx.arc(event.x, event.y, pulseSize, 0, Math.PI * 2);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.closePath();
                
                ctx.restore();
            }
        }

        // ÁªòÂà∂Èõ∑‰∫ë
        function drawThunderCloud() {
            if (!globalEffects.thunderCloud.active) return;

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cloudWidth = canvas.width * 0.45;
            const cloudHeight = canvas.height * 0.45;

            ctx.save();

            // ÂàùÂßãÂåñÁä∂ÊÄÅÔºàÁ°Æ‰øùÂ§öÊ¨°Ë∞ÉÁî®Áä∂ÊÄÅ‰∏ÄËá¥Ôºâ
            if (!globalEffects.thunderCloud.particles) {
                globalEffects.thunderCloud.particles = [];
                globalEffects.thunderCloud.dataStreams = [];
                globalEffects.thunderCloud.lastUpdate = Date.now();
            }

            // Êõ¥Êñ∞Êó∂Èó¥Áä∂ÊÄÅ
            const now = Date.now();
            const deltaTime = now - (globalEffects.thunderCloud.lastUpdate || now);
            globalEffects.thunderCloud.lastUpdate = now;

            // Êõ¥Êñ∞Êï∞ÊçÆÊµÅÁ≤íÂ≠ê
            updateDataStreams(centerX, centerY, cloudWidth, cloudHeight, deltaTime);

            // ÁªòÂà∂Âä®ÊÄÅ‰∫ëÊúµÔºà‰ΩøÁî®Â§ö‰∏™Âè†Âä†ÂúÜÂΩ¢Ôºâ
            drawDynamicCloud(centerX, centerY, cloudWidth, cloudHeight);

            // ÁªòÂà∂Êï∞ÊçÆÊµÅÔºàÈªëÂÆ¢È£éÊ†ºÁªøËâ≤‰ª£Á†ÅÔºâ
            drawHackerDataStreams();

            // Èó™ÁîµÊïàÊûúÔºàÂ∏¶ÈöèÊú∫ÂàÜÊîØÔºâ
            const flashActive = now < globalEffects.thunderCloud.flashTime;
            if (flashActive) {
                drawLightningBranches(centerX, centerY, cloudWidth, cloudHeight);
            }

            ctx.restore();
        }

        // ËæÖÂä©ÂáΩÊï∞ÂÆö‰πâ
        function updateDataStreams(centerX, centerY, cloudWidth, cloudHeight, deltaTime) {
            const sec = deltaTime / 1000;

            // Ê∑ªÂä†Êñ∞Á≤íÂ≠ê - ‰øÆÊîπ‰ª•‰∏ãÂèÇÊï∞
            if (globalEffects.thunderCloud.dataStreams.length < 30 && Math.random() > 0.7) {
                globalEffects.thunderCloud.dataStreams.push({
                    x: centerX + (Math.random() - 0.5) * cloudWidth,
                    y: centerY - cloudHeight * 0.6, // ‰ªéÊõ¥‰∏äÊñπÂºÄÂßãÔºàÂéüÊù•ÊòØ - cloudHeight/2Ôºâ
                    chars: generateRandomBinary(3 + Math.floor(Math.random() * 4)), // Áº©Áü≠Êï∞ÊçÆÊµÅÈïøÂ∫¶Ôºà3-6‰∏™Â≠óÁ¨¶Ôºâ
                    speed: 50 + Math.random() * 50, // Âä†Âø´ÈÄüÂ∫¶Ôºà50-100Ôºâ
                    alpha: 0.1 + Math.random() * 0.4, // Èôç‰ΩéÈÄèÊòéÂ∫¶Ôºà0.1-0.5Ôºâ
                    life: 1 + Math.random() * 1.5 // Êõ¥Âø´Ê∂àÂ§±Ôºà1-2.5ÁßíÔºâ
                });
            }

            // Êõ¥Êñ∞Áé∞ÊúâÁ≤íÂ≠ê
            globalEffects.thunderCloud.dataStreams.forEach((stream, index) => {
                stream.y += stream.speed * sec;
                stream.life -= sec;

                // ÁßªÈô§Â±èÂπïÂ§ñÊàñÁîüÂëΩÂë®ÊúüÁªìÊùüÁöÑÁ≤íÂ≠ê
                if (stream.y > centerY + cloudHeight || stream.life <= 0) {
                    globalEffects.thunderCloud.dataStreams.splice(index, 1);
                }
            });
        }

        function drawDynamicCloud(centerX, centerY, cloudWidth, cloudHeight) {
            ctx.globalAlpha = 0.3;

            // ÂàõÂª∫Â§öÂ±Ç‰∫ëÊúµÊïàÊûú
            for (let i = 0; i < 15; i++) {
                const radius = cloudWidth * 0.1 + Math.random() * cloudWidth * 0.1;
                const x = centerX + (Math.random() - 0.5) * cloudWidth * 0.8;
                const y = centerY + (Math.random() - 0.5) * cloudHeight * 0.8;

                const gradient = ctx.createRadialGradient(
                    x, y, 0,
                    x, y, radius
                );

                // ËµõÂçöÊúãÂÖãÈ£éÊ†ºÊ∏êÂèò
                gradient.addColorStop(0, 'rgba(0, 100, 50, 0.6)');
                gradient.addColorStop(1, 'rgba(0, 20, 10, 0.1)');

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }

        function drawHackerDataStreams() {
            ctx.font = '10px "Courier New", monospace';
            ctx.textAlign = 'left';

            globalEffects.thunderCloud.dataStreams.forEach(stream => {
                ctx.save();
                ctx.globalAlpha = stream.alpha;
                ctx.fillStyle = '#00FF66';

                // ÁªòÂà∂‰∫åËøõÂà∂Êï∞ÊçÆÊµÅ
                stream.chars.split('').forEach((char, i) => {
                    ctx.fillText(char, stream.x, stream.y + i * 12);
                });

                ctx.restore();
            });
        }

        function drawLightningBranches(centerX, centerY, cloudWidth, cloudHeight) {
            ctx.globalAlpha = 0.6;

            // ÁîüÊàê‰∏ªÈó™ÁîµË∑ØÂæÑ
            const path = generateLightningPath(
                centerX + (Math.random() - 0.5) * cloudWidth * 0.5,
                centerY - cloudHeight * 0.4,
                centerX + (Math.random() - 0.5) * cloudWidth * 0.5,
                centerY + cloudHeight * 0.4
            );

            // ÁªòÂà∂‰∏ªÈó™Áîµ
            drawLightning(path, 3);

            // ÁîüÊàêÂàÜÊîØÈó™ÁîµÔºà1-3‰∏™Ôºâ
            const branchCount = 1 + Math.floor(Math.random() * 3);
            for (let i = 0; i < branchCount; i++) {
                const branchPoint = path[Math.floor(path.length * (i + 1) / (branchCount + 1))];
                const branchPath = generateLightningPath(
                    branchPoint.x,
                    branchPoint.y,
                    branchPoint.x + (Math.random() - 0.5) * cloudWidth * 0.3,
                    branchPoint.y + cloudHeight * 0.2
                );
                drawLightning(branchPath, 2);
            }
        }

        function generateLightningPath(startX, startY, endX, endY) {
            const segments = 8;
            const path = [{x: startX, y: startY}];
            const variance = canvas.width * 0.05;

            for (let i = 1; i <= segments; i++) {
                const t = i / segments;
                const baseX = startX + (endX - startX) * t;
                const baseY = startY + (endY - startY) * t;

                path.push({
                    x: baseX + (Math.random() - 0.5) * variance * (1 - t),
                    y: baseY + (Math.random() - 0.5) * variance * (1 - t)
                });
            }

            path.push({x: endX, y: endY});
            return path;
        }

        function drawLightning(path, lineWidth) {
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);

            // ÂàõÂª∫Èó™ÁîµÊäñÂä®ÊïàÊûú
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }

            // ËµõÂçöÊúãÂÖãÈ£éÊ†ºÂèëÂÖâÊïàÊûú
            ctx.strokeStyle = '#66FFFF';
            ctx.lineWidth = lineWidth;
            ctx.shadowColor = '#00FF99';
            ctx.shadowBlur = 15;
            ctx.stroke();

            // ÈáçÁΩÆÈò¥ÂΩ±
            ctx.shadowBlur = 0;
        }

        function generateRandomBinary(length) {
            return Array.from({length}, () => Math.random() > 0.5 ? '1' : '0').join('');
        }

        // ÈáçÁΩÆÁêÉ‰ΩçÁΩÆ
        function resetBall() {
            // ‰øùÂ≠òÂéüÂßãÈÄüÂ∫¶ÊñπÂêë
            const originalVelocityX = ball.velocityX;
            const originalVelocityY = ball.velocityY;

            // ÈáçÁΩÆÁêÉ‰ΩçÁΩÆÂíåÈÄüÂ∫¶
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 4;
            ball.velocityX = Math.random() > 0.5 ? 5 : -5;
            ball.velocityY = Math.random() * 4 - 2;
            ball.trail = [];
            isResetting = false;

            // ÈáçÁΩÆÊ≠ªÁêÉÊ£ÄÊµã
            ballStuckDetection.lastY = ball.y;
            ballStuckDetection.stuckTime = 0;
            ballStuckDetection.lastCheckTime = Date.now();

            // Èò≤Ê≠¢ÁêÉÂú®ÈöúÁ¢çÁâ©‰∏äÈáçÁîü
            let safePositionFound = false;
            let attempts = 0;
            const maxAttempts = 30;
            const safeRadius = ball.radius * 2; // ÂÆâÂÖ®Ë∑ùÁ¶ªÂçäÂæÑ

            while (!safePositionFound && attempts < maxAttempts) {
                // ÊñπÊ≥ï1ÔºöÂ∞ùËØïÂú®‰∏≠ÂøÉÈôÑËøëÈöèÊú∫‰ΩçÁΩÆÁîüÊàê
                if (attempts < 20) {
                    ball.x = canvas.width / 2 + (Math.random() - 0.5) * (canvas.width / 4);
                    ball.y = canvas.height / 2 + (Math.random() - 0.5) * (canvas.height / 4);
                }
                // ÊñπÊ≥ï2ÔºöÂêëÈáèÂè†Âä†Ë∞ÉÊï¥ÔºàÂâç20Ê¨°Â§±Ë¥•ÂêéÂêØÁî®Ôºâ
                else {
                    let totalDx = 0;
                    let totalDy = 0;
                    let collisionCount = 0;

                    for (const obs of obstacles) {
                        if (obs.active && obstacleCollision(ball, obs)) {
                            const dx = ball.x - obs.x;
                            const dy = ball.y - obs.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const minDistance = ball.radius + obs.size + safeRadius;

                            if (distance < minDistance) {
                                const angle = Math.atan2(dy, dx);
                                const moveDistance = minDistance - distance;
                                totalDx += moveDistance * Math.cos(angle);
                                totalDy += moveDistance * Math.sin(angle);
                                collisionCount++;
                            }
                        }
                    }

                    if (collisionCount > 0) {
                        // Ê†áÂáÜÂåñÊÄª‰ΩçÁßªÂêëÈáè
                        const totalMove = Math.sqrt(totalDx * totalDx + totalDy * totalDy);
                        ball.x += (totalDx / collisionCount) * 1.2;
                        ball.y += (totalDy / collisionCount) * 1.2;
                    }
                }

                // ËæπÁïåÊ£ÄÊü•
                ball.x = Math.max(ball.radius, Math.min(canvas.width - ball.radius, ball.x));
                ball.y = Math.max(ball.radius, Math.min(canvas.height - ball.radius, ball.y));

                // ÊúÄÁªàÁ¢∞ÊíûÊ£ÄÊü•
                safePositionFound = true;
                for (const obs of obstacles) {
                    if (obs.active && obstacleCollision(ball, obs)) {
                        safePositionFound = false;
                        break;
                    }
                }

                attempts++;
            }
        }

        // Á¢∞ÊíûÊ£ÄÊµã - Êå°Êùø
        function collision(b, p) {
            return (
                b.x + b.radius > p.x &&
                b.x - b.radius < p.x + p.width &&
                b.y + b.radius > p.y &&
                b.y - b.radius < p.y + p.height
            );
        }

        // Á¢∞ÊíûÊ£ÄÊµã - ÈöúÁ¢çÁâ©
        function obstacleCollision(ball, obstacle) {
            if (!obstacle.active) return false;

            if (obstacle.type === 'circle') {
                // ÂúÜÂΩ¢ÈöúÁ¢çÁâ©Á¢∞ÊíûÊ£ÄÊµã
                const dx = ball.x - obstacle.x;
                const dy = ball.y - obstacle.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                return distance < ball.radius + obstacle.size;
            } else {
                // Áü©ÂΩ¢ÈöúÁ¢çÁâ©Á¢∞ÊíûÊ£ÄÊµã
                const halfSize = obstacle.size / 2;
                const closestX = Math.max(obstacle.x - halfSize, Math.min(ball.x, obstacle.x + halfSize));
                const closestY = Math.max(obstacle.y - halfSize, Math.min(ball.y, obstacle.y + halfSize));

                const dx = ball.x - closestX;
                const dy = ball.y - closestY;

                return (dx * dx + dy * dy) < (ball.radius * ball.radius);
            }
        }

        // Á¢∞ÊíûÊ£ÄÊµã - ‰∫ã‰ª∂
        function eventCollision(ball, event) {
            const dx = ball.x - event.x;
            const dy = ball.y - event.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < ball.radius + event.radius;
        }

        // Â§ÑÁêÜÁêÉ‰∏éÈöúÁ¢çÁâ©ÁöÑÁ¢∞Êíû
        function handleObstacleCollision() {
            for (const obs of obstacles) {
                if (obstacleCollision(ball, obs)) {
                    // ÂàõÂª∫Á¢∞ÊíûÁ≤íÂ≠ê
                    createParticles(ball.x, ball.y, '#ff6666', 30);

                    if (obs.type === 'circle') {
                        // ÂúÜÂΩ¢ÈöúÁ¢çÁâ©Á¢∞ÊíûÂèçÂºπ
                        const dx = ball.x - obs.x;
                        const dy = ball.y - obs.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // Ê≥ïÁ∫øÂêëÈáè
                        const nx = dx / distance;
                        const ny = dy / distance;

                        // ËÆ°ÁÆóÁÇπÁßØ
                        const dot = ball.velocityX * nx + ball.velocityY * ny;

                        // ÂèçÂ∞ÑÂêëÈáè
                        ball.velocityX = ball.velocityX - 2 * dot * nx;
                        ball.velocityY = ball.velocityY - 2 * dot * ny;
                    } else {
                        // Áü©ÂΩ¢ÈöúÁ¢çÁâ©Á¢∞ÊíûÂèçÂºπ
                        const halfSize = obs.size / 2;

                        // ËÆ°ÁÆóÁêÉÁõ∏ÂØπ‰∫éÈöúÁ¢çÁâ©‰∏≠ÂøÉÁöÑÂêëÈáè
                        const dx = ball.x - obs.x;
                        const dy = ball.y - obs.y;

                        // Âà§Êñ≠Á¢∞ÊíûÂèëÁîüÂú®Áü©ÂΩ¢ÁöÑÂì™‰∏Ä‰æß
                        if (Math.abs(dx) > Math.abs(dy)) {
                            // Ê∞¥Âπ≥Á¢∞Êíû
                            ball.velocityX = -ball.velocityX;

                            // Ë∞ÉÊï¥‰ΩçÁΩÆÈò≤Ê≠¢Âç°‰Ωè
                            if (dx > 0) {
                                ball.x = obs.x + halfSize + ball.radius;
                            } else {
                                ball.x = obs.x - halfSize - ball.radius;
                            }
                        } else {
                            // ÂûÇÁõ¥Á¢∞Êíû
                            ball.velocityY = -ball.velocityY;

                            // Ë∞ÉÊï¥‰ΩçÁΩÆÈò≤Ê≠¢Âç°‰Ωè
                            if (dy > 0) {
                                ball.y = obs.y + halfSize + ball.radius;
                            } else {
                                ball.y = obs.y - halfSize - ball.radius;
                            }
                        }
                    }

                    // Â¢ûÂä†ÁêÉÈÄü
                    ball.speed += 0.025;

                    // ËÆ∞ÂΩïÁ¢∞ÊíûÊó∂Èó¥
                    ball.lastCollision = Date.now();

                    return true;
                }
            }
            return false;
        }

        // Â§ÑÁêÜÁêÉ‰∏é‰∫ã‰ª∂ÁöÑÁ¢∞Êíû
        function handleEventCollision() {
            for (let i = events.length - 1; i >= 0; i--) {
                const event = events[i];
                if (eventCollision(ball, event)) {
                    // Ëß¶Âèë‰∫ã‰ª∂ÊïàÊûú
                    if (lastTouchedBy) {
                        triggerEvent(event, lastTouchedBy);
                    }
                    
                    // ÁßªÈô§‰∫ã‰ª∂
                    events.splice(i, 1);
                    return true;
                }
            }
            return false;
        }

        // Â§ÑÁêÜÈõ∑‰∫ëÂØπÁêÉÁöÑÂΩ±Âìç
        function handleThunderCloudEffect() {
            if (!globalEffects.thunderCloud.active) return;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const cloudWidth = canvas.width * 0.3;
            const cloudHeight = canvas.height * 0.3;
            
            // Ê£ÄÊü•ÁêÉÊòØÂê¶Âú®Èõ∑‰∫ëÂå∫ÂüüÂÜÖ
            if (ball.x > centerX - cloudWidth / 2 && 
                ball.x < centerX + cloudWidth / 2 &&
                ball.y > centerY - cloudHeight / 2 && 
                ball.y < centerY + cloudHeight / 2) {
                
                // ÈöèÊú∫ÊîπÂèòÁêÉÁöÑËßíÂ∫¶ -10Âà∞10Â∫¶
                const angleChange = (Math.random() - 0.5) * 20 * Math.PI / 180;
                const currentAngle = Math.atan2(ball.velocityY, ball.velocityX);
                const newAngle = currentAngle + angleChange;
                const speed = Math.sqrt(ball.velocityX * ball.velocityX + ball.velocityY * ball.velocityY);
                
                ball.velocityX = speed * Math.cos(newAngle);
                ball.velocityY = speed * Math.sin(newAngle);
                
                // Ëß¶ÂèëÈó™ÁîµÊïàÊûú
                globalEffects.thunderCloud.flashTime = Date.now() + 200;
            }
        }

        // Ê£ÄÊü•ÁêÉÊòØÂê¶Âç°Âú®ÈöúÁ¢çÁâ©‰∏≠ÔºåÂ¶ÇÊûúÊòØÂàôÊ†°Ê≠£‰ΩçÁΩÆ
        function correctBallPosition() {
            for (const obs of obstacles) {
                if (!obs.active) continue;

                // ËÆ°ÁÆóÁêÉ‰∏éÈöúÁ¢çÁâ©ÁöÑË∑ùÁ¶ªÂíåÊñπÂêë
                const dx = ball.x - obs.x;
                const dy = ball.y - obs.y;

                if (obs.type === 'circle') {
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDistance = ball.radius + obs.size;

                    if (distance < minDistance) {
                        // ËÆ°ÁÆóÈúÄË¶ÅÁßªÂä®ÁöÑÊñπÂêë
                        const angle = Math.atan2(dy, dx);
                        const moveDistance = minDistance - distance;

                        // Â∞ÜÁêÉÁßªÂä®Âà∞ÈöúÁ¢çÁâ©ËæπÁºò
                        ball.x += Math.cos(angle) * moveDistance;
                        ball.y += Math.sin(angle) * moveDistance;
                    }
                } else {
                    // Áü©ÂΩ¢ÈöúÁ¢çÁâ©Â§ÑÁêÜ
                    const halfSize = obs.size / 2;
                    const overlapX = Math.abs(dx) - (ball.radius + halfSize);
                    const overlapY = Math.abs(dy) - (ball.radius + halfSize);

                    if (overlapX < 0 && overlapY < 0) {
                        // Á°ÆÂÆöÊúÄÂ∞èÈáçÂè†ÊñπÂêë
                        if (Math.abs(overlapX) < Math.abs(overlapY)) {
                            // XËΩ¥ÊñπÂêëÈáçÂè†ËæÉÂ∞èÔºåÊ≤øXËΩ¥ÁßªÂä®
                            ball.x += dx > 0 ? -overlapX : overlapX;
                        } else {
                            // YËΩ¥ÊñπÂêëÈáçÂè†ËæÉÂ∞èÔºåÊ≤øYËΩ¥ÁßªÂä®
                            ball.y += dy > 0 ? -overlapY : overlapY;
                        }
                    }
                }
            }
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
        function update(dt) {
            if (isGameOver || isPaused) return; // Ê∑ªÂä†ÊöÇÂÅúÊ£ÄÊü•

            // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂Èó¥ÔºàÊØèÂ∏ßÁ∫¶16msÔºâ
            gameTime += dt;

            // Ê≠ªÁêÉÊ£ÄÊµã
            if (checkDeadBall()) {
                showDeadBallNotification();
                resetBall();
                // ÈáçÁΩÆÁêÉ‰ΩÜ‰∏çËÆ°ÂàÜ
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁîüÊàêÊñ∞ÈöúÁ¢çÁâ©
            let obstacleInterval = 15000; // ÈªòËÆ§15Áßí
            if (globalEffects.obstacleSpeedUp.active) {
                obstacleInterval *= 0.2; // ÂáèÂ∞ëÂà∞20%
            }

            if (gameTime >= nextObstacleTime) {
                createObstacles();
                nextObstacleTime = gameTime + obstacleInterval + Math.random() * 5000;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁîüÊàêÊñ∞‰∫ã‰ª∂
            if (gameTime >= nextEventTime) {
                createEvent();
                // ËÆæÁΩÆ‰∏ã‰∏ÄÊ¨°‰∫ã‰ª∂Âá∫Áé∞Êó∂Èó¥Ôºö5-30ÁßíÂêé
                let eventInterval = 5000 + Math.random() * 25000;

                // ‰∫ã‰ª∂ÁãÇÊΩÆÊïàÊûúÔºö‰∫ã‰ª∂Âà∑Êñ∞ÁéáÂ¢ûÂä†‰∏∫400%
                if (globalEffects.eventFrenzy.active) {
                    eventInterval *= 0.25; // ÂáèÂ∞ëÂà∞25%ÔºåÂç≥400%ÁöÑÂà∑Êñ∞Áéá
                }

                nextEventTime = gameTime + eventInterval;
            }

            // Êõ¥Êñ∞ÂêÑÁßçÁä∂ÊÄÅ
            updateObstacles();
            updateEvents();
            updateGlobalEffects();

            // Ê£ÄÊü•Âπ∂Ê†°Ê≠£ÁêÉÁöÑ‰ΩçÁΩÆÔºåÈò≤Ê≠¢Âç°Âú®ÈöúÁ¢çÁâ©‰∏≠
            correctBallPosition();

            // Êõ¥Êñ∞ÁêÉËΩ®Ëøπ
            ball.trail.push({x: ball.x, y: ball.y});
            if (ball.trail.length > 10) {
                ball.trail.shift();
            }

            // ÁßªÂä®ÁêÉ
            const effectiveSpeed = ball.speed * ball.speedMultiplier;
            const velocityMagnitude = Math.sqrt(ball.velocityX * ball.velocityX + ball.velocityY * ball.velocityY);
            ball.x += (ball.velocityX / velocityMagnitude) * effectiveSpeed * (dt / FRAME_INTERVAL);
            ball.y += (ball.velocityY / velocityMagnitude) * effectiveSpeed * (dt / FRAME_INTERVAL);

            // ÁÆÄÂçïÁöÑÁîµËÑëAI - Ë∑üÈöèÁêÉÁßªÂä®
            const effectiveComputerSpeed = computer.speed * computer.speedMultiplier;
            if (computer.y + (computer.height / 2) < ball.y) {
                computer.y += effectiveComputerSpeed;
            } else {
                computer.y -= effectiveComputerSpeed;
            }

            // Á°Æ‰øùÁîµËÑëÊå°Êùø‰∏ç‰ºöË∂ÖÂá∫ËæπÁïå
            if (computer.y < 0) {
                computer.y = 0;
            } else if (computer.y + computer.height > canvas.height) {
                computer.y = canvas.height - computer.height;
            }

            // Á°Æ‰øùÁé©ÂÆ∂Êå°Êùø‰∏ç‰ºöË∂ÖÂá∫ËæπÁïå
            if (player.y < 0) {
                player.y = 0;
            } else if (player.y + player.height > canvas.height) {
                player.y = canvas.height - player.height;
            }

            // ‰∏ä‰∏ãËæπÁïåÂèçÂºπ
            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
                ball.velocityY = -ball.velocityY;

                // ËæπÁïåÁ¢∞ÊíûÁ≤íÂ≠êÊïàÊûú
                createParticles(
                    ball.x,
                    ball.y < ball.radius ? 0 : canvas.height,
                    '#ffffff'
                );
            }

            // Â§ÑÁêÜÈõ∑‰∫ëÊïàÊûú
            handleThunderCloudEffect();

            // Â§ÑÁêÜÁêÉ‰∏é‰∫ã‰ª∂ÁöÑÁ¢∞Êíû
            const hitEvent = handleEventCollision();

            // Â§ÑÁêÜÁêÉ‰∏éÈöúÁ¢çÁâ©ÁöÑÁ¢∞Êíû
            const hitObstacle = handleObstacleCollision();

            // Â¶ÇÊûúÊ≤°ÊúâÁ¢∞Âà∞ÈöúÁ¢çÁâ©Êàñ‰∫ã‰ª∂ÔºåÊ£ÄÊü•Êå°ÊùøÁ¢∞Êíû
            if (!hitObstacle && !hitEvent) {
                // Á°ÆÂÆöÁêÉ‰∏éÂì™‰∏™Êå°ÊùøÁ¢∞Êíû
                const paddle = ball.x < canvas.width / 2 ? player : computer;
                const paddleOwner = ball.x < canvas.width / 2 ? 'player' : 'computer';
                const currentTime = Date.now();

                // Ê∑ªÂä†Èò≤Âç°È°øÊú∫Âà∂ÔºöÂêå‰∏ÄÊå°ÊùøÂú®50msÂÜÖÂè™ÂÖÅËÆ∏Á¢∞Êíû‰∏ÄÊ¨°
                if (collision(ball, paddle) && currentTime - ball.lastCollision > 50) {
                    // ËÆ∞ÂΩïËß¶ÁêÉËÄÖ
                    lastTouchedBy = paddleOwner;

                    // ÁêÉÂáª‰∏≠Êå°ÊùøÁöÑ‰ΩçÁΩÆÔºà‰ªé-0.5Âà∞0.5Ôºâ
                    const hitPoint = (ball.y - (paddle.y + paddle.height / 2)) / (paddle.height / 2);

                    // ËÆ°ÁÆóÂèçÂºπËßíÂ∫¶ÔºàÂü∫‰∫éÂáª‰∏≠‰ΩçÁΩÆÔºâ
                    let angle = hitPoint * (Math.PI / 4);

                    // ÁîµËÑëÂõûÁêÉÂ¢ûÂº∫ÂäüËÉΩ
                    if (aiEnhancementEnabled && paddleOwner === 'computer') {
                        // ÁîüÊàê-75Âà∞75Â∫¶ÁöÑÈöèÊú∫ËßíÂ∫¶
                        const randomAngle = (Math.random() - 0.5) * (120 * Math.PI / 180); // -60Âà∞60Â∫¶ËΩ¨Êç¢‰∏∫ÂºßÂ∫¶
                        angle = randomAngle;
                    }

                    // Á°ÆÂÆöÊñπÂêë
                    const direction = ball.x < canvas.width / 2 ? 1 : -1;

                    // Êõ¥Êñ∞ÁêÉÁöÑÈÄüÂ∫¶
                    ball.velocityX = direction * ball.speed * Math.cos(angle);
                    ball.velocityY = ball.speed * Math.sin(angle);

                    // Â¢ûÂä†ÁêÉÈÄü
                    ball.speed += 0.025;

                    // Èõ∑ÁîµÊùøÂ≠êÊïàÊûú
                    if (paddle.glowEffect) {
                        ball.speed *= 1.8; // Â¢ûÂä†80%ÈÄüÂ∫¶
                        setTimeout(() => {
                            ball.speed /= 1.8; // 0.8ÁßíÂêéÊÅ¢Â§ç
                        }, 800);
                    }

                    // ÂàõÂª∫Á¢∞ÊíûÁ≤íÂ≠ê
                    createParticles(ball.x, ball.y, paddle.color);

                    // ËÆ∞ÂΩïÁ¢∞ÊíûÊó∂Èó¥
                    ball.lastCollision = currentTime;

                    // Èò≤Ê≠¢ÁêÉÂç°Âú®Êå°ÊùøÂÜÖ
                    if (direction === 1) {
                        ball.x = paddle.x + paddle.width + ball.radius + 1;
                    } else {
                        ball.x = paddle.x - ball.radius - 1;
                    }
                }
            }

            // ËÆ°ÂàÜ
            if (!isResetting && (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width)) {
                isResetting = true;
                let shouldScore = true;
                let scoringPlayer = null;

                if (ball.x - ball.radius < 0) {
                    scoringPlayer = 'computer';
                } else {
                    scoringPlayer = 'player';
                }

                // Ê£ÄÊü•‰∏çÊ≠ªÂõæËÖæÊïàÊûú
                if (globalEffects.immortalTotem.active) {
                    const triggeredBy = globalEffects.immortalTotem.triggeredBy;

                    // Â¶ÇÊûúËß¶ÂèëÊñπÂ§±ÁêÉÔºå‰∏çËÆ°ÂàÜ‰ΩÜÁªìÊùü‰∏çÊ≠ªÂõæËÖæÊïàÊûú
                    if ((scoringPlayer === 'computer' && triggeredBy === 'player') ||
                        (scoringPlayer === 'player' && triggeredBy === 'computer')) {
                        shouldScore = false;

                        // ÁªìÊùü‰∏çÊ≠ªÂõæËÖæÊïàÊûú
                        globalEffects.immortalTotem.active = false;
                        globalEffects.immortalTotem.endTime = 0;
                        globalEffects.immortalTotem.triggeredBy = null;

                        // ÁªìÊùüËß¶ÂèëÊñπÁöÑRGBÂèòËâ≤ÊïàÊûú
                        if (triggeredBy === 'player') {
                            player.rgbEffect = false; // ‰ΩøÁî®rgbEffect
                            player.rgbEndTime = 0;
                        } else {
                            computer.rgbEffect = false; // ‰ΩøÁî®rgbEffect
                            computer.rgbEndTime = 0;
                        }

                        // ÊòæÁ§∫‰∏çÊ≠ªÂõæËÖæËß¶ÂèëÈÄöÁü•
                        const notification = document.createElement('div');
                        notification.className = 'event-notification positive';
                        notification.innerHTML = `
                            <div class="event-trigger">‰∏çÊ≠ªÂõæËÖæËß¶Âèë</div>
                            <div class="event-title">ÊòØ‰∏çÊ≠ªÂõæËÖæÁ¢éË£ÇÁöÑÂ£∞Èü≥ÔºÅ</div>
                            <div class="event-description">Êú¨Ê¨°Â§±ÁêÉ‰∏çËÆ°ÂàÜÔºåÊïàÊûúÂ∑≤ÁªìÊùü</div>
                        `;
                        document.body.appendChild(notification);
                        setTimeout(() => {
                            notification.classList.add('show');
                        }, 100);
                        setTimeout(() => {
                            notification.classList.remove('show');
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            }, 500);
                        }, 3000);
                    }
                }

                // Ê≠£Â∏∏ËÆ°ÂàÜ
                if (shouldScore) {
                    if (scoringPlayer === 'computer') {
                        computerScore++;
                        computerScoreElement.textContent = computerScore;
                        createScoreEffect(false); // ÁîµËÑëÂæóÂàÜÁâπÊïà
                    } else {
                        playerScore++;
                        playerScoreElement.textContent = playerScore;
                        createScoreEffect(true); // Áé©ÂÆ∂ÂæóÂàÜÁâπÊïà
                    }
                }

                // ÈáçÁΩÆÁîµËÑëÈÄüÂ∫¶ÂÄçÊï∞ÔºàËøõÁêÉÂêéÈáçÁΩÆÔºâ
                computer.speedMultiplier = 1.0;

                // ÂàõÂª∫ÂæóÂàÜÁ≤íÂ≠êÊïàÊûú
                createParticles(
                    ball.x,
                    ball.y,
                    ball.x - ball.radius < 0 ? computer.color : player.color,
                    30
                );

                // Âª∂ËøüÂêéÈáçÁΩÆÁêÉ
                setTimeout(() => {
                    resetBall();
                }, 1000);
            }

            // Ê£ÄÊü•ËÉúÂà©Êù°‰ª∂
            if (!isGameOver && (playerScore >= 3 || computerScore >= 3)) {
                isGameOver = true;
                if (playerScore >= 3) {
                    victoryMessage.textContent = `Áé©ÂÆ∂Ëé∑ËÉúÔºÅ`;
                } else {
                    // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÈöæÂ∫¶ÂêçÁß∞
                    const activeOption = document.querySelector('.difficulty-option.active');
                    const difficultyName = activeOption ? activeOption.textContent : 'ÁîµËÑë';
                    victoryMessage.textContent = `${difficultyName}Ëé∑ËÉúÔºÅ`;
                }
                victoryOverlay.style.opacity = '1';
                victoryOverlay.style.pointerEvents = 'auto';
            }

            // Êõ¥Êñ∞Ë∞ÉËØï‰ø°ÊÅØ
            updateDebugInfo();
        }

        // ÁªòÂà∂Ê∏∏Êàè
        function draw() {
            // ÂçäÈÄèÊòéËÉåÊôØÔºàÂàõÈÄ†ÊãñÂ∞æÊïàÊûúÔºâ
            ctx.fillStyle = 'rgba(8, 12, 33, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂ÁΩëÊ†ºËÉåÊôØ
            drawGrid();

            // ÁªòÂà∂Èõ∑‰∫ëÊïàÊûú
            drawThunderCloud();

            // ÁªòÂà∂ÈöúÁ¢çÁâ©
            drawObstacles();

            // ÁªòÂà∂‰∫ã‰ª∂
            drawEvents();

            // ÁªòÂà∂ÁêÉËΩ®Ëøπ
            drawBallTrail();

            // ÁªòÂà∂Á≤íÂ≠ê
            drawParticles();

            // ÁªòÂà∂‰∏≠Èó¥ËôöÁ∫ø
            ctx.beginPath();
            ctx.setLineDash([10, 15]);
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.strokeStyle = 'rgba(101, 80, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);

            // ÁªòÂà∂Êå°Êùø
            drawPaddle(player.x, player.y, player.width, player.height, player.color, player.glowEffect, player.rgbEffect);
            drawPaddle(computer.x, computer.y, computer.width, computer.height, computer.color, computer.glowEffect, computer.rgbEffect);


            // ÁªòÂà∂ÁêÉ
            drawCircle(ball.x, ball.y, ball.radius, ball.color, ball.alpha);

            // ÁªòÂà∂ÁêÉÂÜÖÈÉ®ÂÖâÁÇπ
            ctx.save();
            ctx.globalAlpha = ball.alpha;
            ctx.beginPath();
            ctx.arc(ball.x - 3, ball.y - 3, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.closePath();
            ctx.restore();
        }

        // Êõ¥Êñ∞Ë∞ÉËØï‰ø°ÊÅØ
        function updateDebugInfo() {
            // ÁêÉÁä∂ÊÄÅ
            document.getElementById('debug-ball-speed').textContent = ball.speed.toFixed(2);
            document.getElementById('debug-ball-position').textContent = `${Math.round(ball.x)},${Math.round(ball.y)}`;
            document.getElementById('debug-ball-alpha').textContent = ball.alpha.toFixed(2);

            // ÁîµËÑëÊï∞ÊçÆ
            document.getElementById('debug-computer-speed').textContent = computer.speed.toFixed(2);
            document.getElementById('debug-computer-position').textContent = Math.round(computer.y);
            document.getElementById('debug-computer-multiplier').textContent = computer.speedMultiplier.toFixed(2);

            // ‰∫ã‰ª∂Áä∂ÊÄÅ
            let activeEvents = 0;
            if (globalEffects.speedVariation.active) activeEvents++;
            if (globalEffects.obstacleSpeedUp.active) activeEvents++;
            if (globalEffects.thunderCloud.active) activeEvents++;
            if (player.glowEffect) activeEvents++;
            if (computer.speedMultiplier !== 1.0) activeEvents++;
            
            document.getElementById('debug-active-events').textContent = activeEvents;
            document.getElementById('debug-obstacles').textContent = obstacles.length;

            // Á≥ªÁªü‰ø°ÊÅØ
            const currentFps = Math.round(1000 / (deltaTime || 16.67));
            document.getElementById('debug-fps').textContent = currentFps;
            document.getElementById('debug-game-time').textContent = `${Math.round(gameTime / 1000)}s`;
        }

        // Ê∏∏ÊàèÂæ™ÁéØ
        function gameLoop(timestamp) {
            // ËÆ°ÁÆóÊó∂Èó¥Â∑Æ
            if (lastTime === 0) lastTime = timestamp;
            deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            accumulatedTime += deltaTime;
            
            // ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñÔºöÈôç‰ΩéÂ∏ßÁéá
            const targetFPS = isMobileDevice() ? 60 : 120;
            const targetFrameInterval = 1000 / targetFPS;
            
            // Êõ¥Êñ∞FPSËÆ°Êï∞
            frameCount++;
            if (timestamp - lastFpsUpdate >= 1000) {
                const fps = Math.round(frameCount * 1000 / (timestamp - lastFpsUpdate));
                console.log(`FPS: ${fps}`);
                frameCount = 0;
                lastFpsUpdate = timestamp;
            }
            
            // ÊâßË°åÂõ∫ÂÆöÊ¨°Êï∞ÁöÑÊõ¥Êñ∞ÔºàÊó∂Èó¥Ë°•ÂÅøÔºâ
            while (accumulatedTime >= targetFrameInterval) {
                update(targetFrameInterval);
                accumulatedTime -= targetFrameInterval;
            }
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ÂêØÂä®Ê∏∏Êàè
        lastTime = 0;
        accumulatedTime = 0;
        requestAnimationFrame(gameLoop);

        // ====== ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅ ======
        canvas.addEventListener('touchstart', handleTouch, {passive: false});
        canvas.addEventListener('touchmove', handleTouch, {passive: false});
        function handleTouch(e) {
            if (isGameOver || isPaused) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientY;
            if (e.touches && e.touches.length > 0) {
                clientY = e.touches[0].clientY;
            } else {
                clientY = e.clientY;
            }
            player.y = clientY - rect.top - player.height / 2;
            // ÈôêÂà∂Êå°Êùø‰∏çÂá∫Áïå
            if (player.y < 0) player.y = 0;
            if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;
        }

        // ====== canvasËá™ÈÄÇÂ∫îÂ±èÂπï ======
        function resizeCanvas() {
            let w, h;
            
            if (isMobileDevice()) {
                // ÁßªÂä®Á´ØÔºö‰ΩøÁî®Â±èÂπïÂÆΩÂ∫¶ÁöÑ95%ÔºåÈ´òÂ∫¶‰∏∫Â±èÂπïÈ´òÂ∫¶ÁöÑ50%
                w = window.innerWidth * 0.95;
                h = window.innerHeight * 0.5;
                // ÈôêÂà∂ÊúÄÂ§ßÂ∞∫ÂØ∏
                if (w > 600) w = 600;
                if (h > 400) h = 400;
            } else {
                // Ê°åÈù¢Á´ØÔºö‰ΩøÁî®ÂéüÊù•ÁöÑÈÄªËæë
                w = window.innerWidth * 0.98;
                h = window.innerHeight * 0.6;
                if (w > 900) w = 900;
                if (h > 600) h = 500;
            }
            
            canvas.width = w;
            canvas.height = h;
            
            // ÈáçÊñ∞ËÆæÁΩÆÊå°Êùø‰ΩçÁΩÆ
            player.x = 20;
            player.y = canvas.height / 2 - player.height / 2;
            computer.x = canvas.width - 35;
            computer.y = canvas.height / 2 - computer.height / 2;
            
            // ÈáçÊñ∞ËÆæÁΩÆÁêÉÁöÑ‰ΩçÁΩÆ
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            
            // ÈôêÂà∂Êå°Êùø‰∏çÂá∫Áïå
            if (player.y < 0) player.y = 0;
            if (player.y + player.height > canvas.height) player.y = canvas.height - player.height;
            if (computer.y < 0) computer.y = 0;
            if (computer.y + computer.height > canvas.height) computer.y = canvas.height - computer.height;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ====== ÁßªÂä®Á´ØËôöÊãüÊåâÈíÆÊîØÊåÅ ======
        const mobileControls = document.getElementById('mobile-controls');
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');

        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // ÊòæÁ§∫/ÈöêËóèÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆ
        function toggleMobileControls() {
            if (isMobileDevice()) {
                mobileControls.style.display = 'flex';
            } else {
                mobileControls.style.display = 'none';
            }
        }

        // ËôöÊãüÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
        let moveInterval = null;
        const moveSpeed = 12; // Â∞ÜÁßªÂä®ÈÄüÂ∫¶‰ªé5Êîπ‰∏∫12ÔºåËÆ©ÁßªÂä®Êõ¥Âø´Êõ¥ÊµÅÁïÖ

        function startMove(direction) {
            if (moveInterval) return;
            moveInterval = setInterval(() => {
                if (isGameOver || isPaused) return;
                if (direction === 'up') {
                    player.y -= moveSpeed;
                    if (player.y < 0) player.y = 0;
                } else {
                    player.y += moveSpeed;
                    if (player.y + player.height > canvas.height) {
                        player.y = canvas.height - player.height;
                    }
                }
            }, 16); // Á∫¶60fps
        }

        function stopMove() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        }

        // Ëß¶Êë∏‰∫ã‰ª∂
        btnUp.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startMove('up');
        });

        btnUp.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopMove();
        });

        btnDown.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startMove('down');
        });

        btnDown.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopMove();
        });

        // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢ÊµãËØïÔºâ
        btnUp.addEventListener('mousedown', () => {
            startMove('up');
        });

        btnUp.addEventListener('mouseup', () => {
            stopMove();
        });

        btnDown.addEventListener('mousedown', () => {
            startMove('down');
        });

        btnDown.addEventListener('mouseup', () => {
            stopMove();
        });

        // ÂàùÂßãÂåñÁßªÂä®Á´ØÊéßÂà∂
        toggleMobileControls();
        window.addEventListener('resize', toggleMobileControls);

        // Êõ¥Êñ∞ÊéßÂà∂ËØ¥ÊòéÊñáÂ≠ó
        function updateControlsInfo() {
            const controlsInfo = document.querySelector('.controls-info');
            if (isMobileDevice()) {
                controlsInfo.textContent = '‰ΩøÁî®Â±èÂπïÂ∑¶‰æßÊåâÈíÆÊàñËß¶Êë∏Â±èÂπïÊéßÂà∂Êå°Êùø | È¶ñÂÖàËé∑Âæó3ÂàÜËÄÖËé∑ËÉú | Êî∂ÈõÜ‰∫ã‰ª∂Ëé∑ÂæóÁâπÊÆäÊïàÊûúÔºÅ';
            } else {
                controlsInfo.textContent = '‰ΩøÁî®Èº†Ê†áÁßªÂä®ÊéßÂà∂‰Ω†ÁöÑÊå°Êùø | È¶ñÂÖàËé∑Âæó3ÂàÜËÄÖËé∑ËÉú | Êî∂ÈõÜ‰∫ã‰ª∂Ëé∑ÂæóÁâπÊÆäÊïàÊûúÔºÅ';
            }
        }
        updateControlsInfo();
    </script>
</body>
</html>
